!function(e){"use strict";function t(e,t){return e===t||e!=e&&t!=t}function n(e){for(var t in e)return!1;return!0}function i(e){console.error(e===Object(e)&&e.stack||e)}var r,a=Function("return this;")(),s=Object.prototype.hasOwnProperty,o=Array.prototype.slice;r="undefined"!=typeof exports?exports:a.Rift=a.rt={},r.global=a;var l=r.isServer="undefined"==typeof window&&"undefined"==typeof navigator,u=r.isClient=!l;r.logError=i;var h;u&&(h=r.$=a.jQuery||a.Zepto||a.ender||a.$);var c="_rt-listenerInner";Object.getOwnPropertySymbols||(Object.getOwnPropertySymbols=function(e){return[]}),Object.assign||Object.defineProperty(Object,"assign",{configurable:!0,writable:!0,value:function(e,t){if(null==e)throw new TypeError("Can't convert "+e+" to an object");e=Object(e);for(var n=1,i=arguments.length;i>n;n++){var r=arguments[n];if(null==r)throw new TypeError("Can't convert "+r+" to an object");r=Object(r);for(var a=Object.keys(r),s=0,o=a.length;o>s;s++)e[a[s]]=r[a[s]];for(var l=Object.getOwnPropertySymbols(r),s=0,o=l.length;o>s;s++)e[l[s]]=r[l[s]]}return e}}),function(){function e(e){return 2176782335==t&&(t=0),(e||"")+(++t).toString(36)}var t=0;r.uid={next:e}}(),function(){function e(e,t,n){for(var i=n?Object.keys(t):Object.getOwnPropertyNames(t),r=i.length;r;)Object.defineProperty(e,i[--r],Object.getOwnPropertyDescriptor(t,i[r]));return e}function t(t){return e(Object.create(Object.getPrototypeOf(t)),t)}var n,i=r.uid.next;if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){var a=Symbol("uid");n=function(e,t){return e[a]||(e[a]=i(t))}}else{var o="_rt-uid";n=function(e,t){return s.call(e,o)||Object.defineProperty(e,o,{value:i(t)}),e[o]}}r.object={getUID:n,mixin:e,clone:t}}(),function(){function e(e,t){"string"==typeof e&&(e=e.split("."));for(var n=t||a,i=0,r=e.length;r>i;i++){var s=n[e[i]];if(s!==Object(s)){do n=n[e[i]]={};while(++i<r);break}n=s}return n}function t(e,t){return Function("return this."+e+";").call(t||a)}r.namespace={create:e,exec:t}}(),function(){function e(e){return e.replace(n,"\\$1")}function t(e,t,n){if(e.global){e.lastIndex=0;for(var i;(i=e.exec(t))&&n.apply(a,i)!==!1;);}else{var i=e.exec(t);i&&n.apply(a,i)}}var n=/([?+|$(){}[^.\-\]\/\\*])/g;r.regex={escape:e,forEach:t}}(),function(){function t(e){switch(typeof e){case"undefined":return"undefined";case"object":if(null===e)return"null";break;case"boolean":return"?"+e;case"number":return"+"+e;case"string":return","+e}return"#"+a(e)}function n(e){return e.replace(o,function(e){return l[e]||"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})}function i(t){if(t===e)return"void 0";if(null===t)return"null";var r=typeof t;if("object"==r){var a=[];if(Array.isArray(t)){for(var o=t.length;o;)a.unshift(--o in t?i(t[o]):"");a="["+a.join(",")+(""==a[a.length-1]?",]":"]")}else{for(var l in t)s.call(t,l)&&a.push((u.test(l)?l:"'"+n(l)+"'")+":"+i(t[l]));a="{"+a+"}"}return a.replace(c,"</'+'$1>")}if("number"==r){if(t&&t%1e3==0)return String(t).replace(h,function(e){return"e"+e.length})}else if("string"==r)return"'"+n(t).replace(c,"</'+'$1>")+"'";return String(t)}var a=r.object.getUID,o=RegExp("[\\\\'\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]","g"),l=Object.assign(Object.create(null),{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"}),u=/^[$_a-zA-Z][$\w]*$/,h=/0+$/,c=/<\/(script\b[^>]*)>/gi;r.value={getHash:t,stringify:i}}(),function(){var e;if(a.process&&a.process.nextTick)e=a.process.nextTick;else if(a.setImmediate)e=function(e){setImmediate(e)};else if(a.Promise){var t=Promise.resolve();e=function(e){t.then(function(){e()})}}else if(a.postMessage&&!a.ActiveXObject){var n;a.addEventListener("message",function(){if(n){var e=n;n=null;for(var t=0,i=e.length;i>t;t++)try{e[t]()}catch(a){r.logError(a)}}},!1),e=function(e){n?n.push(e):(n=[e],a.postMessage("__tic__","*"))}}else e=function(e){setTimeout(e,1)};r.process={nextTick:e}}(),function(){function t(e){if(!(e in l))throw new TypeError('Class "'+e+'" is not defined');return l[e]}function n(e,t){if(e in l)throw new TypeError('Class "'+e+'" is already registered');return Object.defineProperty(t,"__class",{value:e}),l[e]=t,t}function i(t,r){"object"==typeof t&&(r=t,t=e);var l,u=this==a?Object:this;s.call(r,"constructor")?(l=r.constructor,delete r.constructor):l=u==Object?function(){}:function(){return u.apply(this,arguments)};var h=Object.create(u.prototype);return l.prototype=h,Object.defineProperty(l,"$super",{writable:!0,value:u.prototype}),Object.defineProperty(h,"constructor",{configurable:!0,writable:!0,value:l}),o(l,u,!0),s.call(r,"static")&&(o(l,r["static"]),delete r["static"]),l.extend===e&&(l.extend=i),o(h,r),t&&n(t,l),l}var a,o=r.object.mixin,l=Object.create(null);a={classes:l,getOrError:t,register:n,extend:i},r.Class=a}(),function(){function t(i,r){var a=s(i);if(r.hasOwnProperty(a))return a;var o={},l={};if(i.constructor.hasOwnProperty("__class")?(i.collectDumpObject?i.collectDumpObject(o,l):Object.assign(o,i),r[a]={c:i.constructor.__class}):(Object.assign(o,i),r[a]={}),!n(o)){for(var u in o){var h=o[u];o[u]=h===Object(h)?t(h,r):h===e?{}:{v:h}}r[a].d=o}return n(l)||(r[a].o=l),a}function i(e){var n={};return o({s:n,r:t(e,n)})}function a(t){"string"==typeof t&&(t=Function("return "+t+";")());var n=t.s;for(var i in n){var r=n[i];if(r.hasOwnProperty("c")){var a=l[r.c];r.instance=r.hasOwnProperty("o")?new a(e,r.o):new a}else r.instance={}}for(var i in n){var r=n[i];if(r.hasOwnProperty("d")){var s=r.d;for(var o in s){var u=s[o];s[o]="object"==typeof u?u.hasOwnProperty("v")?u.v:e:n[u].instance}r.hasOwnProperty("c")&&r.instance.expandFromDumpObject?r.instance.expandFromDumpObject(s):Object.assign(r.instance,s)}}return n[t.r].instance}var s=r.object.getUID,o=r.value.stringify,l=r.Class.classes,u=r.Class.register;u("Array",Array),u("Date",Date),Object.defineProperties(Date.prototype,{collectDumpObject:{configurable:!0,writable:!0,value:function(e){e.utc=this.toString()}},expandFromDumpObject:{configurable:!0,writable:!0,value:function(e){this.setTime(new Date(e.utc))}}}),r.dump={serialize:i,deserialize:a}}(),function(){var t=a.Map;if(!t||-1==t.toString().indexOf("[native code]")){var n=r.value.getHash,i={key:e,value:e,prev:null,next:null};t=function(e){if(this._inner=Object.create(null),e)for(var t=0,n=e.length;n>t;t++)this.set(e[t][0],e[t][1])},r.object.mixin(t.prototype,{_inner:null,_first:null,_last:null,_size:0,get size(){return this._size},has:function(e){return n(e)in this._inner},get:function(e){return(this._inner[n(e)]||i).value},set:function(e,t){var i=n(e);if(i in this._inner)this._inner[i].value=t;else{var r=this._inner[i]={key:e,value:t,prev:this._last,next:null};this._size++?this._last.next=r:this._first=r,this._last=r}return this},"delete":function(e){var t=this._inner,i=n(e);if(!(i in t))return!1;if(--this._size){var r=t[i].prev,a=t[i].next;r?r.next=a:this._first=a,a?a.prev=r:this._last=r}else this._first=null,this._last=null;return delete t[i],!0},forEach:function(e,t){null==t&&(t=a);for(var n=this._first;n;)e.call(t,n.value,n.key,this),n=n.next},keys:function(){var t=this._first;return{next:function(){if(t){var n={value:t.key,done:!1};return t=t.next,n}return{value:e,done:!0}}}},values:function(){var t=this._first;return{next:function(){if(t){var n={value:t.value,done:!1};return t=t.next,n}return{value:e,done:!0}}}},entries:function(){var t=this._first;return{next:function(){if(t){var n={value:[t.key,t.value],done:!1};return t=t.next,n}return{value:e,done:!0}}}},clear:function(){var e=this._inner;for(var t in e)delete e[t];this._first=null,this._last=null,this._size=0}})}r.Map=t}(),function(){var e=a.Set;if(!e||-1==e.toString().indexOf("[native code]")){var t=r.Map;e=function(e){if(this._inner=new t,e)for(var n=0,i=e.length;i>n;n++)this.add(e[n])},r.object.mixin(e.prototype,{_inner:null,get size(){return this._inner.size},has:function(e){return this._inner.has(e)},add:function(e){return this._inner.set(e,e),this},"delete":function(e){return this._inner["delete"](e)},forEach:function(e,t){null==t&&(t=a),this._inner.forEach(function(n){e.call(t,n,n,this)},this)},keys:function(){return this._inner.keys()},values:function(){return this._inner.values()},entries:function(){return this._inner.entries()},clear:function(){this._inner.clear()}})}r.Set=e}(),function(){var t=r.Class.extend({target:null,type:e,timestamp:e,detail:null,bubbles:!0,isPropagationStopped:!1,isImmediatePropagationStopped:!1,constructor:function(e,t){this.type=e,t&&(this.bubbles=!0)},stopPropagation:function(){this.isPropagationStopped=!0},stopImmediatePropagation:function(){this.isPropagationStopped=!0,this.isImmediatePropagationStopped=!0}});r.Event=t}(),function(){function e(e){return function t(n,i,r){if("object"==typeof n){r=i;var a=n;for(n in a)t.call(this,n,a[n],r)}else e.call(this,n,i,r);return this}}var t=r.Map,n=r.Event,i="_emt-used",a=r.Class.extend({_events:null,parent:null,silent:!1,on:e(function(e,n,i){var r=(this._events||(this._events=new t)).get(e);r||(r=[],this._events.set(e,r)),r.push({listener:n,context:i||this})}),off:e(function(e,n,i){var r=this._events||(this._events=new t).get(e);if(r){i||(i=this);for(var a=r.length;a;){var s=r[--a];s.context==i&&(s.listener==n||s.listener.hasOwnProperty(c)&&s.listener[c]==n)&&r.splice(a,1)}r.length||this._events["delete"](e)}}),once:function(e,t,n){function i(){this.off(e,i),t.apply(this,arguments)}return i[c]=t,this.on(e,i,n)},emit:function(e,t){if("string"==typeof e)e=new n(e);else if(e.hasOwnProperty(i))throw new TypeError("Attempt to use an object that is no longer usable");return e[i]=!0,e.target=this,e.timestamp=Date.now(),t&&(e.detail=t),this._handleEvent(e),e},_handleEvent:function(e){if(!this.silent||e.target!=this){var t=e.type,n=(this._events&&this._events.get(t)||[]).slice(0);"function"==typeof this["on"+t]&&n.push({listener:this["on"+t],context:this});for(var i=0,r=n.length;r>i&&!e.isImmediatePropagationStopped;i++)try{n[i].listener.call(n[i].context,e)===!1&&(e.isPropagationStopped=!0)}catch(a){this._logError(a)}}this.parent&&e.bubbles&&!e.isPropagationStopped&&this.parent._handleEvent(e)},_logError:function(e){r.logError(e)}});r.EventEmitter=a}(),function(){var n=r.Map,i=r.Set,a=r.EventEmitter,s=a.extend("Rift.ActiveDictionary",{_inner:null,_valueCounts:null,_handleItemChanges:!1,constructor:function(e,t){if(a.call(this),this._inner=new n,this._valueCounts=new n,"boolean"==typeof t?t={handleItemChanges:t}:t||(t={}),t.handleItemChanges&&(this._handleItemChanges=!0),e){e instanceof s&&(e=e._inner);var i=this._inner,r=this._valueCounts,o=this._handleItemChanges;for(var l in e){var u=e[l];i.set(l,u),r.has(u)?r.set(u,r.get(u)+1):(r.set(u,1),o&&u instanceof a&&u.on("change",this._onItemChange,this))}}},_onItemChange:function(e){this._handleEvent(e)},has:function(e){return this._inner.has(e)},get:function(e){return this._inner.get(e)},set:function(e,n){var r;"string"==typeof e?(r={},r[e]=n):r=e;var s=this._inner,o=this._valueCounts,l=this._handleItemChanges,u=!1,h=new i,c=[],f=[],p={$removedValues:c,$addedValues:f};for(e in r){var d=s.has(e),v=s.get(e),g=r[e];if(!d||!t(v,g)){if(u=!0,d){var _=o.get(v)-1;_?o.set(v,_):(o["delete"](v),l&&v instanceof a&&v.off("change",this._onItemChange),h.add(v))}o.has(g)?o.set(g,o.get(g)+1):(o.set(g,1),l&&g instanceof a&&g.on("change",this._onItemChange,this),h["delete"](g)||f.push(g)),p[e]={type:d?"update":"add",oldValue:v,value:g},s.set(e,g)}}return u&&(h.forEach(function(e){c.push(e)}),this.emit("change",{diff:p})),this},"delete":function(){for(var t=this._inner,n=this._valueCounts,i=this._handleItemChanges,r=!1,s=[],o={$removedValues:s,$addedValues:[]},l=0,u=arguments.length;u>l;l++){var h=arguments[l];if(t.has(h)){r=!0;var c=t.get(h),f=n.get(c)-1;f?n.set(c,f):(n["delete"](c),i&&c instanceof a&&c.off("change",this._onItemChange),s.push(c)),o[h]={type:"delete",oldValue:c,value:e},t["delete"](h)}}return r&&this.emit("change",{diff:o}),this},contains:function(e){return this._valueCounts.has(e)},clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toObject:function(){var e={};return this._inner.forEach(function(t,n){e[n]=t}),e},collectDumpObject:function(e,t){this._inner.forEach(function(t,n){e[n]=t}),this._handleItemChanges&&(t.handleItemChanges=!0)},expandFromDumpObject:function(e){this.set(e)},dispose:function(){if(this._handleItemChanges){var e=this._onItemChange;this._valueCounts.forEach(function(t){t instanceof a&&t.off("change",e)})}}});r.ActiveDictionary=s}(),function(){function e(e,t){for(var n=e._valueCounts,i=e._handleItemChanges,r=[],a=0,o=t.length;o>a;a++){var l=t[a];n.has(l)?n.set(l,n.get(l)+1):(n.set(l,1),i&&l instanceof s&&l.on("change",e._onItemChange,e),r.push(l))}return r}function n(e,t){var n=e._valueCounts.get(t)-1;return n?(e._valueCounts.set(t,n),[]):(e._valueCounts["delete"](t),e._handleItemChanges&&t instanceof s&&t.off("change",e._onItemChange),[t])}var i=r.Map,a=r.Set,s=r.EventEmitter,o=Array.prototype,l=o.push,u=o.unshift,h=o.concat,c=o.slice,f=o.splice,p=o.map,d=o.reduce,v=s.extend("Rift.ActiveArray",{_inner:null,_valueCounts:null,_handleItemChanges:!1,constructor:function(e,t){if(s.call(this),this._valueCounts=new i,"boolean"==typeof t?t={handleItemChanges:t}:t||(t={}),t.handleItemChanges&&(this._handleItemChanges=!0),e){for(var n=this._inner=(e instanceof v?e._inner:e).slice(0),r=this._valueCounts,a=this._handleItemChanges,o=n.length;o;)if(--o in n){var l=n[o];r.has(l)?r.set(l,r.get(l)+1):(r.set(l,1),a&&l instanceof s&&l.on("change",this._onItemChange,this))}}else this._inner=[]},_onItemChange:function(e){this._handleEvent(e)},get:function(e){return this._inner[e]},set:function(e,n){var i=this._inner,r=e in i,a=i[e];if(!r||!t(a,n)){var o,l,u=this._valueCounts;if(r){var h=u.get(a)-1;h?u.set(a,h):(u["delete"](a),this._handleItemChanges&&a instanceof s&&a.off("change",this._onItemChange),o=[a])}u.has(n)?u.set(n,u.get(n)+1):(u.set(n,1),this._handleItemChanges&&n instanceof s&&n.on("change",this._onItemChange,this),l=[n]),i[e]=n,this.emit("change",{diff:{$removedValues:o||[],$addedValues:l||[]}})}return this},"delete":function(){for(var e=this._inner,t=this._valueCounts,n=this._handleItemChanges,i=!1,r=[],a=0,o=arguments.length;o>a;a++){var l=arguments[a];if(l in e){i=!0;var u=e[l],h=t.get(u)-1;h?t.set(u,h):(t["delete"](u),n&&u instanceof s&&u.off("change",this._onItemChange),r.push(u)),delete e[l]}}return i&&this.emit("change",{diff:{$removedValues:r,$addedValues:[]}}),this},get length(){return this._inner.length},set length(e){var t=this._inner,n=t.length;if(n!=e){var i=!1,r=[];if(n>e){var a=this._valueCounts,o=this._handleItemChanges,l=e;do if(l in t){i=!0;var u=t[l],h=a.get(u)-1;h?a.set(u,h):(a["delete"](u),o&&u instanceof s&&u.off("change",this._onItemChange),r.push(u))}while(++l<n)}t.length=e,i&&this.emit("change",{diff:{$removedValues:r,$addedValues:[]}})}},contains:function(e){return this._valueCounts.has(e)},indexOf:function(e,t){return this._inner.indexOf(e,t)},lastIndexOf:function(e,t){return this._inner.lastIndexOf(e,t)},push:function(){return arguments.length?(l.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:e(this,arguments)}}),this._inner.length):this._inner.length},pushUnique:function(){var e=this._valueCounts;return this.push.apply(this,d.call(arguments,function(t,n){return e.has(n)||-1!=t.indexOf(n)||t.push(n),t},[]))},shift:function(){var e=this._inner;if(e.length){if(!this._valueCounts.size)return void e.length--;var t,i="0"in e;return i?t=e.shift():e.shift(),this.emit("change",{diff:{$removedValues:i?n(this,t):[],$addedValues:[]}}),t}},unshift:function(){return arguments.length?(u.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:e(this,arguments)}}),this._inner.length):this._inner.length},pop:function(){var e=this._inner;if(e.length){if(!(e.length-1 in e))return void e.length--;var t=e.pop();return this.emit("change",{diff:{$removedValues:n(this,t),$addedValues:[]}}),t}},join:function(e){return this._inner.join(e)},concat:function(){return new this.constructor(h.apply(this._inner,p.call(arguments,function(e){return e instanceof v?e._inner:e})))},slice:function(e,t){return this._inner.slice(e,t)},splice:function(e,n){var i=this._inner,r=f.apply(i,arguments),o=c.call(arguments,2),l=r.length,u=o.length;if(!l&&!u)return r;for(var h=this._valueCounts,p=this._handleItemChanges,d=!1,v=new a,g=[],_=0,m=Math.max(l,u);m>_;_++){var b=_ in r,y=_ in o;if(b||y){var w=r[_],C=o[_];if(!b||!y||!t(w,C)){if(d=!0,b){var x=h.get(w)-1;x?h.set(w,x):(h["delete"](w),p&&w instanceof s&&w.off("change",this._onItemChange),v.add(w))}y&&(h.has(C)?h.set(C,h.get(C)+1):(h.set(C,1),p&&C instanceof s&&C.on("change",this._onItemChange,this),v["delete"](C)||g.push(C)))}}}if(!d&&l>u)for(var _=e+u,m=i.length;m>_;_++)if(_ in i){d=!0;break}if(d){var O=[];v.forEach(function(e){O.push(e)}),this.emit("change",{diff:{$removedValues:O,$addedValues:g}})}return r},forEach:null,map:null,filter:null,every:null,some:null,reduce:null,reduceRight:null,clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toArray:function(){return this._inner.slice(0)},toString:function(){return this._inner.toString()},collectDumpObject:function(e,t){for(var n=this._inner,i=n.length;i;)--i in n&&(e[i]=n[i]);this._handleItemChanges&&(t.handleItemChanges=!0)},expandFromDumpObject:function(e){for(var t in e)this.set(t,e[t])},dispose:function(){if(this._handleItemChanges){var e=this._onItemChange;this._valueCounts.forEach(function(t){t instanceof s&&t.off("change",e)})}}});["forEach","map","filter","every","some","reduce","reduceRight"].forEach(function(e){this[e]=function(){return o[e].apply(this._inner,arguments)}},v.prototype),r.ActiveArray=v}(),function(){function i(e){var t=y.last,n=e._maxParentDepth;if(t)for(;;){if(n==t.maxParentDepth)return t.dataCells.has(e)?!1:(t.dataCells.add(e),t.count++,!0);if(n>t.maxParentDepth){var i=t.next;return t.next=(i||y)[i?"prev":"last"]=y[n]={maxParentDepth:n,dataCells:new c([e]),count:1,prev:t,next:i},!0}if(!t.prev)return t.prev=y.first=y[n]={maxParentDepth:n,dataCells:new c([e]),count:1,prev:null,next:t},!0;t=t.prev}return y.first=y.last=y[n]={maxParentDepth:n,dataCells:new c([e]),count:1,prev:null,next:null},!0}function a(e){var t=y[e._maxParentDepth];if(t&&t.dataCells.has(e)){if(--t.count)delete t.dataCells["delete"](e);else{var n=t.prev,i=t.next;n?n.next=i:y.first=i,i?i.prev=n:y.last=n,delete y[e._maxParentDepth]}return!0}return!1}function s(){_=v;do for(var e,t=m.values();!(e=t.next()).done;){for(var n,r=e.value,a=r.dataCell,s=a._children.values();!(n=s.next()).done;)i(n.value);if(m["delete"](a),b--,a._fixedValue=a._value,a._changed=!0,a._handleEvent(r.event),_!=v)return}while(b)}function o(){if(_==d){if(!b)return;if(s(),_!=v)return}else if(_==v){if(b&&(s(),_!=v))return}else if(s(),_!=v)return;_=g;for(var e;e=y.first;)for(var t,n=e.dataCells,i=n.values();!(t=i.next()).done;){var r=t.value;if(r._recalc(),_!=g)return;if(--e.count)delete n["delete"](r);else{var a=e.prev,o=e.next;a?a.next=o:y.first=o,o?o.prev=a:y.last=a,delete y[r._maxParentDepth]}if(b){if(s(),_!=v)return;_=g;break}}_=d,w.clear()}function l(e,t,n,i){if(n||(n=new f("change"),n.target=e,n.timestamp=Date.now(),t&&(n.detail={diff:t})),b){if(m.has(e)){var r=m.get(e);return(n.detail||(n.detail={})).prevEvent=r.event,r.event=n,void(i===!1&&(r.cancellable=!1))}}else _==d&&u(o);m.set(e,{dataCell:e,event:n,cancellable:i!==!1}),b++}var u=r.process.nextTick,h=r.Map,c=r.Set,f=r.Event,p=r.EventEmitter,d=0,v=1,g=2,_=d,m=new h,b=0,y=Object.assign(Object.create(null),{first:null,last:null}),w=new h,C=[],x=p.extend({initialValue:e,_value:e,_fixedValue:e,_formula:null,_get:null,_set:null,owner:null,_parents:null,_children:null,_maxParentDepth:0,_lastErrorEvent:null,computable:!1,_changed:!1,get changed(){return b&&o(),this._changed},disposed:!1,_onChange:null,get onchange(){return this._onChange},set onchange(e){b&&o(),this._onChange=e},_onError:null,get onerror(){return this._onError},set onerror(e){b&&o(),this._onError=e},constructor:function(t,n){if(p.call(this),n||(n={}),n.get&&(this._get=n.get),n.set&&(this._set=n.set),n.owner&&(this.owner=n.owner),n.onchange&&(this._onChange=this.owner?n.onchange.bind(this.owner):n.onchange),n.onerror&&(this._onError=this.owner?n.onerror.bind(this.owner):n.onerror),this._children=new c,"function"==typeof t&&(n.computable!==e?n.computable:t.constructor==Function)&&(this.computable=!0),this.computable){this._formula=t,C.unshift(new c);try{this._value=this._fixedValue=this._formula.call(this.owner||this)}catch(i){this._handleError(i)}this._parents=C.shift();for(var r,a=1,s=this._parents.values();!(r=s.next()).done;){var o=r.value;o._children.add(this),a<=o._maxParentDepth&&(a=o._maxParentDepth+1)}this._maxParentDepth=a}else this.initialValue=this._value=this._fixedValue=t,t instanceof p&&t.on("change",this._onValueChange,this)},get value(){return C.length&&C[0].add(this),(b||_==v)&&o(),this._get?this.computable?this._get.call(this.owner||this,this._value):this._get(this._value):this._value},set value(i){if(this.computable){if(!this._set)throw new TypeError("Cannot write to read-only dataСell");this._set.call(this.owner||this,i)}else{var r=this._value;if(this._set){var a={};r instanceof p&&r.off("change",this._onValueChange,this),this._set(i,a),i=this._value,i instanceof p&&i.on("change",this._onValueChange,this),t(r,i)?n(a)||l(this,{value:a},e,i!==this._fixedValue):(a.type="update",a.oldValue=r,a.value=i,l(this,{value:a}))}else if(!t(r,i)){if(this._value=i,t(i,this._fixedValue)&&m.get(this).cancellable)return m["delete"](this),void b--;r instanceof p&&r.off("change",this._onValueChange,this),i instanceof p&&i.on("change",this._onValueChange,this),l(this,{value:{type:"update",oldValue:r,value:i}})}}},_onValueChange:function(t){l(this,e,t,this._value!==this._fixedValue)},_recalc:function(){if(w.has(this)){if(10==w.get(this))return void this._handleError(new RangeError("Circular dependency detected"));w.set(this,w.get(this)+1)}else w.set(this,1);var e,n=this._value,r=this._parents;C.unshift(new c);try{var a=this._formula.call(this.owner||this)}catch(s){e=s}if(_!=g)return void C.shift();for(var o,u=this._parents=C.shift(),h=1,f=r.values();!(o=f.next()).done;)u.has(o.value)||o.value._children["delete"](this);for(var o,f=u.values();!(o=f.next()).done;){var p=o.value;r.has(p)||p._children.add(this),h<=p._maxParentDepth&&(h=p._maxParentDepth+1)}if(this._maxParentDepth!=h){if(this._maxParentDepth<h)return this._maxParentDepth=h,void i(this);this._maxParentDepth=h}e?this._handleError(e):t(n,a)||(this._value=a,l(this,{value:{type:"update",oldValue:n,value:a}}))},_handleError:function(e){this._logError(e);var t=this.emit("error",{error:e});this._handleErrorEvent(t)},_handleErrorEvent:function(e){if(this._lastErrorEvent!==e){this._lastErrorEvent=e,e.target!=this&&this._handleEvent(e);for(var t,n=this._children.values();!(t=n.next()).done&&!e.isPropagationStopped;)t.value._handleErrorEvent(e)}},on:function(){b&&o(),x.$super.on.apply(this,arguments)},off:function(){b&&o(),x.$super.off.apply(this,arguments)},dispose:function(){if(!this.disposed){if(m.has(this)&&(m["delete"](this),b--),a(this),this.computable)for(var e,t=this._parents.values();!(e=t.next()).done;)e.value._children["delete"](this);else this._value instanceof p&&this._value.off("change",this._onValueChange,this);for(var e,t=this._children.values();!(e=t.next()).done;)e.value.dispose();this.disposed=!0}}});r.DataCell=x}(),function(){function e(e){return Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t),r=n.value;"function"==typeof r&&r.constructor==i&&Object.defineProperty(e,t,{configurable:!0,enumerable:n.enumerable,get:function(){return n.value=Object.defineProperty(r.bind(this),"constructor",{configurable:!0,writable:!0,value:i}),Object.defineProperty(this,t,n),this[t]}})}),e}function t(e){if(e._dataCells){for(var t,n=e._dataCells.values();!(t=n.next()).done;)t.value.dispose();e._dataCells=null}return e}function n(e,t,n,r){var l=(this._dataCells||(this._dataCells=new s)).get(e);if(!l){if(null!==t&&"object"==typeof t)if("function"==typeof t.clone)t=t.clone();else if(Array.isArray(t))t=t.slice(0);else{var u=new t.constructor(t);t=u!=t?u:a(t)}n=Object.create(n),n.owner=this,l=new o(t,n),this._dataCells.set(e,l)}switch(r.length){case 0:return l.value;case 1:l.value=r[0];break;default:var h=r[0];return r[0]=l,i.prototype[h].apply(this,r)}return this}function i(e,t){function r(){return n.call(this,r,e,t,arguments)}return t||(t={}),Object.defineProperty(r,"constructor",{configurable:!0,writable:!0,value:i}),r}var a=r.object.clone,s=r.Map,o=r.DataCell;i.autoBind=e,i.disposeDataCells=t,Object.assign(i.prototype,{dataCell:function(e){return e},subscribe:function(e,t,n){return e.on("change",t,n||this),this},unsubscribe:function(e,t,n){return e.off("change",t,n||this),this}}),r.ActiveProperty=i,r.observable=function(e,t){return"function"==typeof e&&e.constructor==Function&&(t||(t={}),t.computable=!1),new i(e,t)},r.computable=function(e,t){return e.constructor!=Function&&(t||(t={}),t.computable=!0),new i(e,t)}}(),function(){function t(e){return function t(n,i,r,a,s){if(Array.isArray(n)||u&&n instanceof h)for(var o=n.length;o;)t.call(this,n[--o],i,r,a,s);else if("function"==typeof n&&n.constructor==l)n=n("dataCell",0);else if("object"==typeof i){s=a,a=r;var c=i;for(i in c)t.call(this,n,i,c[i],a,s)}else if(Array.isArray(r))for(var f=r,o=0,p=f.length;p>o;o++)t.call(this,n,i,f[o],a,s);else if("object"==typeof r){var d=r;for(var v in d)t.call(this,n[v]("dataCell",0),i,d[v],a,s)}else e.call(this,n,i,r,a,s);return this}}function n(e){e.target instanceof o?e.target.off(e.type,e.listener,e.context):e.target.removeEventListener(e.type,e.listener,!1)}var i=r.object.getUID,a=r.value.getHash,s=r.Map,o=r.EventEmitter,l=r.ActiveProperty,f=r.ActiveProperty.autoBind,p=r.ActiveProperty.disposeDataCells,d=o.extend({_listening:null,_callbacks:null,_timeouts:null,_dataCells:null,constructor:function(){if(o.call(this),!this.constructor._isActivePropertiesBound){var e=this.constructor;do f(e.prototype),e._isActivePropertiesBound=!0,e=e.$super.constructor;while(e!=d&&!e._isActivePropertiesBound)}},listen:t(function(e,t,n,i,r){this._listen(e,t,n,i,r)}),_listen:function(t,n,r,l,u){l||(l=this);var h=this._listening||(this._listening=new s),f=i(t)+"-"+n+"-"+i(r.hasOwnProperty(c)?r[c]:r)+"-"+i(l)+"-"+(u!==e?a(u):"");if(!h.has(f)){if(t instanceof o)t.on(n,r,l);else{if("function"!=typeof t.addEventListener)throw new TypeError("Unable to add a listener");t!=l&&(r=r.bind(l)),t.addEventListener(n,r,!1)}h.set(f,{target:t,type:n,listener:r,context:l,meta:u})}},stopListening:t(function(e,t,n,i,r){this._stopListening(e,t,n,i,r)}),_stopListening:function(t,r,s,o,l){var u=this._listening;if(u){o||(o=this);var h=i(t)+"-"+r+"-"+i(s.hasOwnProperty(c)?s[c]:s)+"-"+i(o)+"-"+(l!==e?a(l):"");u.has(h)&&(n(u.get(h)),u["delete"](h))}},stopAllListening:function(){var e=this._listening;if(e){for(var t in e)n(e[t]);this._listening=null}return this},registerCallback:function(e){function t(){t.hasOwnProperty("canceled")&&t.canceled||(n["delete"](e),e.apply(i,arguments))}var n=this._callbacks||(this._callbacks=new s);n.has(e)&&(n.get(e).canceled=!0);var i=this;return n.set(e,t),t},unregisterCallback:function(e){var t=this._callbacks;return t&&t.has(e)&&(t.get(e).canceled=!0,t["delete"](e)),this},unregisterAllCallbacks:function(){var e=this._callbacks;return e&&(e.forEach(function(e){e.canceled=!0}),this._callbacks=null),this},setTimeout:function(e,t){var n=this._timeouts||(this._timeouts=new s);n.has(e)&&clearTimeout(n.get(e));var i=this;return n.set(e,setTimeout(function(){n["delete"](e),e.call(i)},t)),this},clearTimeout:function(e){var t=this._timeouts;return t&&t.has(e)&&(clearTimeout(t.get(e)),t["delete"](e)),this},clearAllTimeouts:function(){var e=this._timeouts;return e&&(e.forEach(function(e,t){clearTimeout(t)}),this._timeouts=null),this},collectDumpObject:function(e){Object.keys(this).forEach(function(t){var n=Object.getOwnPropertyDescriptor(this,t).value;if("function"==typeof n&&n.constructor==l){var i=n("dataCell",0);if(!i.computable){var r=i.value;(r===Object(r)?i.changed:i.initialValue!==r)&&(e[t]=r)}}},this)},expandFromDumpObject:function(e){for(var t in e)this[t](e[t])},dispose:function(){this.stopAllListening().unregisterAllCallbacks().clearAllTimeouts(),p(this)}});r.Disposable=d}(),function(){var e=r.ActiveProperty,t=r.Disposable,n=t.extend({_options:null,constructor:function(e,n){t.call(this),this._options=n||{},e&&this.setData(e)},setData:function(t){for(var n in t)"function"==typeof this[n]&&this[n].constructor==e&&this[n](t[n])},collectDumpObject:function(e,t){n.$super.collectDumpObject.call(this,e),Object.assign(t,this._options)}});r.BaseModel=n}(),function(){function e(e){return e.replace(t,"&amp;").replace(n,"&lt;").replace(i,"&gt;").replace(a,"&quot;")}var t=/&/g,n=/</g,i=/>/g,a=/"/g;r.html={escape:e}}(),function(){function e(e,t){e=i(e),t?(t.parent=this,t.block=null):t={parent:this,block:null};var r=this._childRenderings,a=r.count++,s=r.marks[a]="{{_"+n()+"}}";return new e(t).render(function(e){r.results[a]=e,r.count==++r.readyCount&&r.onallready&&r.onallready()}),s}function t(e,t,n){if(e)if(e instanceof a?e=e.toObject():e instanceof o&&(e=e.toArray()),Array.isArray(e))for(var i=0,r=e.length;r>i;i++)i in e&&t.call(n,e[i],i);else for(var l in e)s.call(e,l)&&t.call(n,e[l],l)}var n=r.uid.next,i=r.Class.getOrError,a=r.ActiveDictionary,o=r.ActiveArray;r.template={defaults:{include:e,each:t}}}(),function(){function e(e,t,n){if(e.hasOwnProperty(h)&&e[h])return e[h];var i=e[h]=[];if(e.hasAttribute("rt-bind")){var r=!n||n.applyValues!==!1;a(u,e.getAttribute("rt-bind"),function(n,a,l,u){var h=new s(Function("return "+u+";").bind(t),{onchange:function(){o[a](e,this.value,l)}});i.push(h),r&&o[a](e,h.value,l)})}return i}function t(e){if(e.hasOwnProperty(h)){var t=e[h];if(t){for(var n=t.length;n;)t[--n].dispose();e[h]=null}}}function n(t,n,i){i||(i={});var r=i.removeAttr===!0,a={applyValues:i.applyValues!==!1},s=[];i.bindRootElement!==!1&&t.hasAttribute("rt-bind")&&(s.push.apply(s,e(t,n,a)),r&&t.removeAttribute("rt-bind"));for(var o=t.querySelectorAll("[rt-bind]"),l=0,u=o.length;u>l;l++)s.push.apply(s,e(o[l],n,a)),r&&t.removeAttribute("rt-bind");return s}var i=r.namespace.create,a=r.regex.forEach,s=r.DataCell,o={html:function(e,t){e.innerHTML=t},text:function(e,t,n){switch(n){case"first":var i=e.firstChild;i&&3==i.nodeType?i.nodeValue=t:e.insertBefore(document.createTextNode(t),i);break;case"last":var i=e.lastChild;i&&3==i.nodeType?i.nodeValue=t:e.appendChild(document.createTextNode(t));break;case"prev":var i=e.previousSibling;i&&3==i.nodeType?i.nodeValue=t:e.parentNode.insertBefore(document.createTextNode(t),e);break;case"next":var i=e.nextSibling;i&&3==i.nodeType?i.nodeValue=t:e.parentNode.insertBefore(document.createTextNode(t),i);break;default:if(1==e.childNodes.length&&3==e.firstChild.nodeType)e.firstChild.nodeValue=t;else{for(;e.lastChild;)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(t))}}},prop:function(e,t,n){n=n.split(".");var r=n.pop();i(n,e)[r]=t},attr:function(e,t,n){t=String(t),e.getAttribute(n)!==t&&e.setAttribute(n,t)},value:function(e,t){t=String(t),e.value!=t&&(e.value=t)},checked:function(e,t){t=Boolean(t),e.checked!=t&&(e.checked=t)},css:function(e,t,n){t=String(t),n||(n="cssText"),e.style[n]!=t&&(e.style[n]=t)},show:function(e,t){e.style.display=t?"":"none"}},l="[$_a-zA-Z][$\\w]*",u=RegExp("("+l+")(?:\\(([^)]*)\\))?:\\s*(\\S[\\s\\S]*?)(?=\\s*(?:,\\s*"+l+"(?:\\([^)]*\\))?:\\s*\\S|$))","g"),h="_rt-dataCells";r.domBinding={helpers:o,bindElement:e,unbindElement:t,bind:n}}(),function(){function t(){}function i(e,n){if(e._receiveData!=t){if(e._beforeDataReceiving!=t)try{e._beforeDataReceiving()}catch(i){e._logError(i)}try{e._receiveData.length?e._receiveData(function(t){null!=t&&(e.dataReceivingError=t,
e._logError(t)),a(e),n.call(e)}):e._receiveData()["catch"](function(t){e.dataReceivingError=t,e._logError(t)}).then(function(){a(e),n.call(e)})}catch(i){e.dataReceivingError=i,e._logError(i),a(e),n.call(e)}}else n.call(e)}function a(e){if(e._afterDataReceiving!=t)try{e._afterDataReceiving()}catch(n){e._logError(n)}}function f(e,t){for(var n in t){var i=t[n];null!=i&&i!==!1&&e.push("__"+n+(i===!0?"":"_"+i))}return e}function p(e,t){for(var n in t)e.setAttribute(n,t[n])}function d(e,t,n){for(var i=e.children,r=!1,a=i.length;a;){var s=i[--a];s.blockName==t?(s.$(n),r=!0):d(s,t,n)&&(r=!0)}return r}function v(t,n){if(n.hasOwnProperty(S)&&n[S]&&n[D]==t){var i=t.elements[n[S]];i.splice(i.indexOf(n),1),n[D]=null,n[S]=e,n.parentNode&&n.parentNode.removeChild(n)}}var g=r.object.getUID,_=r.namespace.exec,m=r.value.getHash,b=r.value.stringify,y=r.Class.classes,w=r.Class.getOrError,C=r.Map,x=r.Disposable,O=r.html.escape,j=r.domBinding.bind,E=new r.Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr","circle","ellipse","line","path","polygone","polyline","rect","stop","use"]),P=/^(.+?):(.+)$/,k=/([^,]*),([^,]*),(.*)/,D="_rt-view",S="_rt-viewElementName",I=x.extend({_params:null,_id:e,app:null,model:null,name:e,tagName:"div",blockName:e,mods:null,attrs:null,_parent:null,get parent(){return this._parent},set parent(e){e?e.registerChild(this):this._parent&&this._parent.unregisterChild(this)},children:null,block:null,elements:null,dataReceivingError:null,_currentlyRendering:!1,_childRenderings:null,template:function(){return""},onlyClient:!1,isClientInited:!1,constructor:function(t){if(x.call(this),t||(t={}),this._params=t,this.mods=Object.create(this.mods),this.attrs=Object.create(this.attrs),this.children=[],this.elements={},!this.blockName){for(var n=this.constructor;n.$super.constructor!=I;)n=n.$super.constructor;n.prototype.blockName=n.__class}var r;if(l){if(t.block)throw new TypeError('Parameter "block" can\'t be used on the server side');r=null,null===t.block&&delete t.block}else t.block!==e&&(r=t.block,delete t.block);if(null===r)this._id=g(this,l?"s":"c"),this._parseParams();else{var a,s=!1;if(r){if(r instanceof h&&(r=r[0]),r.hasOwnProperty(D)&&r[D])throw new TypeError("Element is already used as "+(r.hasOwnProperty(S)&&r[S]?"an element":"a block")+" of view");r.hasAttribute("rt-d")&&(a=r.getAttribute("rt-d").match(k),a[2]&&(s=!0),a[3]&&Object.assign(t,Function("return {"+a[3]+"};")()))}if(this._id=s?a[2]:g(this,"c"),this._parseParams(),r||(r=document.createElement(this.tagName)),this.block=h(r),r[D]=this,s){var o=this;this.block.find("[rt-p="+this._id+"]").each(function(){new(y[this.getAttribute("rt-d").match(k)[1]])({parent:o,block:this})})}else p(r,this.attrs),r.className=(f([this.blockName],this.mods).join(" ")+" "+r.className).trim(),this._currentlyRendering=!0,i(this,function(){this._renderInner(function(e){this._currentlyRendering=!0,r.innerHTML=e;for(var t=r.querySelectorAll("[rt-p]"),n={},i=t.length;i;)n[t[--i].getAttribute("rt-d").match(k)[2]]=t[i];!function a(e){for(var t=e.children,i=t.length;i;){var r=t[--i],s=n[r._id];r.block=h(s),s[D]=r,a(r)}}(this)})})}},_parseParams:function(){var t=this._params;t.name&&(this.name=t.name),t.tagName&&(this.tagName=t.tagName,delete t.tagName),t.blockName&&(this.blockName=t.blockName),t.mods&&(Object.assign(this.mods,t.mods),delete t.mods),t.attrs&&(Object.assign(this.attrs,t.attrs),delete t.attrs),t.parent&&(this.parent=t.parent,delete t.parent),t.app&&(this.app=t.app,delete t.app,this.model=this.app.model);var n=t.model;if(n)"string"==typeof n?this.model=_(n,this._parent||this):(this.model=n,delete t.model);else{var i=this._parent;i&&i.model&&(this.model=i.model)}t.onlyClient!==e&&(this.onlyClient=t.onlyClient)},render:function(e){if(this._currentlyRendering)throw new TypeError("Cannot run the rendering when it is in process");return l&&this.onlyClient?void e(this._renderOpenTag(!0)+(E.has(this.tagName)?"":"</"+this.tagName+">")):(this._currentlyRendering=!0,void i(this,function(){E.has(this.tagName)?(this._currentlyRendering=!1,e(this._renderOpenTag(!1))):this._renderInner(function(t){this._currentlyRendering=!1,e(this._renderOpenTag(!1)+t+"</"+this.tagName+">")})}))},_renderOpenTag:function(e){var t;if(e)t="";else{var i=this.attrs;t=['class="'+(f([this.blockName],this.mods).join(" ")+" "+(i["class"]||"")).trim()+'"'];for(var r in i)"class"!=r&&t.push(r+'="'+i[r]+'"')}return"<"+this.tagName+" "+t.join(" ")+' rt-d="'+[this.constructor.__class,e?"":this._id,n(this._params)?"":O(b(this._params).slice(1,-1))]+'"'+(this._parent?' rt-p="'+this._parent._id+'"':"")+">"},_renderInner:function(e){var t,n=this._childRenderings={count:0,readyCount:0,marks:[],results:[],onallready:null};try{t=this.template.call(this)}catch(i){return this._childRenderings=null,this._logError(i),void e.call(this,"")}var r=this;n.onallready=function(){r._childRenderings=null;for(var i=n.marks,a=n.results,s=i.length;s;)t=t.replace(i[--s],function(){return a[s]});e.call(r,t)},n.count==n.readyCount&&n.onallready()},_receiveData:t,_beforeDataReceiving:t,_afterDataReceiving:t,initClient:function(){if(this.isClientInited)throw new TypeError("Client is already initialized");this.isClientInited=!0;for(var e=this.children.slice(0),n=0,i=e.length;i>n;n++)e[n].initClient();try{for(var r=this._dataCells||(this._dataCells=new C),a=j(this.block[0],this,{applyValues:!1,removeAttr:!0}),n=a.length;n;)r.set(a[--n],a[n]);this._initClient!=t&&this._initClient(),this._bindEvents!=t&&this._bindEvents()}catch(s){this._logError(s)}},_initClient:t,_bindEvents:t,registerChild:function(e){if(e._parent){if(e._parent==this)return this;throw new TypeError("View is already used as a child of view")}e._parent=this;var t=this.children,n=e.name;return t.push(e),n&&(s.call(t,n)?t[n]:t[n]=[]).push(e),this},unregisterChild:function(e){if(e._parent!==this)return this;e._parent=null;var t=this.children,n=e.name;if(t.splice(t.indexOf(e),1),n){var i=t[n];i.splice(i.indexOf(e),1)}return this},$:function(e){var t;s.call(this.elements,e)?t=this.elements[e]:(t=h("."+this.blockName+"_"+e,this.block),d(this,this.blockName,e)&&(t=t.filter(function(){return!this.hasOwnProperty(D)||!this[D]})),this.elements[e]=t);var n=arguments.length;if(n>1){var i=1;do{var r=arguments[i],a="string"==typeof r;if(a||r instanceof HTMLElement){if(a){var o=document.createElement("div");o.innerHTML=r,r=1==o.childNodes.length&&1==o.firstChild.nodeType?o.firstChild:o}else if(r.hasOwnProperty(D)&&r[D]){if(!r.hasOwnProperty(S)||!r[S])throw new TypeError("Element is already used as a block of view");if(r[D]!=this||r[S]!=e)throw new TypeError("Element is already used as an element of view");continue}r.className=(this.blockName+"_"+e+" "+r.className).trim()}else{var l=r;r=document.createElement(l.tagName||"div"),l.attrs&&p(r,l.attrs);var u=[this.blockName+"_"+e];l.mods&&f(u,l.mods),r.className=(u.join(" ")+" "+r.className).trim(),l.html&&(r.innerHTML=l.html)}r[D]=this,r[S]=e,t.push(r)}while(++i<n)}return t},$rm:function(){for(var e=arguments.length;e;){var t=arguments[--e];if("string"==typeof t){if(!s.call(this.elements,t))continue;t=this.elements[t]}if(t instanceof h){var n=this;t.each(function(){v(n,this)})}else v(this,t)}return this},broadcast:function(e,t){var n,i;if(P.test(e)?(n=RegExp.$1,i=RegExp.$2):(n=e,i="*"),"*"==n)e=this.children;else{if(!s.call(this.children,n))return[];e=this.children[n]}"*"==i?e=e.slice(0):(i=w(i),e=e.filter(function(e){return e instanceof i}));var r=o.call(arguments,2);return e.map(function(e){return e[t].apply(e,r)})},_listen:function(e,t,n,i,r){var a,s;if(e instanceof I)if(P.test(t)){if(a=RegExp.$1,s=RegExp.$2,"*"!=s){s=w(s);var o=n,l=function(e){return e.target instanceof s?o.call(this,e):void 0};l[c]=o,n=l}}else{a=t;var u=this,o=n,l=function(e){return e.target==u?o.call(this,e):void 0};l[c]=o,n=l}else a=t;I.$super._listen.call(this,e,a,n,i,(s?"*"===s?"":g(s):"0")+m(r))},_stopListening:function(e,t,n,i,r){var a,s;e instanceof I&&P.test(t)?(a=RegExp.$1,s=RegExp.$2,"*"!=s&&(s=w(s))):a=t,I.$super._stopListening.call(this,e,a,n,i,(s?"*"===s?"":g(s):"0")+m(r))},dispose:function(){var e;u&&(e=this.block[0],e.parentNode&&e.parentNode.removeChild(e));for(var t=this.children,n=t.length;n;)t[--n].dispose();if(this._parent){var i=this._parent.children;if(i.splice(i.indexOf(this),1),this.name){var r=i[this.name];r.splice(r.indexOf(this),1)}}u&&(e[D]=null),I.$super.dispose.call(this)}});r.BaseView=I}(),function(){var e=r.dump.serialize,t=r.dump.deserialize,n=r.ActiveProperty,i=r.Disposable,a=i.extend("Rift.ViewState",{properties:null,constructor:function(e){i.call(this),this.properties=Object.keys(e);for(var t in e){var r=("function"==typeof e[t]?e[t]:new n(e[t])).bind(this);Object.defineProperty(r,"constructor",{configurable:!0,writable:!0,value:n}),this[t]=r}},serializeData:function(){for(var t=this.properties,n={},i=t.length;i;){var r=this[t[--i]]("dataCell",0);if(!r.computable){var a=r.value;(a===Object(a)?r.changed:r.initialValue!==a)&&(n[t[i]]=e({v:a}))}}return n},updateFromSerializedData:function(e){var n={};for(var i in e)n[i]=t(e[i]).v;return this.update(n),this},update:function(e){for(var t=this.properties,n=t.length;n;){var i=t[--n];this[i](s.call(e,i)?e[i]:this[i]("dataCell",0).initialValue)}return this}});r.ViewState=a}(),function(){function t(e){if(""!=e){if("NaN"==e)return 0/0;var t=Number(e);if(t==t)return t}return e}function n(e){e=e.split("/");for(var t=e.length;t;)e[--t]=encodeURIComponent(decodeURIComponent(e[t]));return e.join("/")}function i(e){return"/"!=e[0]&&(e="/"+e),"/"!=e[e.length-1]&&(e+="/"),e}function a(e,n){for(var i=e.routes,r=0,a=i.length;a>r;r++){var s=i[r],o=n.match(s.rePath);if(o)return{route:s,state:s.properties.reduce(function(e,n,i){return e[n.name]=1==n.type?Boolean(o[i+1]):t(decodeURIComponent(o[i+1])),e},{})}}return null}function s(e,t){for(var n=e.app.viewState,i=e.routes,r=null,a=0,s=i.length;s>a;a++){for(var l=i[a],u=l.requiredProperties,h=u.length;h--;){var c=n[u[h]]();if(null==c||c===!1||""===c)break}if(-1==h){if(u.length){r=l;break}r&&l!==t||(r=l)}}return r&&{route:r,path:o(e,r)}}function o(t,n){for(var r=t.app.viewState,a=n.pathMap,s=[],o=0,l=a.length;l>o;o++){for(var u=a[o],h=u.requiredProperties,c=h.length;c--;){var f=r[h[c]]();if(null==f||f===!1||""===f)break}-1==c&&s.push(u.pathPart!==e?u.pathPart:r[u.prop]())}return i(s.join(""))}function h(e,t,n,i,r){if(e.currentRoute=t,e.currentPath=n,u)if(r)history[1==r?"replaceState":"pushState"]({"_rt-state":{routeIndex:e.routes.indexOf(t),path:n,viewStateData:i}},null,n);else{var a=history.state||{};a["_rt-state"]={routeIndex:e.routes.indexOf(t),path:n,viewStateData:i},history.replaceState(a,null,n)}t.callback&&t.callback.call(e.app,n)}var c=r.regex.escape,f=r.process.nextTick,p=r.Disposable,d=/^(?:\w+:)?\/\//,v=/[\/\\]+/g,g=/\{([^}]+)\}/g,_=/\((?:\?(\S+)\s+)?([^)]+)\)/g,m=p.extend({app:null,viewBlock:null,routes:null,currentRoute:null,currentPath:e,started:!1,_isViewStateChangeHandlingRequired:!1,constructor:function(e,t){p.call(this),this.app=e,this.routes=[],t&&this.addRoutes(t)},addRoutes:function(e){return e.forEach(function(e){"string"==typeof e&&(e={path:e}),this.addRoute(e.path,e.callback)},this),this},addRoute:function(t,i){if(this.started)throw new TypeError("Router is already started");t=t.split(_);for(var r=[],a=[],s=[],o=[],l=0,u=t.length;u>l;)if(l%3){r.push("(");var h=[];t[l]&&(h.push(t[l]),a.push({type:1,name:t[l]}));for(var f=t[l+1].split(g),p=0,d=f.length;d>p;p++)if(p%2){var v=f[p];h.push(v),r.push("([^\\/]+)"),a.push({type:2,name:v}),o.push({requiredProperties:h,pathPart:e,prop:v})}else if(f[p]){var m=n(f[p]);r.push(c(m).split("\\*").join(".*?")),o.push({requiredProperties:h,pathPart:m.split("*").join(""),prop:e})}r.push(")?"),l+=2}else{if(t[l])for(var f=t[l].split(g),p=0,d=f.length;d>p;p++)if(p%2){var v=f[p];r.push("([^\\/]+)"),a.push({type:0,name:v}),s.push(v),o.push({requiredProperties:[v],pathPart:e,prop:v})}else if(f[p]){var m=n(f[p]);r.push(c(m).split("\\*").join(".*?")),o.push({requiredProperties:[],pathPart:m.split("*").join(""),prop:e})}l++}return this.routes.push({rePath:RegExp("^\\/?"+r.join("")+"\\/?$"),properties:a,requiredProperties:s,pathMap:o,callback:i}),this},start:function(){if(this.started)return this;if(this.started=!0,u&&(this.viewBlock=this.app.view.block[0]),this._bindEvents(),l){var e=s(this,"/"==this.currentPath?null:this.currentRoute);e&&h(this,e.route,e.path,this.app.viewState.serializeData())}return this},_bindEvents:function(){u&&this.listen(window,"popstate",this._onWindowPopState).listen(this.viewBlock,"click",this._onViewBlockClick);for(var e=this.app.viewState,t=this._onViewStatePropertyChange,n=e.properties,i=n.length;i;)this.listen(e[n[--i]],"change",t)},_onWindowPopState:function(){var t=history.state&&history.state["_rt-state"];if(t){var n=this.currentRoute=this.routes[t.routeIndex],i=this.currentPath=t.path;this.app.viewState.updateFromSerializedData(t.viewStateData),n.callback&&n.callback.call(this.app,i)}else{this.app.viewState.update({});var r=s(this);r?h(this,r.route,r.path,{},1):(this.currentRoute=null,this.currentPath=e)}},_onViewBlockClick:function(e){for(var t=this.viewBlock,n=e.target;"A"!=n.tagName;){if(n==t)return;n=n.parentNode}var i=n.getAttribute("href");!d.test(i)&&this.route(i,!0)&&e.preventDefault()},_onViewStatePropertyChange:function(){this._isViewStateChangeHandlingRequired||(this._isViewStateChangeHandlingRequired=!0,f(this.registerCallback(this._onViewStateChange)))},_onViewStateChange:function(){if(this._isViewStateChangeHandlingRequired){this._isViewStateChangeHandlingRequired=!1;var e=s(this,this.currentRoute);if(e){var t=e.path;if(t===this.currentPath){if(u){var n=history.state||{};n["_rt-state"]||(n["_rt-state"]={routeIndex:this.routes.indexOf(this.currentRoute),path:t}),n["_rt-state"].viewStateData=this.app.viewState.serializeData(),history.replaceState(n,null,t)}}else h(this,e.route,t,this.app.viewState.serializeData(),2)}}},route:function(e,t){if(e=n(e.replace(v,"/")),"/"!=e[0]){var i=location.pathname;e=i+("/"==i[i.length-1]?"":"/")+e}if("/"!=e[e.length-1]&&(e+="/"),e===this.currentPath)return!0;var r=a(this,e);return r?(this.app.viewState.update(r.state),h(this,r.route,e,this.app.viewState.serializeData(),t?2:1),!0):!1}});r.Router=m}(),function(){function t(t,n){for(var i=Object.assign({},t),r=n.length;r;)for(var a=n[--r].properties,o=a.length;o;){var l=a[--o].name;s.call(i,l)||(i[l]=e)}return i}var n=r.dump.deserialize,i=r.ViewState,a=r.Router,o=r.Class.extend({model:null,view:null,viewState:null,router:null,_init:function(e,r,s,o,l,h,c){this.model="function"==typeof e?new e:n(e);var f=this.router=new a(this,h);this.viewState=new i(t(o,f.routes)),f.route(c),u&&this.viewState.updateFromSerializedData(l);var p=this.view=new r({app:this,block:s});f.start(),u&&p.initClient()},dispose:function(){this.router.dispose(),this.view.dispose(),this.viewState.dispose(),this.model.dispose()}});r.BaseApp=o}()}();