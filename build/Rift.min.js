!function(e){"use strict";function t(e,t){return e===t||e!=e&&t!=t}function n(e){for(var t in e)return!1;return!0}function i(){}function r(e){console.error(e===Object(e)&&e.stack||e)}var a,s=Function("return this;")(),l=Object.prototype.hasOwnProperty,o=Array.prototype.slice;a="undefined"!=typeof exports?exports:s.Rift=s.rt={},a.global=s;var c=a.isServer="undefined"==typeof window&&"undefined"==typeof navigator,u=a.isClient=!c;a.logError=r;var h;u&&(h=a.$=s.jQuery||s.Zepto||s.ender||s.$);var f="_rt-listeningInner";Object.assign||Object.defineProperty(Object,"assign",{configurable:!0,writable:!0,value:function(e,t){if(null==e)throw new TypeError("Can't convert "+e+" to an object");e=Object(e);for(var n=1,i=arguments.length;i>n;n++){if(t=arguments[n],null==t)throw new TypeError("Can't convert "+t+" to an object");t=Object(t);for(var r=Object.keys(t),a=0,s=r.length;s>a;a++)e[r[a]]=t[r[a]]}return e}}),function(){function t(t){return(t===e?"":t)+ ++i}function n(){i=0}var i=0;a.uid={next:t,resetCounter:n}}(),function(){function e(e,t,n){for(var i=n?Object.keys(t):Object.getOwnPropertyNames(t),r=i.length;r;)Object.defineProperty(e,i[--r],Object.getOwnPropertyDescriptor(t,i[r]));return e}function t(t){return e(Object.create(Object.getPrototypeOf(t)),t)}var n,i=a.uid.next;if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){var r=Symbol("uid");n=function(e,t){return e[r]||(e[r]=i(t))}}else{var s="_rt-uid";n=function(e,t){return l.call(e,s)||Object.defineProperty(e,s,{value:i(t)}),e[s]}}a.object={getUID:n,mixin:e,clone:t}}(),function(){function e(e,t){"string"==typeof e&&(e=e.split("."));for(var n=t||s,i=0,r=e.length;r>i;i++){var a=n[e[i]];if(a!==Object(a)){do n=n[e[i]]={};while(++i<r);break}n=a}return n}function t(e,t){return Function("return this."+e+";").call(t||s)}a.namespace={create:e,exec:t}}(),function(){function e(e){return e.replace(n,"\\$1")}function t(e,t,n){if(e.global){e.lastIndex=0;for(var i;(i=e.exec(t))&&n.apply(s,i)!==!1;);}else{var i=e.exec(t);i&&n.apply(s,i)}}var n=/([?+|$(){}[^.\-\]\/\\*])/g;a.regex={escape:e,forEach:t}}(),function(){function t(t){if(t===e)return"undefined";if(null===t)return"null";switch(typeof t){case"boolean":return"?"+t;case"number":return"+"+t;case"string":return";"+t}return"#"+r(t)}function n(e){return e.replace(s,function(e){return o[e]||"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})}function i(t){if(t===e)return"void 0";if(null===t)return"null";var r=typeof t;if("object"!=r)return"string"==r?"'"+n(t).replace(u,"</'+'$1>")+"'":String(t);var a=[];if(Array.isArray(t)){for(var s=t.length;s;)a.unshift(--s in t?i(t[s]):"");a="["+a.join(",")+(""==a[a.length-1]?",]":"]")}else{for(var o in t)l.call(t,o)&&a.push((c.test(o)?o:"'"+n(o)+"'")+":"+i(t[o]));a="{"+a+"}"}return a.replace(u,"</'+'$1>")}var r=a.object.getUID,s=RegExp("[\\\\'\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]","g"),o=Object.assign(Object.create(null),{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"}),c=/^[$_a-zA-Z][$\w]*$/,u=/<\/(script\b[^>]*)>/gi;a.value={getHash:t,toString:i}}(),function(){var e;if(s.process&&s.process.nextTick)e=s.process.nextTick;else if(s.setImmediate)e=function(e){setImmediate(e)};else if(s.postMessage&&!s.ActiveXObject){var t;s.addEventListener("message",function(){if(t){var e=t;t=null;for(var n=0,i=e.length;i>n;n++)try{e[n]()}catch(r){a.logError(r)}}},!1),e=function(e){t?t.push(e):(t=[e],s.postMessage("__tic__","*"))}}else e=function(e){setTimeout(e,1)};a.process={nextTick:e}}(),function(){function t(e){if(!l.call(s,e))throw new TypeError('Class "'+e+'" is not defined');return s[e]}function n(e,t){if(l.call(s,e))throw new TypeError('Class "'+e+'" is already registered');return Object.defineProperty(t,"__class",{value:e}),s[e]=t,t}function i(t,a){"object"==typeof t&&(a=t,t=e);var s,o=this;l.call(a,"constructor")?(s=a.constructor,delete a.constructor):s=function(){return o.apply(this,arguments)};var c=Object.create(o.prototype);return s.prototype=c,Object.defineProperty(s,"$super",{writable:!0,value:o.prototype}),Object.defineProperty(c,"constructor",{configurable:!0,writable:!0,value:s}),r(s,o,!0),l.call(a,"static")&&(r(s,a["static"]),delete a["static"]),s.extend||(s.extend=i),r(c,a),t&&n(t,s),s}var r=a.object.mixin,s={};a.Class={classes:s,getOrError:t,register:n,extend:i}}(),function(){function t(i,r){var a=s(i);if(l.call(r,a))return a;var o={},c={};if(l.call(i.constructor,"__class")?(i.collectDumpObject?i.collectDumpObject(o,c):Object.assign(o,i),r[a]={c:i.constructor.__class}):(Object.assign(o,i),r[a]={}),!n(o)){for(var u in o){var h=o[u];o[u]=h===Object(h)?t(h,r):h===e?{}:{v:h}}r[a].d=o}return n(c)||(r[a].o=c),a}function i(e){var n={};return o({s:n,r:t(e,n)})}function r(t){"string"==typeof t&&(t=Function("return "+t+";")());var n=t.s;for(var i in n){var r=n[i];if(l.call(r,"c")){var a=c[r.c];r.instance=l.call(r,"o")?new a(e,r.o):new a}else r.instance={}}for(var i in n){var r=n[i];if(l.call(r,"d")){var s=r.d;for(var o in s){var u=s[o];s[o]="object"==typeof u?l.call(u,"v")?u.v:e:n[u].instance}l.call(r,"c")&&r.instance.expandFromDumpObject?r.instance.expandFromDumpObject(s):Object.assign(r.instance,s)}}return n[t.r].instance}var s=a.object.getUID,o=a.value.toString,c=a.Class.classes,u=a.Class.register;u("Array",Array),u("Date",Date),Object.defineProperties(Date.prototype,{collectDumpObject:{configurable:!0,writable:!0,value:function(e){e.utc=this.toString()}},expandFromDumpObject:{configurable:!0,writable:!0,value:function(e){this.setTime(new Date(e.utc))}}}),a.dump={serialize:i,deserialize:r}}(),function(){function t(e,t){this.type=e,t&&(this.bubbles=!0)}t.extend=a.Class.extend,Object.assign(t.prototype,{target:null,timestamp:e,type:e,bubbles:!0,isPropagationStopped:!1,isImmediatePropagationStopped:!1,detail:null,stopPropagation:function(){this.isPropagationStopped=!0},stopImmediatePropagation:function(){this.isPropagationStopped=!0,this.isImmediatePropagationStopped=!0}}),a.Event=t}(),function(){function e(e){return function t(n,i,r){if("object"==typeof n){r=i;var a=n;for(n in a)t.call(this,n,a[n],r)}else e.call(this,n,i,r);return this}}function t(){}var n=a.Event,i="_emt-used";t.extend=a.Class.extend,Object.assign(t.prototype,{_events:null,parent:null,silent:!1,on:e(function(e,t,n){var i=this._events||(this._events=Object.create(null));(i[e]||(i[e]=[])).push({listener:t,context:n||this})}),off:e(function(e,t,n){var i=(this._events||(this._events=Object.create(null)))[e];if(i){n||(n=this);for(var r=i.length;r;){var a=i[--r];a.context==n&&(a.listener==t||l.call(a.listener,f)&&a.listener[f]===t)&&i.splice(r,1)}i.length||delete this._events[e]}}),once:function(e,t,n){function i(){this.off(e,i),t.apply(this,arguments)}return i[f]=t,this.on(e,i,n)},emit:function(e,t){if("string"==typeof e)e=new n(e);else if(l.call(e,i))throw new TypeError("Attempt to use an object that is no longer usable");return e[i]=!0,e.target=this,e.timestamp=Date.now(),t&&(e.detail=t),this._handleEvent(e),e},_handleEvent:function(e){if(!this.silent||e.target!=this){var t,n=e.type,i=(this._events||(this._events=Object.create(null)))[n];if("function"==typeof this["on"+n]?(i=i?i.slice(0):[],i.push({listener:this["on"+n]}),t=i.length):i?(i=i.slice(0),t=i.length):t=0,t){var r=0;do{if(e.isImmediatePropagationStopped)break;try{i[r].listener.call(i[r].context,e)===!1&&(e.isPropagationStopped=!0)}catch(a){this._logError(a)}}while(++r<t)}}var s=this.parent;s&&e.bubbles&&!e.isPropagationStopped&&s._handleEvent(e)},_logError:function(e){a.logError(e)}}),a.EventEmitter=t}(),function(){var n=a.value.getHash,i=a.EventEmitter,r=i.extend("Rift.ActiveDictionary",{_inner:null,_valueCount:null,_handleItemChanges:!1,constructor:function(e,t){i.call(this),this._valueCount={},"boolean"==typeof t?t={handleItemChanges:t}:t||(t={});var a=t.handleItemChanges===!0;if(a&&(this._handleItemChanges=!0),e){var s=this._inner=Object.assign(Object.create(null),e instanceof r?e._inner:e),o=this._valueCount;for(var c in s){var u=s[c],h=n(u);l.call(o,h)?o[h]++:(o[h]=1,a&&u instanceof i&&u.on("change",this._onItemChange,this))}}else this._inner={}},_onItemChange:function(e){this._handleEvent(e)},has:function(e){return e in this._inner},get:function(e){return this._inner[e]},set:function(e,r){var a;"string"==typeof e?(a={},a[e]=r):a=e;var s=this._inner,o=this._valueCount,c=this._handleItemChanges,u=!1,h={},f=[],d=[],p={$removedValues:f,$addedValues:d};for(e in a){var v=e in s,g=s[e];if(r=a[e],!v||!t(g,r)){if(u=!0,v){var _=n(g);--o[_]||(delete o[_],c&&g instanceof i&&g.off("change",this._onItemChange),h[_]=g)}var m=n(r);l.call(o,m)?o[m]++:(o[m]=1,c&&r instanceof i&&r.on("change",this._onItemChange,this),l.call(h,m)?delete h[m]:d.push(r)),p[e]={type:v?"update":"add",oldValue:g,value:r},s[e]=r}}if(u){for(var m in h)f.push(h[m]);this.emit("change",{diff:p})}return this},"delete":function(){for(var t=this._inner,r=this._valueCount,a=this._handleItemChanges,s=!1,l=[],o={$removedValues:l,$addedValues:[]},c=0,u=arguments.length;u>c;c++){var h=arguments[c];if(h in t){s=!0;var f=t[h],d=n(f);--r[d]||(delete r[d],a&&f instanceof i&&f.off("change",this._onItemChange),l.push(f)),o[h]={type:"delete",oldValue:f,value:e},delete t[h]}}return s&&this.emit("change",{diff:o}),this},contains:function(e){return l.call(this._valueCount,n(e))},clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toObject:function(){return Object.assign({},this._inner)},collectDumpObject:function(e,t){var n=this._inner;for(var i in n)e[i]=n[i];this._handleItemChanges&&(t.handleItemChanges=!0)},expandFromDumpObject:function(e){this.set(e)},dispose:function(){if(this._handleItemChanges){var e=this._inner;for(var t in e)e[t]instanceof i&&e[t].off("change",this._onItemChange)}}});a.ActiveDictionary=r}(),function(){var e=a.value.getHash,i=a.EventEmitter,r=Array.prototype,s=r.push,o=r.unshift,c=r.concat,u=r.slice,h=r.splice,f=r.map,d=r.reduce,p=i.extend("Rift.ActiveArray",{_inner:null,_valueCount:null,_handleItemChanges:!1,constructor:function(t,n){i.call(this),this._valueCount={},"boolean"==typeof n?n={handleItemChanges:n}:n||(n={});var r=n.handleItemChanges===!0;if(r&&(this._handleItemChanges=!0),t){for(var a=this._inner=(t instanceof p?t._inner:t).slice(0),s=this._valueCount,o=a.length;o;)if(--o in a){var c=a[o],u=e(c);l.call(s,u)?s[u]++:(s[u]=1,r&&c instanceof i&&c.on("change",this._onItemChange,this))}}else this._inner=[]},_onItemChange:function(e){this._handleEvent(e)},get:function(e){return this._inner[e]},set:function(n,r){var a=this._inner,s=n in a,o=a[n];if(!s||!t(o,r)){var c,u,h=this._valueCount;if(s){var f=e(o);--h[f]||(delete h[f],this._handleItemChanges&&o instanceof i&&o.off("change",this._onItemChange),c=[o])}var d=e(r);l.call(h,d)?h[d]++:(h[d]=1,this._handleItemChanges&&r instanceof i&&r.on("change",this._onItemChange,this),u=[r]),a[n]=r,this.emit("change",{diff:{$removedValues:c||[],$addedValues:u||[]}})}return this},"delete":function(){for(var t=this._inner,n=this._valueCount,r=this._handleItemChanges,a=!1,s=[],l=0,o=arguments.length;o>l;l++){var c=arguments[l];if(c in t){a=!0;var u=t[c],h=e(u);--n[h]||(delete n[h],r&&u instanceof i&&u.off("change",this._onItemChange),s.push(u)),delete t[c]}}return a&&this.emit("change",{diff:{$removedValues:s,$addedValues:[]}}),this},get length(){return this._inner.length},set length(t){var n=this._inner,r=n.length;if(r!=t){var a=!1,s=[];if(r>t){var l=this._valueCount,o=this._handleItemChanges,c=t;do if(c in n){a=!0;var u=n[c],h=e(u);--l[h]||(delete l[h],o&&u instanceof i&&u.off("change",this._onItemChange),s.push(u))}while(++c<r)}n.length=t,a&&this.emit("change",{diff:{$removedValues:s,$addedValues:[]}})}},contains:function(t){return l.call(this._valueCount,e(t))},indexOf:function(e,t){return this._inner.indexOf(e,t)},lastIndexOf:function(e,t){return this._inner.lastIndexOf(e,t)},push:function(){return arguments.length?(s.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:this._addValues(arguments)}}),this._inner.length):this._inner.length},pushUnique:function(){var t=this._valueCount;return this.push.apply(this,d.call(arguments,function(n,i){return l.call(t,e(i))||-1!=n.indexOf(i)||n.push(i),n},[]))},shift:function(){var e=this._inner;if(e.length){if(n(this._valueCount))return void e.length--;var t,i="0"in e;return i?t=e.shift():e.length--,this.emit("change",{diff:{$removedValues:i?this._removeValue(t):[],$addedValues:[]}}),t}},unshift:function(){return arguments.length?(o.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:this._addValues(arguments)}}),this._inner.length):this._inner.length},pop:function(){var e=this._inner;if(e.length){if(!(e.length-1 in e))return void e.length--;var t=e.pop();return this.emit("change",{diff:{$removedValues:this._removeValue(t),$addedValues:[]}}),t}},_addValues:function(t){for(var n=this._valueCount,r=this._handleItemChanges,a=[],s=0,o=t.length;o>s;s++){var c=t[s],u=e(c);l.call(n,u)?n[u]++:(n[u]=1,r&&c instanceof i&&c.on("change",this._onItemChange,this),a.push(c))}return a},_removeValue:function(t){var n=e(t);return--this._valueCount[n]?[]:(delete this._valueCount[n],this._handleItemChanges&&t instanceof i&&t.off("change",this._onItemChange),[t])},join:function(e){return this._inner.join(e)},concat:function(){return new this.constructor(c.apply(this._inner,f.call(arguments,function(e){return e instanceof p?e._inner:e})))},slice:function(e,t){return this._inner.slice(e,t)},splice:function(n){var r=this._inner,a=h.apply(r,arguments),s=u.call(arguments,2),o=a.length,c=s.length;if(!o&&!c)return a;for(var f=this._valueCount,d=this._handleItemChanges,p=!1,v={},g=[],_=0,m=Math.max(o,c);m>_;_++){var b=_ in a,y=_ in s;if(b||y){var C=a[_],w=s[_];if(!b||!y||!t(C,w)){if(p=!0,b){var j=e(C);--f[j]||(delete f[j],d&&C instanceof i&&C.off("change",this._onItemChange),v[j]=C)}if(y){var x=e(w);l.call(f,x)?f[x]++:(f[x]=1,d&&w instanceof i&&w.on("change",this._onItemChange,this),l.call(v,x)?delete v[x]:g.push(w))}}}}if(!p&&o>c)for(var _=n+c,m=r.length;m>_;_++)if(_ in r){p=!0;break}if(p){var O=[];for(var E in v)O.push(v[E]);this.emit("change",{diff:{$removedValues:O,$addedValues:g}})}return a},forEach:null,map:null,filter:null,every:null,some:null,reduce:null,reduceRight:null,clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toArray:function(){return this._inner.slice(0)},toString:function(){return this._inner.toString()},collectDumpObject:function(e,t){for(var n=this._inner,i=n.length;i;)--i in n&&(e[i]=n[i]);this._handleItemChanges&&(t.handleItemChanges=!0)},expandFromDumpObject:function(e){for(var t in e)this.set(t,e[t])},dispose:function(){if(this._handleItemChanges)for(var e=this._inner,t=e.length;t;)--t in e&&e[t]instanceof i&&e[t].off("change",this._onItemChange)}});["forEach","map","filter","every","some","reduce","reduceRight"].forEach(function(e){this[e]=function(){return r[e].apply(this._inner,arguments)}},p.prototype),a.ActiveArray=p}(),function(){function i(e){var t=y.last,n=e._maxParentDepth;if(t)for(;;){if(n==t.maxParentDepth){var i=u(e);return l.call(t.dataCells,i)?!1:(t.dataCells[i]=e,t.count++,!0)}if(n>t.maxParentDepth){var r=t.next;return(t.next=(r||y)[r?"prev":"last"]=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:t,next:r}).dataCells[u(e)]=e,!0}if(!t.prev)return(t.prev=y.first=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:null,next:t}).dataCells[u(e)]=e,!0;t=t.prev}return(y.first=y.last=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:null,next:null}).dataCells[u(e)]=e,!0}function r(e){var t=y[e._maxParentDepth];if(t){var n=u(e);if(l.call(t.dataCells,n)){if(--t.count)delete t.dataCells[n];else{var i=t.prev,r=t.next;i?i.next=r:y.first=r,r?r.prev=i:y.last=i,delete y[e._maxParentDepth]}return!0}}return!1}function s(){_=v;do for(var e in m){var t=m[e],n=t.dataCell,r=n._children;for(var a in r)i(r[a]);if(delete m[e],b--,n._fixedValue=n._value,n._changed=!0,n._handleEvent(t.event),_!=v)return}while(b)}function o(){if(_==p){if(!b)return;if(s(),_!=v)return}else if(_==v){if(b&&(s(),_!=v))return}else if(s(),_!=v)return;_=g;for(var e;e=y.first;){var t=e.dataCells;for(var n in t){var i=t[n];if(i._recalc(),_!=g)return;if(--e.count)delete t[n];else{var r=e.prev,a=e.next;r?r.next=a:y.first=a,a?a.prev=r:y.last=r,delete y[i._maxParentDepth]}if(b){if(s(),_!=v)return;_=g;break}}}_=p,C={}}function c(e,t,n,i){n||(n=new f("change"),n.target=e,n.timestamp=Date.now(),t&&(n.detail={diff:t}));var r=u(e);if(b){if(l.call(m,r)){var a=m[r];return(n.detail||(n.detail={})).prevEvent=a.event,a.event=n,void(i===!1&&(a.cancellable=!1))}}else _==p&&h(o);m[r]={dataCell:e,event:n,cancellable:i!==!1},b++}var u=a.object.getUID,h=a.process.nextTick,f=a.Event,d=a.EventEmitter,p=0,v=1,g=2,_=p,m={},b=0,y=Object.assign(Object.create(null),{first:null,last:null}),C={},w=[],j=d.extend({initialValue:e,_value:e,_fixedValue:e,_formula:null,_get:null,_set:null,_parents:null,_children:null,_maxParentDepth:0,_lastErrorEvent:null,computable:!1,_changed:!1,get changed(){return b&&o(),this._changed},disposed:!1,_onChange:null,get onchange(){return this._onChange},set onchange(e){b&&o(),this._onChange=e},_onError:null,get onerror(){return this._onError},set onerror(e){b&&o(),this._onError=e},constructor:function(t,n){if(d.call(this),n||(n={}),n.get&&(this._get=n.get),n.set&&(this._set=n.set),n.onchange&&(this._onChange=n.onchange.bind(this)),n.onerror&&(this._onError=n.onerror.bind(this)),this._children={},"function"==typeof t&&(n.computable!==e?n.computable:t.constructor==Function)&&(this.computable=!0),this.computable){this._formula=t,w.unshift({});try{this._value=this._fixedValue=this._formula()}catch(i){this._handleError(i)}var r=this._parents=w.shift(),a=1;for(var s in r){var l=r[s];l._children[u(this)]=this,a<=l._maxParentDepth&&(a=l._maxParentDepth+1)}this._maxParentDepth=a}else this.initialValue=this._value=this._fixedValue=t,t instanceof d&&t.on("change",this._onValueChange,this)},get value(){return w.length&&(w[0][u(this)]=this),(b||_==v)&&o(),this._get?this._get(this._value):this._value},set value(i){if(this.computable){if(!this._set)throw new TypeError("Cannot write to read-only dataÐ¡ell");this._set(i)}else{var r=this._value;if(this._set){var a={};r instanceof d&&r.off("change",this._onValueChange,this),this._set(i,a),i=this._value,i instanceof d&&i.on("change",this._onValueChange,this),t(r,i)?n(a)||c(this,{value:a},e,i!==this._fixedValue):(a.type="update",a.oldValue=r,a.value=i,c(this,{value:a}))}else if(!t(r,i)){if(this._value=i,t(i,this._fixedValue)){var s=u(this);if(m[s].cancellable)return delete m[s],void b--}r instanceof d&&r.off("change",this._onValueChange,this),i instanceof d&&i.on("change",this._onValueChange,this),c(this,{value:{type:"update",oldValue:r,value:i}})}}},_onValueChange:function(t){c(this,e,t,this._value!==this._fixedValue)},_recalc:function(){var e=u(this);if(l.call(C,e)){if(10==++C[e])return void this._handleError(new RangeError("Circular dependency detected"))}else C[e]=1;var n,r=this._value,a=this._parents;w.unshift({});try{var s=this._formula()}catch(o){n=o}if(_!=g)return void w.shift();var h=this._parents=w.shift(),f=1;for(var d in a)l.call(h,d)||delete a[d]._children[e];for(var d in h){var p=h[d];l.call(a,d)||(p._children[e]=this),f<=p._maxParentDepth&&(f=p._maxParentDepth+1)}if(this._maxParentDepth!=f){if(this._maxParentDepth<f)return this._maxParentDepth=f,void i(this);this._maxParentDepth=f}n?this._handleError(n):t(r,s)||(this._value=s,c(this,{value:{type:"update",oldValue:r,value:s}}))},_handleError:function(e){this._logError(e);var t=this.emit("error",{error:e});this._handleErrorEvent(t)},_handleErrorEvent:function(e){if(this._lastErrorEvent!==e){this._lastErrorEvent=e,e.target!=this&&this._handleEvent(e);var t=this._children;for(var n in t){if(e.isPropagationStopped)break;t[n]._handleErrorEvent(e)}}},on:function(){b&&o(),j.$super.on.apply(this,arguments)},off:function(){b&&o(),j.$super.off.apply(this,arguments)},dispose:function(){if(!this.disposed){var e=u(this);if(e in m&&(delete m[e],b--),r(this),this.computable){var t=this._parents;for(var n in t)delete t[n]._children[e]}else this._value instanceof d&&this._value.off("change",this._onValueChange,this);var i=this._children;for(var a in i)i[a].dispose();this.disposed=!0}}});a.DataCell=j}(),function(){function e(e){return Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t),r=n.value;if("function"==typeof r&&r.constructor==i){var a=n;n={configurable:!0,enumerable:a.enumerable,get:function(){return a.value=Object.defineProperty(r.bind(this),"constructor",{configurable:!0,writable:!0,value:i}),Object.defineProperty(this,t,a),this[t]}},Object.defineProperty(e,t,n)}}),e}function t(e){var t=e._dataCells;if(t){for(var n in t)t[n].dispose();e._dataCells=null}}function n(e,t,n,r,a){var o=(this._dataCells||(this._dataCells=Object.create(null)))[t];if(!o){if("function"==typeof n)n=n.bind(this);else if(n===Object(n))if("function"==typeof n.clone)n=n.clone();else if(Array.isArray(n))n=n.slice(0);else{var c=new n.constructor(n);n=c!=n?c:s(n)}if(r){var u=this;r=["get","set","onchange","onerror"].reduce(function(e,t){return r[t]&&(e[t]=r[t].bind(u)),e},{})}o=this._dataCells[t]=new l(n,r)}switch(a.length){case 0:return o.value;case 1:o.value=a[0];break;default:var h=a[0];return a[0]=o,i.prototype[h].apply(this,a)}return this}function i(e,t){function a(){return n.call(this,a,s,e,t,arguments)}var s=r(a);return Object.defineProperty(a,"constructor",{configurable:!0,writable:!0,value:i}),a}var r=a.object.getUID,s=a.object.clone,l=a.DataCell;i.autoBind=e,i.disposeDataCells=t,Object.assign(i.prototype,{dataCell:function(e){return e},subscribe:function(e,t,n){return e.on("change",t,n||this),this},unsubscribe:function(e,t,n){return e.off("change",t,n||this),this}}),a.ActiveProperty=i,a.observable=function(e,t){return"function"==typeof e&&e.constructor==Function&&(t||(t={}),t.computable=!1),new i(e,t)},a.computable=function(e,t){return e.constructor!=Function&&(t||(t={}),t.computable=!0),new i(e,t)}}(),function(){function t(e){return function t(n,i,r,a,s){if(Array.isArray(n)||n instanceof h)for(var l=n.length;l;)t.call(this,n[--l],i,r,a,s);else if("object"==typeof i){s=a,a=r;var o=i;for(i in o)t.call(this,n,i,o[i],a,s)}else if(Array.isArray(r))for(var c=r,l=0,u=c.length;u>l;l++)t.call(this,n,i,c[l],a,s);else if("object"==typeof r){var f=r;for(var d in f)t.call(this,n[d]("dataCell",0),i,f[d],a,s)}else e.call(this,n,i,r,a,s);return this}}function n(e){e.target instanceof s?e.target.off(e.type,e.listener,e.context):e.target.removeEventListener(e.type,e.listener,!1)}var i=a.object.getUID,r=a.value.getHash,s=a.EventEmitter,o=a.ActiveProperty,c=a.ActiveProperty.autoBind,u=a.ActiveProperty.disposeDataCells,d=s.extend({_listening:null,_callbacks:null,_timeouts:null,_dataCells:null,constructor:function(){if(s.call(this),!this.constructor._isActivePropertiesBound){var e=this.constructor;do c(e.prototype),e._isActivePropertiesBound=!0,e=e.$super.constructor;while(e!=d&&!e._isActivePropertiesBound)}},listen:t(function(e,t,n,i,r){this._listen(e,t,n,i,r)}),_listen:function(t,n,a,o,c){o||(o=this);var u=this._listening||(this._listening={}),h=i(t)+"-"+n+"-"+i(l.call(a,f)?a[f]:a)+"-"+i(o)+"-"+(c!==e?r(c):"");if(!l.call(u,h)){if(t instanceof s)t.on(n,a,o);else{if("function"!=typeof t.addEventListener)throw new TypeError("Unable to add a listener");t!=o&&(a=a.bind(o)),t.addEventListener(n,a,!1)}u[h]={target:t,type:n,listener:a,context:o,meta:c}}},stopListening:t(function(e,t,n,i,r){this._stopListening(e,t,n,i,r)}),_stopListening:function(t,a,s,o,c){var u=this._listening;if(u){o||(o=this);var h=i(t)+"-"+a+"-"+i(l.call(s,f)?s[f]:s)+"-"+i(o)+"-"+(c!==e?r(c):"");l.call(u,h)&&(n(u[h]),delete u[h])}},stopAllListening:function(){var e=this._listening;if(e)for(var t in e)n(e[t]),delete e[t];return this},regCallback:function(e){function t(){l.call(t,"canceled")&&t.canceled||(delete n[r],e.apply(a,arguments))}var n=this._callbacks||(this._callbacks={}),r=i(e);l.call(n,r)&&(n[r].canceled=!0);var a=this;return n[r]=t,t},cancelCallback:function(e){var t=this._callbacks;if(t){var n=i(e);l.call(t,n)&&(t[n].canceled=!0,delete t[n])}return this},cancelAllCallbacks:function(){var e=this._callbacks;if(e)for(var t in e)e[t].canceled=!0,delete e[t];return this},setTimeout:function(e,t){var n=this._timeouts||(this._timeouts={}),r=i(e);l.call(n,r)&&clearTimeout(n[r]);var a=this;return n[r]=setTimeout(function(){delete n[r],e.call(a)},t),this},clearTimeout:function(e){var t=this._timeouts;if(t){var n=i(e);l.call(t,n)&&(clearTimeout(t[n]),delete t[n])}return this},clearAllTimeouts:function(){var e=this._timeouts;if(e)for(var t in e)clearTimeout(e[t]),delete e[t];return this},collectDumpObject:function(e){Object.keys(this).forEach(function(t){var n=Object.getOwnPropertyDescriptor(this,t).value;if("function"==typeof n&&n.constructor==o){var i=n("dataCell",0);if(!i.computable){var r=i.value;(r===Object(r)?i.changed:i.initialValue!==r)&&(e[t]=r)}}},this)},expandFromDumpObject:function(e){for(var t in e)this[t](e[t])},clean:function(){this.stopAllListening().cancelAllCallbacks().clearAllTimeouts(),u(this)},dispose:function(){this.clean()}});a.Cleanable=d}(),function(){var e=a.Cleanable,t=e.extend({_options:null,constructor:function(t,n){e.call(this),this._options=n||{},t&&this.setData(t)},setData:function(e){for(var t in e)t in this&&this[t](e[t])},collectDumpObject:function(e,n){t.$super.collectDumpObject.call(this,e),Object.assign(n,this._options)}});a.BaseModel=t}(),function(){function e(e){return e.replace(t,"&amp;").replace(n,"&lt;").replace(i,"&gt;").replace(r,"&quot;")}var t=/&/g,n=/</g,i=/>/g,r=/"/g;a.html={escape:e}}(),function(){function e(e,t){for(var n in t){var i=t[n];null!=i&&i!==!1&&e.push("__"+n+(i===!0?"":"_"+i))}return e}a.mods={push:e}}(),function(){function e(e,t){e=i(e),t?(t.parent=this,t.block=null):t={parent:this,block:null};var r=this._childRenderings,a=r.count++,s=r.marks[a]="{{_"+n()+"}}";return new e(t).render(function(e){r.results[a]=e,r.count==++r.readyCount&&r.onallready&&r.onallready()}),s}function t(e,t,n){if(e)if(e instanceof r?e=e.toObject():e instanceof s&&(e=e.toArray()),Array.isArray(e))for(var i=0,a=e.length;a>i;i++)i in e&&t.call(n,e[i],i);else for(var o in e)l.call(e,o)&&t.call(n,e[o],o)}var n=a.uid.next,i=a.Class.getOrError,r=a.ActiveDictionary,s=a.ActiveArray;a.template={defaults:{include:e,each:t}}}(),function(){function e(e,t,n){if(l.call(e,f))return e[f];var r=e[f]={};if(e.hasAttribute("rt-bind")){var a=!n||n.applyValues!==!1;s(h,e.getAttribute("rt-bind"),function(n,s,l,u){var h=new o(Function("return "+u+";").bind(t),{onchange:function(){c[s](e,this.value,l)}});r[i(h)]=h,a&&c[s](e,h.value,l)})}return r}function t(e){if(l.call(e,f)){var t=e[f];if(t){for(var n in t)t[n].dispose();delete e[f]}}}function n(t,n,i){i||(i={});var r=i.removeAttr===!0,a={applyValues:i.applyValues!==!1},s={};i.bindRootElement!==!1&&t.hasAttribute("rt-bind")&&(Object.assign(s,e(t,n,a)),r&&t.removeAttribute("rt-bind"));for(var l=t.querySelectorAll("[rt-bind]"),o=0,c=l.length;c>o;o++)Object.assign(s,e(l[o],n,a)),r&&t.removeAttribute("rt-bind");return s}var i=a.object.getUID,r=a.namespace.create,s=a.regex.forEach,o=a.DataCell,c={html:function(e,t){e.innerHTML=t},text:function(e,t,n){switch(n){case"first":var i=e.firstChild;i&&3==i.nodeType?i.nodeValue=t:e.insertBefore(document.createTextNode(t),i);break;case"last":var i=e.lastChild;i&&3==i.nodeType?i.nodeValue=t:e.appendChild(document.createTextNode(t));break;case"prev":var i=e.previousSibling;i&&3==i.nodeType?i.nodeValue=t:e.parentNode.insertBefore(document.createTextNode(t),e);break;case"next":var i=e.nextSibling;i&&3==i.nodeType?i.nodeValue=t:e.parentNode.insertBefore(document.createTextNode(t),i);break;default:if(1==e.childNodes.length&&3==e.firstChild.nodeType)e.firstChild.nodeValue=t;else{for(;e.lastChild;)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(t))}}},prop:function(e,t,n){n=n.split(".");var i=n.pop();r(n,e)[i]=t},attr:function(e,t,n){e.setAttribute(n,t)},value:function(e,t){e.value!=t&&(e.value=t)},css:function(e,t,n){e.style[n||"cssText"]=t},show:function(e,t){e.style.display=t?"":"none"}},u="[$_a-zA-Z][$\\w]*",h=RegExp("("+u+")(?:\\(([^)]*)\\))?:\\s*(\\S[\\s\\S]*?)(?=\\s*(?:,\\s*"+u+"(?:\\([^)]*\\))?:\\s*\\S|$))","g"),f="_rt-dataCells";a.domBinding={helpers:c,bindElement:e,unbindElement:t,bind:n}}(),function(){function t(e,t){if(e._receiveData!=i){if(e._beforeDataReceiving!=i)try{e._beforeDataReceiving()}catch(n){e._logError(n)}try{e._receiveData.length?e._receiveData(function(n){null!=n&&(e.dataReceivingError=n,e._logError(n)),r(e),t.call(e)}):e._receiveData()["catch"](function(t){e.dataReceivingError=t,e._logError(t)}).then(function(){r(e),t.call(e)})}catch(n){e.dataReceivingError=n,e._logError(n),r(e),t.call(e)}}else t.call(e)}function r(e){if(e._afterDataReceiving!=i)try{e._afterDataReceiving()}catch(t){e._logError(t)}}function s(e){y(function(){var t=E(e.block[0],e,{bindRootElement:!0,applyValues:!0,removeAttr:!0});if(e._dataCells?Object.assign(e._dataCells,t):e._dataCells=t,e._initClient!=i)if(e._initClient.length)try{e._initClient(function(t){return null!=t?void d(e,t):void u(e)})}catch(n){d(e,n)}else{var r;try{r=e._initClient()}catch(n){return void d(e,n)}r?r.then(function(){u(e)},function(t){d(e,t)}):u(e)}else u(e)})}function u(e){if(e._bindEvents!=i)try{e._bindEvents()}catch(t){return void d(e,t)}e.emit("clientinited")}function d(e,t){e._logError(t),e.emit("clientiniterror",{error:t})}function p(e,t){for(var n in t)e.setAttribute(n,t[n])}function v(t,n){if(l.call(n,S)&&n[S]&&n[V]==t){n[V]=null,n[S]=e;var i=t.elements[n[S]];i.splice(i.indexOf(n),1),n.parentNode&&n.parentNode.removeChild(n)}}var g=a.object.getUID,_=a.namespace.exec,m=a.value.getHash,b=a.value.toString,y=a.process.nextTick,C=a.Class.classes,w=a.Class.getOrError,j=a.Cleanable,x=a.html.escape,O=a.mods.push,E=a.domBinding.bind,k=Object.assign(Object.create(null),{area:1,base:1,basefont:1,br:1,col:1,command:1,embed:1,frame:1,hr:1,img:1,input:1,isindex:1,keygen:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,circle:1,ellipse:1,line:1,path:1,polygone:1,polyline:1,rect:1,stop:1,use:1}),P=/^(.+?):(.+)$/,D=/([^,]*),([^,]*),(.*)/,V="_rt-view",S="_rt-viewElementName",I=j.extend({_options:null,_id:e,app:null,model:null,name:e,tagName:"div",blockName:e,mods:null,attrs:null,_parent:null,get parent(){return this._parent},set parent(e){e?e.regChild(this):this._parent&&this._parent.unregChild(this)},children:null,block:null,elements:null,_receiveData:i,_beforeDataReceiving:i,_afterDataReceiving:i,dataReceivingError:null,_currentlyRendering:!1,_childRenderings:null,template:function(){return""},_initClient:i,_bindEvents:i,onlyClient:!1,onclientinited:null,onclientiniterror:null,constructor:function(n){if(j.call(this),n||(n={}),this._options=n,this.mods=Object.create(this.mods),this.attrs=Object.create(this.attrs),this.children=[],this.elements={},!this.blockName){for(var i=this.constructor;i.$super.constructor!=I;)i=i.$super.constructor;i.prototype.blockName=i.__class}var r;if(c){if(n.block)throw new TypeError('Option "block" can\'t be used on the server side');r=null,null===n.block&&delete n.block}else n.block!==e&&(r=n.block,delete n.block);if(null===r)this._id=g(this,c?"s":"c"),this._parseOptions();else{var a,o=!1;if(r){if(r instanceof h&&(r=r[0]),l.call(r,V)&&r[V])throw new TypeError("Element is already used as "+(l.call(r,S)&&r[S]?"an element":"a block")+" of view");r.hasAttribute("rt-d")&&(a=r.getAttribute("rt-d").match(D),a[2]&&(o=!0),a[3]&&Object.assign(n,Function("return {"+a[3]+"};")()))}if(this._id=o?a[2]:g(this,"c"),this._parseOptions(),r||(r=document.createElement(this.tagName)),this.block=h(r),r[V]=this,o){var u=this;this.block.find("[rt-p="+this._id+"]").each(function(){new(C[this.getAttribute("rt-d").match(D)[1]])({parent:u,block:this})
}),s(this)}else p(r,this.attrs),r.className=(O([this.blockName],this.mods).join(" ")+" "+r.className).trim(),this._currentlyRendering=!0,t(this,function(){this._renderInner(function(e){this._currentlyRendering=!0,r.innerHTML=e;for(var t=r.querySelectorAll("[rt-p]"),n={},i=t.length;i;)n[t[--i].getAttribute("rt-d").match(D)[2]]=t[i];!function a(e){for(var t=e.children,i=0,r=t.length;r>i;i++){var l=t[i],o=n[l._id];l.block=h(o),o[V]=l,a(l)}s(e)}(this)})})}},_parseOptions:function(){var t=this._options;t.name&&(this.name=t.name),t.tagName&&(this.tagName=t.tagName,delete t.tagName),t.blockName&&(this.blockName=t.blockName),t.mods&&(Object.assign(this.mods,t.mods),delete t.mods),t.attrs&&(Object.assign(this.attrs,t.attrs),delete t.attrs),t.parent&&(this.parent=t.parent,delete t.parent),t.app&&(this.app=t.app,delete t.app,this.model=this.app.model);var n=t.model;if(n)"string"==typeof n?this.model=_(n,this._parent||this):(this.model=n,delete t.model);else{var i=this._parent;i&&i.model&&(this.model=i.model)}t.onlyClient!==e&&(this.onlyClient=t.onlyClient)},render:function(e){if(this._currentlyRendering)throw new TypeError("Cannot run the rendering when it is in process");return c&&this.onlyClient?void e(this._renderOpenTag(!0)+(this.tagName in k?"":"</"+this.tagName+">")):(this._currentlyRendering=!0,void t(this,function(){this.tagName in k?(this._currentlyRendering=!1,e(this._renderOpenTag(!1))):this._renderInner(function(t){this._currentlyRendering=!1,e(this._renderOpenTag(!1)+t+"</"+this.tagName+">")})}))},_renderOpenTag:function(e){var t;if(e)t="";else{var i=this.attrs;t=['class="'+(O([this.blockName],this.mods).join(" ")+" "+(i["class"]||"")).trim()+'"'];for(var r in i)"class"!=r&&t.push(r+'="'+i[r]+'"')}return"<"+this.tagName+" "+t.join(" ")+' rt-d="'+[this.constructor.__class,e?"":this._id,n(this._options)?"":x(b(this._options).slice(1,-1))]+'"'+(this._parent?' rt-p="'+this._parent._id+'"':"")+">"},_renderInner:function(e){var t,n=this._childRenderings={count:0,readyCount:0,marks:[],results:[],onallready:null};try{t=this.template.call(this)}catch(i){return this._childRenderings=null,this._logError(i),void e.call(this,"")}var r=this;n.onallready=function(){r._childRenderings=null;for(var i=n.marks,a=n.results,s=i.length;s;)t=t.replace(i[--s],function(){return a[s]});e.call(r,t)},n.count==n.readyCount&&n.onallready()},regChild:function(e){if(e._parent){if(e._parent==this)return this;throw new TypeError("View is already used as a child of view")}e._parent=this;var t=this.children,n=e.name;return t.push(e),n&&(l.call(t,n)?t[n]:t[n]=[]).push(e),this},unregChild:function(e){if(e._parent!==this)return this;e._parent=null;var t=this.children,n=e.name;if(t.splice(t.indexOf(e),1),n){var i=t[n];i.splice(i.indexOf(e),1)}return this},$:function(e){var t;l.call(this.elements,e)?t=this.elements[e]:(t=h("."+this.blockName+"_"+e,this.block),this._checkDescendantElements(this.blockName,e)&&(t=t.filter(function(){return!l.call(this,V)||!this[V]})),this.elements[e]=t);var n=arguments.length;if(n>1){var i=1;do{var r=arguments[i],a="string"==typeof r;if(a||r instanceof HTMLElement){if(a){var s=document.createElement("div");s.innerHTML=r,r=1==s.childNodes.length&&1==s.firstChild.nodeType?s.firstChild:s}else if(l.call(r,V)&&r[V]){if(!l.call(r,S)||!r[S])throw new TypeError("Element is already used as a block of view");if(r[V]!=this||r[S]!=e)throw new TypeError("Element is already used as an element of view");continue}r.className=(this.blockName+"_"+e+" "+r.className).trim()}else{var o=r;r=document.createElement(o.tagName||"div"),o.attrs&&p(r,o.attrs);var c=[this.blockName+"_"+e];o.mods&&O(c,o.mods),r.className=(c.join(" ")+" "+r.className).trim(),o.html&&(r.innerHTML=o.html)}r[V]=this,r[S]=e,t.push(r)}while(++i<n)}return t},$rm:function(){for(var e=arguments.length;e;){var t=arguments[--e];if("string"==typeof t){if(!l.call(this.elements,t))continue;t=this.elements[t]}if(t instanceof h){var n=this;t.each(function(){v(n,this)})}else v(this,t)}return this},_checkDescendantElements:function(e,t){for(var n=this.children,i=!1,r=n.length;r;){var a=n[--r];a.blockName==e?(a.$(t),i=!0):a._checkDescendantElements(e,t)&&(i=!0)}return i},broadcast:function(e,t){var n,i;if(P.test(e)?(n=RegExp.$1,i=RegExp.$2):(n=e,i="*"),"*"==n)e=this.children;else{if(!l.call(this.children,n))return[];e=this.children[n]}"*"==i?e=e.slice(0):(i=w(i),e=e.filter(function(e){return e instanceof i}));var r=o.call(arguments,2);return e.map(function(e){return e[t].apply(e,r)})},_listen:function(e,t,n,i,r){var a,s;if(e instanceof I)if(P.test(t)){if(a=RegExp.$1,s=RegExp.$2,"*"!=s){s=w(s);var l=n,o=function(e){return e.target instanceof s?l.call(this,e):void 0};o[f]=l,n=o}}else{a=t;var c=this,l=n,o=function(e){return e.target==c?l.call(this,e):void 0};o[f]=l,n=o}else a=t;I.$super._listen.call(this,e,a,n,i,(s?"*"===s?"":g(s):"0")+m(r))},_stopListening:function(e,t,n,i,r){var a,s;e instanceof I&&P.test(t)?(a=RegExp.$1,s=RegExp.$2,"*"!=s&&(s=w(s))):a=t,I.$super._stopListening.call(this,e,a,n,i,(s?"*"===s?"":g(s):"0")+m(r))},dispose:function(){var e=this.block[0];e.parentNode&&e.parentNode.removeChild(e);for(var t=this.children,n=t.length;n;)t[--n].dispose();if(this._parent){var i=this._parent.children;if(i.splice(i.indexOf(this),1),this.name){var r=i[this.name];r.splice(r.indexOf(this),1)}}e[V]=null,I.$super.dispose.call(this)}});a.BaseView=I}(),function(){var e=a.dump.serialize,t=a.dump.deserialize,n=a.ActiveProperty,i=a.Cleanable,r=i.extend("Rift.ViewState",{properties:null,constructor:function(e){i.call(this),this.properties=Object.keys(e);for(var t in e)this[t]="function"==typeof e[t]?e[t]:new n(e[t])},serializeData:function(){for(var t=this.properties,n={},i=t.length;i;){var r=this[t[--i]]("dataCell",0);if(!r.computable){var a=r.value;(a===Object(a)?r.changed:r.initialValue!==a)&&(n[t[i]]=e({v:a}))}}return n},updateFromSerializedData:function(e){var n={};for(var i in e)n[i]=t(e[i]).v;return this.update(n),this},update:function(e){for(var t=this.properties,n=t.length;n;){var i=t[--n];this[i](l.call(e,i)?e[i]:this[i]("dataCell",0).initialValue)}return this}});a.ViewState=r}(),function(){function t(e){if(""!=e){if("NaN"==e)return 0/0;var t=Number(e);if(t==t)return t}return e}function n(e){e=e.split("/");for(var t=e.length;t;)e[--t]=encodeURIComponent(decodeURIComponent(e[t]));return e.join("/")}function i(e){return"/"!=e[0]&&(e="/"+e),"/"!=e[e.length-1]&&(e+="/"),e}function r(e,t,n,i,r){if(e.currentRoute=t,e.currentPath=n,u)if(r)history[1==r?"pushState":"replaceState"]({"_rt-state":{routeIndex:e.routes.indexOf(t),path:n,viewStateData:i}},null,n);else{var a=history.state||{};a["_rt-state"]={routeIndex:e.routes.indexOf(t),path:n,viewStateData:i},history.replaceState(a,null,n)}if(t.callback){e._isHistoryPositionFrozen=!0;try{t.callback.call(e.app,n)}catch(s){o(s)}finally{e._isHistoryPositionFrozen=!1}}}function s(e,t){this._onViewStateChange=this._onViewStateChange.bind(this),this.app=e,this.routes=[],t&&this.addRoutes(t)}var o=a.logError,c=a.regex.escape,h=a.process.nextTick,f=/^(?:\w+:)?\/\//,d=/[\/\\]+/g,p=/\{([^}]+)\}/g,v=/\((?:\?(\S+)\s+)?([^)]+)\)/g;Object.assign(s.prototype,{app:null,viewBlock:null,routes:null,currentRoute:null,currentPath:e,started:!1,_isViewStateChangeHandlingRequired:!1,_isHistoryPositionFrozen:!1,addRoutes:function(e){return e.forEach(function(e){"string"==typeof e&&(e={path:e}),this.addRoute(e.path,e.callback)},this),this},addRoute:function(e,t){if(this.started)throw new TypeError("Router is already started");e=e.split(v);for(var i=[],r=[],a=[],s=[],l=0,o=e.length;o>l;)if(l%3){i.push("(");var u=[];e[l]&&(u.push(e[l]),r.push({type:1,id:e[l]}));for(var h=e[l+1].split(p),f=0,d=h.length;d>f;f++)if(f%2){var g=h[f];u.push(g),i.push("([^\\/]+)"),r.push({type:2,id:g}),s.push({requiredProperties:u,prop:g})}else if(h[f]){var _=n(h[f]);i.push(c(_).split("\\*").join(".*?")),s.push({requiredProperties:u,pathPart:_.split("*").join("")})}i.push(")?"),l+=2}else{if(e[l])for(var h=e[l].split(p),f=0,d=h.length;d>f;f++)if(f%2){var g=h[f];i.push("([^\\/]+)"),r.push({type:0,id:g}),a.push(g),s.push({requiredProperties:[g],prop:g})}else if(h[f]){var _=n(h[f]);i.push(c(_).split("\\*").join(".*?")),s.push({requiredProperties:[],pathPart:_.split("*").join("")})}l++}return this.routes.push({rePath:RegExp("^\\/?"+i.join("")+"\\/?$"),properties:r,requiredProperties:a,pathMap:s,callback:t}),this},start:function(){if(this.started)return this;this.started=!0,u&&(this.viewBlock=this.app.view.block[0]),this.viewState=this.app.viewState,this._bindEvents();var e=this._tryViewState();return e?r(this,e.route,e.path,this.app.viewState.serializeData()):u&&history.replaceState(history.state||{},null,"/"),this},_bindEvents:function(){u&&(window.addEventListener("popstate",this._onWindowPopState.bind(this),!1),this.viewBlock.addEventListener("click",this._onViewBlockClick.bind(this),!1));for(var e=this.app.viewState,t=this._onViewStatePropertyChange,n=e.properties,i=n.length;i;)e[n[--i]]("subscribe",t,this)},_onWindowPopState:function(){var t=history.state&&history.state["_rt-state"];if(t){var n=this.currentRoute=this.routes[t.routeIndex],i=this.currentPath=t.path;if(this.app.viewState.updateFromSerializedData(t.viewStateData),n.callback){this._isHistoryPositionFrozen=!0;try{n.callback.call(this.app,i)}catch(a){o(a)}finally{this._isHistoryPositionFrozen=!1}}}else{this.app.viewState.update({});var s=this._tryViewState();s?r(this,s.route,s.path,{}):(this.currentRoute=null,this.currentPath=e)}},_onViewBlockClick:function(e){for(var t=this.viewBlock,n=e.target;"A"!=n.tagName;){if(n==t)return;n=n.parentNode}var i=n.getAttribute("href");!f.test(i)&&this.route(i)&&e.preventDefault()},_onViewStatePropertyChange:function(){this._isViewStateChangeHandlingRequired||(this._isViewStateChangeHandlingRequired=!0,h(this._onViewStateChange))},_onViewStateChange:function(){if(this._isViewStateChangeHandlingRequired){this._isViewStateChangeHandlingRequired=!1;var e=this._tryViewState(this.currentRoute);if(e){var t=e.path;if(t===this.currentPath){if(u){var n=history.state||{};n["_rt-state"]||(n["_rt-state"]={routeIndex:this.routes.indexOf(this.currentRoute),path:t}),n["_rt-state"].viewStateData=this.app.viewState.serializeData(),history.replaceState(n,null,t)}}else r(this,e.route,t,this.app.viewState.serializeData(),1)}}},route:function(e){if(e=n(e.replace(d,"/")),"/"!=e[0]){var t=location.pathname;e=t+("/"==t[t.length-1]?"":"/")+e}if("/"!=e[e.length-1]&&(e+="/"),e===this.currentPath)return!0;var i=this._tryPath(e);return i?(this.app.viewState.update(i.state),r(this,i.route,e,this.app.viewState.serializeData(),!this._isHistoryPositionFrozen,2),!0):!1},_tryPath:function(n){for(var i=this.routes,r=0,a=i.length;a>r;r++){var s=i[r],l=n.match(s.rePath);if(l)return{route:s,state:s.properties.reduce(function(n,i,r){return n[i.id]=1==i.type?l[r+1]!==e:t(decodeURIComponent(l[r+1])),n},{})}}return null},_tryViewState:function(e){for(var t=this.app.viewState,n=this.routes,i=null,r=0,a=n.length;a>r;r++){for(var s=n[r],l=s.requiredProperties,o=l.length;o--;){var c=t[l[o]]();if(null==c||c===!1||""===c)break}if(-1==o){if(l.length){i=s;break}i&&s!==e||(i=s)}}return i&&{route:i,path:this._buildPath(i)}},_buildPath:function(e){for(var t=this.app.viewState,n=e.pathMap,r=[],a=0,s=n.length;s>a;a++){for(var o=n[a],c=o.requiredProperties,u=c.length;u--;){var h=t[c[u]]();if(null==h||h===!1||""===h)break}-1==u&&r.push(l.call(o,"pathPart")?o.pathPart:t[o.prop]())}return i(r.join(""))}}),a.Router=s}(),function(){function t(t,n){for(var i=Object.assign({},t),r=n.length;r;)for(var a=n[--r].properties,s=a.length;s;){var o=a[--s].id;l.call(i,o)||(i[o]=e)}return i}function n(){}var i=a.dump.deserialize,r=a.ViewState,s=a.Router;n.extend=a.Class.extend,Object.assign(n.prototype,{model:null,view:null,viewState:null,router:null,_init:function(e,n,a,l,o,u,h){this.model="function"==typeof e?new e:i(e);var f=this.router=new s(this,u);this.viewState=new r(t(l,f.routes)),c?f.route(h||"/"):this.viewState.updateFromSerializedData(o),this.view=new n({app:this,block:a}),f.start()}}),a.BaseApp=n}()}();