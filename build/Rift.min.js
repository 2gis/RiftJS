!function(t){"use strict";function e(t,e){return t===e||t!=t&&e!=e}function n(t){for(var e in t)return!1;return!0}function i(){}function r(t){console.error(t===Object(t)&&t.stack||t)}var a,s=Function("return this;")(),l=Object.prototype.hasOwnProperty,o=Array.prototype.slice;a="undefined"!=typeof exports?exports:s.Rift={},a.global=s;var c=a.isServer="undefined"==typeof window&&"undefined"==typeof navigator,u=a.isClient=!c;a.logError=r;var h;u&&(h=a.$=s.jQuery||s.Zepto||s.ender||s.$);var f="_rt-listeningInner";Object.assign||Object.defineProperty(Object,"assign",{configurable:!0,writable:!0,value:function(t,e){if(null==t)throw new TypeError("Can't convert "+t+" to an object");t=Object(t);for(var n=1,i=arguments.length;i>n;n++){if(e=arguments[n],null==e)throw new TypeError("Can't convert "+e+" to an object");e=Object(e);for(var r=Object.keys(e),a=0,s=r.length;s>a;a++)t[r[a]]=e[r[a]]}return t}}),function(){function e(e){return(e===t?"":e)+ ++i}function n(){i=0}var i=0;a.uid={next:e,resetCounter:n}}(),function(){function t(t,e){return l.call(t,o)||Object.defineProperty(t,o,{value:s(e)}),t[o]}function e(t){var e={},n=0;for(var i in t)e[i]=!0,n++;if(!n)return{};for(var r={};;){for(var i in e)l.call(t,i)&&(r[i]=Object.getOwnPropertyDescriptor(t,i),delete e[i],n--);if(!n)return r;t=Object.getPrototypeOf(t)}}function n(t){var n=e(t),i={};for(var r in n)l.call(n[r],"value")&&(i[r]=n[r].value);return i}function i(t,e,n){for(var i=Object[n?"keys":"getOwnPropertyNames"](e),r=i.length;r;)Object.defineProperty(t,i[--r],Object.getOwnPropertyDescriptor(e,i[r]));return t}function r(t){return i(Object.create(Object.getPrototypeOf(t)),t)}var s=a.uid.next,o="_rt-uid";a.object={getUID:t,getPropertyDescriptors:e,getDataPropertyValues:n,mixin:i,clone:r}}(),function(){function t(t,e){"string"==typeof t&&(t=t.split("."));for(var n=e||s,i=0,r=t.length;r>i;i++){var a=n[t[i]];if(a!==Object(a)){do n=n[t[i]]={};while(++i<r);break}n=a}return n}function e(t,e){return Function("return this."+t+";").call(e||s)}a.namespace={create:t,exec:e}}(),function(){function t(t){return t.replace(n,"\\$1")}function e(t,e,n){if(t.global){t.lastIndex=0;for(var i;(i=t.exec(e))&&n.apply(s,i)!==!1;);}else{var i=t.exec(e);i&&n.apply(s,i)}}var n=/([?+|$(){}[^.\-\]\/\\*])/g;a.regex={escape:t,forEach:e}}(),function(){function e(e){if(e===t)return"undefined";if(null===e)return"null";switch(typeof e){case"boolean":return"?"+e;case"number":return"+"+e;case"string":return";"+e}return"#"+r(e)}function n(t){return t.replace(s,function(t){return l.call(o,t)?o[t]:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})}function i(e){if(e===t)return"void 0";if(null===e)return"null";var r=typeof e;if("object"!=r)return"string"==r?"'"+n(e).replace(u,"</'+'$1>")+"'":String(e);var a=[];if(Array.isArray(e)){for(var s=e.length;s;)a.unshift(--s in e?i(e[s]):"");a="["+a+(""==a[a.length-1]?",]":"]")}else{for(var o in e)l.call(e,o)&&a.push((c.test(o)?o:"'"+n(o)+"'")+":"+i(e[o]));a="{"+a+"}"}return a.replace(u,"</'+'$1>")}var r=a.object.getUID,s=RegExp("[\\\\'\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]","g"),o={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"},c=/^[$_a-zA-Z][$\w]*$/,u=/<\/(script\b[^>]*)>/gi;a.value={getHash:e,toString:i}}(),function(){var t;if(s.process&&s.process.nextTick)t=s.process.nextTick;else if(s.setImmediate)t=function(t){setImmediate(t)};else if(s.postMessage&&!s.ActiveXObject){var e;s.addEventListener("message",function(){if(e){var t=e;e=null;for(var n=0,i=t.length;i>n;n++)try{t[n]()}catch(r){a.logError(r)}}},!1),t=function(t){e?e.push(t):(e=[t],s.postMessage("__tic__","*"))}}else t=function(t){setTimeout(t,1)};a.process={nextTick:t}}(),function(){function e(t){if(!l.call(s,t))throw new TypeError('Class "'+t+'" is not defined');return s[t]}function n(t,e){if(l.call(s,t))throw new TypeError('Class "'+t+'" is already registered');return Object.defineProperty(e,"__class",{value:t}),s[t]=e,e}function i(e,a){"object"==typeof e&&(a=e,e=t);var s,o=this;l.call(a,"constructor")?(s=a.constructor,delete a.constructor):s=function(){return o.apply(this,arguments)};var c=Object.create(o.prototype);return s.prototype=c,Object.defineProperty(s,"$super",{writable:!0,value:o.prototype}),Object.defineProperty(c,"constructor",{configurable:!0,writable:!0,value:s}),r(s,o,!0),l.call(a,"static")&&(r(s,a["static"]),delete a["static"]),s.extend||(s.extend=i),r(c,a),e&&n(e,s),s}var r=a.object.mixin,s={};a.Class={classes:s,getOrError:e,register:n,extend:i}}(),function(){function e(i,r){var a=s(i);if(l.call(r,a))return a;var o={},c={};if(l.call(i.constructor,"__class")?(i.collectDumpObject?i.collectDumpObject(o,c):Object.assign(o,i),r[a]={c:i.constructor.__class}):(Object.assign(o,i),r[a]={}),!n(o)){for(var u in o){var h=o[u];o[u]=h===Object(h)?e(h,r):h===t?{}:{v:h}}r[a].d=o}return n(c)||(r[a].o=c),a}function i(t){var n={};return o({s:n,r:e(t,n)})}function r(e){"string"==typeof e&&(e=Function("return "+e+";")());var n=e.s;for(var i in n){var r=n[i];if(l.call(r,"c")){var a=c[r.c];r.instance=l.call(r,"o")?new a(t,r.o):new a}else r.instance={}}for(var i in n){var r=n[i];if(l.call(r,"d")){var s=r.d;for(var o in s){var u=s[o];s[o]="object"==typeof u?l.call(u,"v")?u.v:t:n[u].instance}l.call(r,"c")&&r.instance.expandFromDumpObject?r.instance.expandFromDumpObject(s):Object.assign(r.instance,s)}}return n[e.r].instance}var s=a.object.getUID,o=a.value.toString,c=a.Class.classes,u=a.Class.register;u("Array",Array),u("Date",Date),Object.defineProperties(Date.prototype,{collectDumpObject:{configurable:!0,writable:!0,value:function(t){t.utc=this.toString()}},expandFromDumpObject:{configurable:!0,writable:!0,value:function(t){this.setTime(new Date(t.utc))}}}),a.dump={serialize:i,deserialize:r}}(),function(){function e(t,e){this.type=t,e&&(this.bubbles=!0)}e.extend=a.Class.extend,Object.assign(e.prototype,{target:null,timestamp:t,type:t,bubbles:!1,isPropagationStopped:!1,isImmediatePropagationStopped:!1,detail:null,stopPropagation:function(){this.isPropagationStopped=!0},stopImmediatePropagation:function(){this.isPropagationStopped=!0,this.isImmediatePropagationStopped=!0}}),a.Event=e}(),function(){function t(t){return function e(n,i,r){if("object"==typeof n){r=i;var a=n;for(n in a)e.call(this,n,a[n],r)}else t.call(this,n,i,r);return this}}function e(){}var n=a.Event,i="_emt-used";e.extend=a.Class.extend,Object.assign(e.prototype,{_events:null,parent:null,silent:!1,on:t(function(t,e,n){var i=this._events||(this._events={});(i[t]||(i[t]=[])).push({listener:e,context:n||this})}),off:t(function(t,e,n){var i=(this._events||(this._events={}))[t];if(i){n||(n=this);for(var r=i.length;r;){var a=i[--r];a.context==n&&(a.listener==e||l.call(a.listener,f)&&a.listener[f]===e)&&i.splice(r,1)}i.length||delete this._events[t]}}),once:function(t,e,n){function i(){this.off(t,i),e.apply(this,arguments)}return i[f]=e,this.on(t,i,n)},emit:function(t,e){if("string"==typeof t)t=new n(t);else if(l.call(t,i))throw new TypeError("Attempt to use an object that is no longer usable");return t[i]=!0,t.target=this,t.timestamp=Date.now(),e&&(t.detail=e),this._handleEvent(t),t},_handleEvent:function(t){if(!this.silent||t.target!=this){var e,n=t.type,i=(this._events||(this._events={}))[n];if("function"==typeof this["on"+n]?(i=i?i.slice(0):[],i.push({listener:this["on"+n]}),e=i.length):i?(i=i.slice(0),e=i.length):e=0,e){var r=0;do{if(t.isImmediatePropagationStopped)break;try{i[r].listener.call(i[r].context,t)===!1&&(t.isPropagationStopped=!0)}catch(a){this._logError(a)}}while(++r<e)}}var s=this.parent;s&&t.bubbles&&!t.isPropagationStopped&&s._handleEvent(t)},_logError:function(t){a.logError(t)}}),a.EventEmitter=e}(),function(){var n=a.value.getHash,i=a.EventEmitter,r=i.extend("Rift.ActiveDictionary",{_inner:null,_valueCount:null,_handleItemChanges:!1,constructor:function(t,e){i.call(this),this._valueCount={},"boolean"==typeof e?e={handleItemChanges:e}:e||(e={});var a=e.handleItemChanges===!0;if(a&&(this._handleItemChanges=!0),t){var s=this._inner=Object.assign(Object.create(null),t instanceof r?t._inner:t),o=this._valueCount;for(var c in s){var u=s[c],h=n(u);l.call(o,h)?o[h]++:(o[h]=1,a&&u instanceof i&&u.on("change",this._onItemChange,this))}}else this._inner={}},_onItemChange:function(t){this._handleEvent(t)},has:function(t){return t in this._inner},get:function(t){return this._inner[t]},set:function(t,r){var a;"string"==typeof t?(a={},a[t]=r):a=t;var s=this._inner,o=this._valueCount,c=this._handleItemChanges,u=!1,h=Object.create(null),f=[],d=[],p={$removedValues:f,$addedValues:d};for(t in a){var v=t in s,g=s[t];if(r=a[t],!v||!e(g,r)){if(u=!0,v){var _=n(g);--o[_]||(delete o[_],c&&g instanceof i&&g.off("change",this._onItemChange),h[_]=g)}var m=n(r);l.call(o,m)?o[m]++:(o[m]=1,c&&r instanceof i&&r.on("change",this._onItemChange,this),m in h?delete h[m]:d.push(r)),p[t]={type:v?"update":"add",oldValue:g,value:r},s[t]=r}}if(u){for(var m in h)f.push(h[m]);this.emit("change",{diff:p})}return this},"delete":function(){for(var e=this._inner,r=this._valueCount,a=this._handleItemChanges,s=!1,l=[],o={$removedValues:l,$addedValues:[]},c=0,u=arguments.length;u>c;c++){var h=arguments[c];if(h in e){s=!0;var f=e[h],d=n(f);--r[d]||(delete r[d],a&&f instanceof i&&f.off("change",this._onItemChange),l.push(f)),o[h]={type:"delete",oldValue:f,value:t},delete e[h]}}return s&&this.emit("change",{diff:o}),this},contains:function(t){return l.call(this._valueCount,n(t))},clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toObject:function(){return Object.assign({},this._inner)},collectDumpObject:function(t,e){var n=this._inner;for(var i in n)t[i]=n[i];this._handleItemChanges&&(e.handleItemChanges=!0)},expandFromDumpObject:function(t){this.set(t)},dispose:function(){if(this._handleItemChanges){var t=this._inner;for(var e in t)t[e]instanceof i&&t[e].off("change",this._onItemChange)}}});a.ActiveDictionary=r,a.$dict=function(t,e){return new r(t,e)}}(),function(){var t=a.value.getHash,i=a.EventEmitter,r=Array.prototype,s=r.push,o=r.unshift,c=r.concat,u=r.slice,h=r.splice,f=r.map,d=r.reduce,p=i.extend("Rift.ActiveArray",{_inner:null,_valueCount:null,_handleItemChanges:!1,constructor:function(e,n){i.call(this),this._valueCount={},"boolean"==typeof n?n={handleItemChanges:n}:n||(n={});var r=n.handleItemChanges===!0;if(r&&(this._handleItemChanges=!0),e){for(var a=this._inner=(e instanceof p?e._inner:e).slice(0),s=this._valueCount,o=a.length;o;)if(--o in a){var c=a[o],u=t(c);l.call(s,u)?s[u]++:(s[u]=1,r&&c instanceof i&&c.on("change",this._onItemChange,this))}}else this._inner=[]},_onItemChange:function(t){this._handleEvent(t)},get:function(t){return this._inner[t]},set:function(n,r){var a=this._inner,s=n in a,o=a[n];if(!s||!e(o,r)){var c,u,h=this._valueCount;if(s){var f=t(o);--h[f]||(delete h[f],this._handleItemChanges&&o instanceof i&&o.off("change",this._onItemChange),c=[o])}var d=t(r);l.call(h,d)?h[d]++:(h[d]=1,this._handleItemChanges&&r instanceof i&&r.on("change",this._onItemChange,this),u=[r]),a[n]=r,this.emit("change",{diff:{$removedValues:c||[],$addedValues:u||[]}})}return this},"delete":function(){for(var e=this._inner,n=this._valueCount,r=this._handleItemChanges,a=!1,s=[],l=0,o=arguments.length;o>l;l++){var c=arguments[l];if(c in e){a=!0;var u=e[c],h=t(u);--n[h]||(delete n[h],r&&u instanceof i&&u.off("change",this._onItemChange),s.push(u)),delete e[c]}}return a&&this.emit("change",{diff:{$removedValues:s,$addedValues:[]}}),this},get length(){return this._inner.length},set length(e){var n=this._inner,r=n.length;if(r!=e){var a=!1,s=[];if(r>e){var l=this._valueCount,o=this._handleItemChanges,c=e;do if(c in n){a=!0;var u=n[c],h=t(u);--l[h]||(delete l[h],o&&u instanceof i&&u.off("change",this._onItemChange),s.push(u))}while(++c<r)}n.length=e,a&&this.emit("change",{diff:{$removedValues:s,$addedValues:[]}})}},contains:function(e){return l.call(this._valueCount,t(e))},indexOf:function(t,e){return this._inner.indexOf(t,e)},lastIndexOf:function(t,e){return this._inner.lastIndexOf(t,e)},push:function(){return arguments.length?(s.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:this._addValues(arguments)}}),this._inner.length):this._inner.length},pushUnique:function(){var e=this._valueCount;return this.push.apply(this,d.call(arguments,function(n,i){return l.call(e,t(i))||-1!=n.indexOf(i)||n.push(i),n},[]))},shift:function(){var t=this._inner;if(t.length){if(n(this._valueCount))return void t.length--;var e,i="0"in t;return i?e=t.shift():t.length--,this.emit("change",{diff:{$removedValues:i?this._removeValue(e):[],$addedValues:[]}}),e}},unshift:function(){return arguments.length?(o.apply(this._inner,arguments),this.emit("change",{diff:{$removedValues:[],$addedValues:this._addValues(arguments)}}),this._inner.length):this._inner.length},pop:function(){var t=this._inner;if(t.length){if(!(t.length-1 in t))return void t.length--;var e=t.pop();return this.emit("change",{diff:{$removedValues:this._removeValue(e),$addedValues:[]}}),e}},_addValues:function(e){for(var n=this._valueCount,r=this._handleItemChanges,a=[],s=0,o=e.length;o>s;s++){var c=e[s],u=t(c);l.call(n,u)?n[u]++:(n[u]=1,r&&c instanceof i&&c.on("change",this._onItemChange,this),a.push(c))}return a},_removeValue:function(e){var n=t(e);return--this._valueCount[n]?[]:(delete this._valueCount[n],this._handleItemChanges&&e instanceof i&&e.off("change",this._onItemChange),[e])},join:function(t){return this._inner.join(t)},concat:function(){return new this.constructor(c.apply(this._inner,f.call(arguments,function(t){return t instanceof p?t._inner:t})))},slice:function(t,e){return this._inner.slice(t,e)},splice:function(n){var r=this._inner,a=h.apply(r,arguments),s=u.call(arguments,2),o=a.length,c=s.length;if(!o&&!c)return a;for(var f=this._valueCount,d=this._handleItemChanges,p=!1,v={},g=[],_=0,m=Math.max(o,c);m>_;_++){var b=_ in a,y=_ in s;if(b||y){var C=a[_],w=s[_];if(!b||!y||!e(C,w)){if(p=!0,b){var x=t(C);--f[x]||(delete f[x],d&&C instanceof i&&C.off("change",this._onItemChange),v[x]=C)}if(y){var j=t(w);l.call(f,j)?f[j]++:(f[j]=1,d&&w instanceof i&&w.on("change",this._onItemChange,this),l.call(v,j)?delete v[j]:g.push(w))}}}}if(!p&&o>c)for(var _=n+c,m=r.length;m>_;_++)if(_ in r){p=!0;break}if(p){var E=[];for(var O in v)E.push(v[O]);this.emit("change",{diff:{$removedValues:E,$addedValues:g}})}return a},forEach:null,map:null,filter:null,every:null,some:null,reduce:null,reduceRight:null,clone:function(){return new this.constructor(this,{handleItemChanges:this._handleItemChanges})},toArray:function(){return this._inner.slice(0)},toString:function(){return this._inner.toString()},collectDumpObject:function(t,e){for(var n=this._inner,i=n.length;i;)t[--i]=n[i];this._handleItemChanges&&(e.handleItemChanges=!0)},expandFromDumpObject:function(t){for(var e in t)this.set(e,t[e])},dispose:function(){if(this._handleItemChanges)for(var t=this._inner,e=t.length;e;)t[--e]instanceof i&&t[e].off("change",this._onItemChange)}});["forEach","map","filter","every","some","reduce","reduceRight"].forEach(function(t){this[t]=function(){return r[t].apply(this._inner,arguments)}},p.prototype),a.ActiveArray=p,a.$arr=function(t,e){return new p(t,e)}}(),function(){function i(t){var e=y.last,n=t._maxParentDepth;if(e)for(;;){if(n==e.maxParentDepth){var i=u(t);return l.call(e.dataCells,i)?!1:(e.dataCells[i]=t,e.count++,!0)}if(n>e.maxParentDepth){var r=e.next;return(e.next=(r||y)[r?"prev":"last"]=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:e,next:r}).dataCells[u(t)]=t,!0}if(!e.prev)return(e.prev=y.first=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:null,next:e}).dataCells[u(t)]=t,!0;e=e.prev}return(y.first=y.last=y[n]={maxParentDepth:n,dataCells:{},count:1,prev:null,next:null}).dataCells[u(t)]=t,!0}function r(t){var e=y[t._maxParentDepth];if(e){var n=u(t);if(l.call(e.dataCells,n)){if(--e.count)delete e.dataCells[n];else{var i=e.prev,r=e.next;i?i.next=r:y.first=r,r?r.prev=i:y.last=i,delete y[t._maxParentDepth]}return!0}}return!1}function s(){_=v;do for(var t in m){var e=m[t],n=e.dataCell,r=n._children;for(var a in r)i(r[a]);if(delete m[t],b--,n._fixedValue=n._value,n._changed=!0,n._handleEvent(e.event),_!=v)return}while(b)}function o(){if(_==p){if(!b)return;if(s(),_!=v)return}else if(_==v){if(b&&(s(),_!=v))return}else if(s(),_!=v)return;_=g;for(var t;t=y.first;){var e=t.dataCells;for(var n in e){var i=e[n];if(i._recalc(),_!=g)return;if(--t.count)delete e[n];else{var r=t.prev,a=t.next;r?r.next=a:y.first=a,a?a.prev=r:y.last=r,delete y[i._maxParentDepth]}if(b){if(s(),_!=v)return;_=g;break}}}_=p,C={}}function c(t,e,n,i){n||(n=new f("change"),n.target=t,n.timestamp=Date.now(),e&&(n.detail={diff:e}));var r=u(t);if(b){if(l.call(m,r)){var a=m[r];return(n.detail||(n.detail={})).prevEvent=a.event,a.event=n,void(i===!1&&(a.cancellable=!1))}}else _==p&&h(o);m[r]={dataCell:t,event:n,cancellable:i!==!1},b++}var u=a.object.getUID,h=a.process.nextTick,f=a.Event,d=a.EventEmitter,p=0,v=1,g=2,_=p,m={},b=0,y={first:null,last:null},C={},w=[],x=d.extend({initialValue:t,_value:t,_fixedValue:t,_formula:null,_get:null,_set:null,_parents:null,_children:null,_maxParentDepth:0,_lastErrorEvent:null,computable:!1,_changed:!1,get changed(){return b&&o(),this._changed},disposed:!1,_onChange:null,get onchange(){return this._onChange},set onchange(t){b&&o(),this._onChange=t},_onError:null,get onerror(){return this._onError},set onerror(t){b&&o(),this._onError=t},constructor:function(t,e){if(d.call(this),e||(e={}),e.get&&(this._get=e.get),e.set&&(this._set=e.set),e.onchange&&(this._onChange=e.onchange.bind(this)),e.onerror&&(this._onError=e.onerror.bind(this)),this._children={},this.computable="function"==typeof t&&t.constructor==Function,this.computable){this._formula=t,w.unshift({});try{this._value=this._fixedValue=this._formula()}catch(n){this._handleError(n)}var i=this._parents=w.shift(),r=1;for(var a in i){var s=i[a];s._children[u(this)]=this,r<=s._maxParentDepth&&(r=s._maxParentDepth+1)}this._maxParentDepth=r}else this.initialValue=this._value=this._fixedValue=t,t instanceof d&&t.on("change",this._onValueChange,this)},get value(){return w.length&&(w[0][u(this)]=this),(b||_==v)&&o(),this._get?this._get(this._value):this._value},set value(i){if(this.computable){if(!this._set)throw new TypeError("Cannot write to read-only dataСell");this._set(i)}else{var r=this._value;if(this._set){var a={};r instanceof d&&r.off("change",this._onValueChange,this),this._set(i,a),i=this._value,i instanceof d&&i.on("change",this._onValueChange,this),e(r,i)?n(a)||c(this,{value:a},t,i!==this._fixedValue):(a.type="update",a.oldValue=r,a.value=i,c(this,{value:a}))}else if(!e(r,i)){if(this._value=i,e(i,this._fixedValue)){var s=u(this);if(m[s].cancellable)return delete m[s],void b--}r instanceof d&&r.off("change",this._onValueChange,this),i instanceof d&&i.on("change",this._onValueChange,this),c(this,{value:{type:"update",oldValue:r,value:i}})}}},_onValueChange:function(e){c(this,t,e,this._value!==this._fixedValue)},_recalc:function(){var t=u(this);if(l.call(C,t)){if(10==++C[t])return void this._handleError(new RangeError("Circular dependency detected"))}else C[t]=1;var n,r=this._value,a=this._parents;w.unshift({});try{var s=this._formula()}catch(o){n=o}if(_!=g)return void w.shift();var h=this._parents=w.shift(),f=1;for(var d in a)l.call(h,d)||delete a[d]._children[t];for(var d in h){var p=h[d];l.call(a,d)||(p._children[t]=this),f<=p._maxParentDepth&&(f=p._maxParentDepth+1)}if(this._maxParentDepth!=f){if(this._maxParentDepth<f)return this._maxParentDepth=f,void i(this);this._maxParentDepth=f}n?this._handleError(n):e(r,s)||(this._value=s,c(this,{value:{type:"update",oldValue:r,value:s}}))},_handleError:function(t){this._logError(t);var e=this.emit("error",{error:t});this._handleErrorEvent(e)},_handleErrorEvent:function(t){if(this._lastErrorEvent!==t){this._lastErrorEvent=t,t.target!=this&&this._handleEvent(t);var e=this._children;for(var n in e){if(t.isPropagationStopped)break;e[n]._handleErrorEvent(t)}}},on:function(){b&&o(),x.$super.on.apply(this,arguments)},off:function(){b&&o(),x.$super.off.apply(this,arguments)},dispose:function(){if(!this.disposed){var t=u(this);if(t in m&&(delete m[t],b--),r(this),this.computable){var e=this._parents;for(var n in e)delete e[n]._children[t]}else this._value instanceof d&&this._value.off("change",this._onValueChange,this);var i=this._children;for(var a in i)i[a].dispose();this.disposed=!0}}});a.DataCell=x}(),function(){function t(t){var e=t._dataCells;if(e){for(var n in e)e[n].dispose();t._dataCells=null}}function e(t,e,i,a,l){var o=(this._dataCells||(this._dataCells={}))[e];if(!o){if("function"==typeof i)i=i.bind(this);else if(i===Object(i))if("function"==typeof i.clone)i=i.clone();else if(Array.isArray(i))i=i.slice(0);else{var c=new i.constructor(i);i=c!=i?c:r(i)}if(a){var u=this;a=["get","set","onchange","onerror"].reduce(function(t,e){return a[e]&&(t[e]=a[e].bind(u)),t},{})}o=this._dataCells[e]=new s(i,a)}switch(l.length){case 0:return o.value;case 1:o.value=l[0];break;default:var h=l[0];return l[0]=o,n.prototype[h].apply(t,l)}return this}function n(t,r){function a(){return e.call(this,a,s,t,r,arguments)}var s=i(a);return Object.defineProperty(a,"constructor",{configurable:!0,writable:!0,value:n}),a}var i=a.object.getUID,r=a.object.clone,s=a.DataCell;n.disposeDataCells=t,Object.assign(n.prototype,{dataCell:function(t){return t},subscribe:function(t,e,n){return t.on("change",e,n),this},unsubscribe:function(t,e,n){return t.off("change",e,n),this}}),a.ActiveProperty=n,a.$prop=function(t,e){return new n(t,e)}}(),function(){function e(t){return function e(n,i,r,a,s){if(Array.isArray(n)||n instanceof h)for(var l=n.length;l;)e.call(this,n[--l],i,r,a,s);else if("object"==typeof i){s=a,a=r;var o=i;for(i in o)e.call(this,n,i,o[i],a,s)}else if(Array.isArray(r))for(var c=r,l=0,u=c.length;u>l;l++)e.call(this,n,i,c[l],a,s);else if("object"==typeof r){var f=r;for(var d in f)e.call(this,n[d]("dataCell",0),i,f[d],a,s)}else t.call(this,n,i,r,a,s);return this}}function n(t){t.target instanceof o?t.target.off(t.type,t.listener,t.context):t.target.removeEventListener(t.type,t.listener,!1)}var i=a.object.getUID,r=a.object.getDataPropertyValues,s=a.value.getHash,o=a.EventEmitter,c=a.ActiveProperty,u=a.ActiveProperty.disposeDataCells,d=o.extend({_listening:null,_callbacks:null,_timeouts:null,_dataCells:null,listen:e(function(t,e,n,i,r){this._listen(t,e,n,i,r)}),_listen:function(e,n,r,a,c){a||(a=this);var u=this._listening||(this._listening={}),h=i(e)+"-"+n+"-"+i(l.call(r,f)?r[f]:r)+"-"+i(a)+"-"+(c!==t?s(c):"");if(!l.call(u,h)){if(e instanceof o)e.on(n,r,a);else{if("function"!=typeof e.addEventListener)throw new TypeError("Unable to add a listener");e!=a&&(r=r.bind(a)),e.addEventListener(n,r,!1)}u[h]={target:e,type:n,listener:r,context:a,meta:c}}},stopListening:e(function(t,e,n,i,r){this._stopListening(t,e,n,i,r)}),_stopListening:function(e,r,a,o,c){var u=this._listening;if(u){o||(o=this);var h=i(e)+"-"+r+"-"+i(l.call(a,f)?a[f]:a)+"-"+i(o)+"-"+(c!==t?s(c):"");l.call(u,h)&&(n(u[h]),delete u[h])}},stopAllListening:function(){var t=this._listening;if(t)for(var e in t)n(t[e]),delete t[e];return this},regCallback:function(t){function e(){l.call(e,"canceled")&&e.canceled||(delete n[r],t.apply(a,arguments))}var n=this._callbacks||(this._callbacks={}),r=i(t);l.call(n,r)&&(n[r].canceled=!0);var a=this;return n[r]=e,e},cancelCallback:function(t){var e=this._callbacks;if(e){var n=i(t);l.call(e,n)&&(e[n].canceled=!0,delete e[n])}return this},cancelAllCallbacks:function(){var t=this._callbacks;if(t)for(var e in t)t[e].canceled=!0,delete t[e];return this},setTimeout:function(t,e){var n=this._timeouts||(this._timeouts={}),r=i(t);l.call(n,r)&&clearTimeout(n[r]);var a=this;return n[r]=setTimeout(function(){delete n[r],t.call(a)},e),this},clearTimeout:function(t){var e=this._timeouts;if(e){var n=i(t);l.call(e,n)&&(clearTimeout(e[n]),delete e[n])}return this},clearAllTimeouts:function(){var t=this._timeouts;if(t)for(var e in t)clearTimeout(t[e]),delete t[e];return this},collectDumpObject:function(t){var e=this._dataCells;if(e){var n=r(this);for(var a in n){var s=n[a];if("function"==typeof s&&s.constructor==c){var o=i(s);if(l.call(e,o)){var u=e[o];if(!u.computable){var h=u.value;(h===Object(h)?u.changed:u.initialValue!==h)&&(t[a]=h)}}}}}},expandFromDumpObject:function(t){for(var e in t)this[e](t[e])},clean:function(){this.stopAllListening().cancelAllCallbacks().clearAllTimeouts(),u(this)},dispose:function(){this.clean()}});a.Cleanable=d}(),function(){var t=a.Cleanable,e=t.extend({_options:null,constructor:function(e,n){t.call(this),this._options=n||{},e&&this.setData(e)},setData:function(t){for(var e in t)e in this&&this[e](t[e])},collectDumpObject:function(t,n){e.$super.collectDumpObject.call(this,t),Object.assign(n,this._options)}});a.BaseModel=e}(),function(){function t(t){return t.replace(e,"&amp;").replace(n,"&lt;").replace(i,"&gt;").replace(r,"&quot;")}var e=/&/g,n=/</g,i=/>/g,r=/"/g;a.html={escape:t}}(),function(){function t(t,e){for(var n in e){var i=e[n];null!=i&&i!==!1&&t.push("__"+n+(i===!0?"":"_"+i))}return t}a.mods={push:t}}(),function(){function t(t,e,n){if(t)if(t instanceof r?t=t.toObject():t instanceof s&&(t=t.toArray()),Array.isArray(t))for(var i=0,a=t.length;a>i;i++)i in t&&e.call(n,t[i],i);else for(var o in t)l.call(t,o)&&e.call(n,t[o],o)}function e(t,e){if(!l.call(i,t))throw new TypeError('View "'+t+'" is not defined');e?(e.parent=this,e.block=null):e={parent:this,block:null};var r=this,a=this._childRenderings,s=a.count++,o=a.marks[s]="{{_"+n()+"}}";return new i[t](e).render(function(t){a.results[s]=t,a.count==++a.readyCount&&a.onready&&(r._childRenderings=null,a.onready())}),o}var n=a.uid.next,i=a.Class.classes,r=a.ActiveDictionary,s=a.ActiveArray,o=a.mods.push,c={el:function(t,e){var n=[this.blockName+"_"+t,this._id+"--"];return e&&o(n,e),n.join(" ")}};a.template={defaults:{include:e,helpers:c,each:t},templates:{}}}(),function(){function t(t,e,n){if(l.call(t,f))return t[f];var r=t[f]={};if(t.hasAttribute("rt-bind")){var a=!n||n.applyValues!==!1;s(h,t.getAttribute("rt-bind"),function(n,s,l,u){var h=new o(Function("return "+u+";").bind(e),{onchange:function(){c[s](t,this.value,l)}});r[i(h)]=h,a&&c[s](t,h.value,l)})}return r}function e(t){if(l.call(t,f)){var e=t[f];if(e){for(var n in e)e[n].dispose();delete t[f]}}}function n(e,n,i){i||(i={});var r=i.removeAttr===!0,a={applyValues:i.applyValues!==!1},s={};i.bindRootElement!==!1&&e.hasAttribute("rt-bind")&&(Object.assign(s,t(e,n,a)),r&&e.removeAttribute("rt-bind"));for(var l=e.querySelectorAll("[rt-bind]"),o=0,c=l.length;c>o;o++)Object.assign(s,t(l[o],n,a)),r&&e.removeAttribute("rt-bind");return s}var i=a.object.getUID,r=a.namespace.create,s=a.regex.forEach,o=a.DataCell,c={html:function(t,e){t.innerHTML=e},text:function(t,e,n){switch(n){case"first":var i=t.firstChild;i&&3==i.nodeType?i.nodeValue=e:t.insertBefore(document.createTextNode(e),i);break;case"last":var i=t.lastChild;i&&3==i.nodeType?i.nodeValue=e:t.appendChild(document.createTextNode(e));break;case"prev":var i=t.previousSibling;i&&3==i.nodeType?i.nodeValue=e:t.parentNode.insertBefore(document.createTextNode(e),t);break;case"next":var i=t.nextSibling;i&&3==i.nodeType?i.nodeValue=e:t.parentNode.insertBefore(document.createTextNode(e),i);break;default:if(1==t.childNodes.length&&3==t.firstChild.nodeType)t.firstChild.nodeValue=e;else{for(;t.lastChild;)t.removeChild(t.lastChild);t.appendChild(document.createTextNode(e))}}},prop:function(t,e,n){n=n.split(".");var i=n.pop();r(n,t)[i]=e},attr:function(t,e,n){t.setAttribute(n,e)},value:function(t,e){t.value!=e&&(t.value=e)},css:function(t,e,n){t.style[n||"cssText"]=e},show:function(t,e){t.style.display=e?"":"none"}},u="[$_a-zA-Z][$\\w]*",h=RegExp("("+u+")(?:\\(([^)]*)\\))?:\\s*(\\S[\\s\\S]*?)(?=\\s*(?:,\\s*"+u+"(?:\\([^)]*\\))?:\\s*\\S|$))","g"),f="_rt-dataCells";a.domBinding={helpers:c,bindElement:t,unbindElement:e,bind:n}}(),function(){function e(t,e){var n,i=t._childRenderings={count:0,readyCount:0,marks:[],results:[],onready:null};try{n=t.template.call(t)}catch(r){return t._logError(r),void e("")}i.onready=function(){for(var t=i.marks,r=i.results,a=t.length;a;)n=n.replace(t[--a],function(){return r[a]});e(n)},i.count==i.readyCount&&(t._childRenderings=null,i.onready())}function r(t){var e=k(t.block[0],t,{bindRootElement:!1,applyValues:!1,removeAttr:!0});t._dataCells?Object.assign(t._dataCells,e):t._dataCells=e,y(t._initClient!=i?function(){if(t._initClient.length)try{t._initClient(function(e){return null!=e?void u(t,e):void s(t)})}catch(e){u(t,e)}else{var n;try{n=t._initClient()}catch(e){return void u(t,e)}n?n.then(function(){s(t)},function(e){u(t,e)}):s(t)}}:function(){s(t)})}function s(t){if(t._bindEvents!=i)try{t._bindEvents()}catch(e){return void u(t,e)}t.emit("clientinited")}function u(t,e){t._logError(e),t.emit("clientiniterror",{error:e})}function d(t,e){for(var n in e)t.setAttribute(n,e[n])}function p(t,e){t.unregElement(e),e.parentNode&&e.parentNode.removeChild(e)}var v=a.object.getUID,g=a.namespace.exec,_=a.regex.escape,m=a.value.getHash,b=a.value.toString,y=a.process.nextTick,C=a.Class.classes,w=a.Class.getOrError,x=a.Cleanable,j=a.html.escape,E=a.mods.push,O=a.template.templates,k=a.domBinding.bind,P=/^(.+?)::(.+)$/,V=/([^,]*),([^,]*),(.*)/,D={},I="_rt-view",S="_rt-viewElementName",A=x.extend({"static":{_isTemplateInited:!1},_id:t,_options:null,name:t,tagName:"div",blockName:t,mods:null,attrs:null,onlyClient:!1,app:null,model:null,_parent:null,get parent(){return this._parent},set parent(t){t?t.regChild(this):this._parent&&this._parent.unregChild(this)},children:null,block:null,elements:null,dataReceivingError:null,template:function(){return""},_childRenderings:null,onclientinited:null,onclientiniterror:null,constructor:function(e){if(x.call(this),e||(e={}),this._options=e,this.mods=Object.create(this.mods),this.attrs=Object.create(this.attrs),this.children=[],this.elements={},!this.blockName){for(var n=this.constructor;n.$super.constructor!=A;)n=n.$super.constructor;var i=n.__class,a=i.lastIndexOf(".");n.prototype.blockName=-1==a?i:i.slice(a+1)}if(!this.constructor._isTemplateInited){var n=this.constructor;do{var i=n.__class,a=i.lastIndexOf("."),s=-1==a?i:i.slice(a+1);if(l.call(O,s)){this.constructor.prototype.template=O[s];break}n=n.$super.constructor}while(n!=A);this.constructor._isTemplateInited=!0}var o;if(c){if(e.block)throw new TypeError('Option "block" can\'t be used on the server side');o=null,null===e.block&&delete e.block}else e.block!==t&&(o=e.block,delete e.block);if(null===o)this._id=v(this,c?"s":"c"),this._parseOptions();else{var u,f=!1;if(o){if(o instanceof h&&(o=o[0]),l.call(o,I)&&o[I])throw new TypeError("Element is already used as "+(l.call(o,S)&&o[S]?"an element":"a block")+" of view");o.hasAttribute("rt-v")&&(u=o.getAttribute("rt-v").match(V),u[2]&&(f=!0),u[3]&&Object.assign(e,Function("return {"+u[3]+"};")()))}this._id=f?u[2]:v(this,"c"),this._parseOptions(),o||(o=document.createElement(this.tagName)),this.block=h(o),o[I]=this;var p=this;f?(this._collectElements(),this.block.find("[rt-p="+this._id+"]").each(function(){new(C[this.getAttribute("rt-v").match(V)[1]])({parent:p,block:this})}),r(this)):(o.className=(o.className+" "+E([this.blockName],this.mods).join(" ")).trim(),d(o,this.attrs),this.renderInner(function(t){o.innerHTML=t;for(var e=o.querySelectorAll("[rt-p]"),n={},i=e.length;i;)n[e[--i].getAttribute("rt-v").match(V)[2]]=e[i];!function a(t){t._collectElements();for(var e=t.children,i=0,s=e.length;s>i;i++){var l=e[i],o=n[l._id];l.block=h(o),o[I]=l,a(l)}r(t)}(p)}))}},_parseOptions:function(){var e=this._options;e.name&&(this.name=e.name),e.tagName&&(this.tagName=e.tagName,delete e.tagName),e.blockName&&(this.blockName=e.blockName),e.mods&&(Object.assign(this.mods,e.mods),delete e.mods),e.attrs&&(Object.assign(this.attrs,e.attrs),delete e.attrs),e.onlyClient!==t&&(this.onlyClient=e.onlyClient),e.parent&&(this.parent=e.parent,delete e.parent),e.app&&(this.app=e.app,delete e.app,this.model=this.app.model);
var n=e.model;if(n)"string"==typeof n?this.model=g(n,this._parent||this):(this.model=n,delete e.model);else{var i=this._parent;i&&i.model&&(this.model=i.model)}},render:function(t){if(this._childRenderings)throw new TypeError("Cannot run the rendering when it is in process");if(c&&this.onlyClient)return void t("<"+this.tagName+' rt-v="'+[this.constructor.__class,"",n(this._options)?"":j(b(this._options).slice(1,-1))]+'"'+(this._parent?' rt-p="'+this._parent._id+'"':"")+"></"+this.tagName+">");var e=this;this.renderInner(function(i){var r=[e.blockName],a=[];E(r,e.mods);var s=e.attrs;for(var l in s)a.push(l+'="'+s[l]+'"');t("<"+e.tagName+' class="'+r.join(" ")+'"'+(a.length?" "+a.join(" "):"")+' rt-v="'+[e.constructor.__class,e._id,n(e._options)?"":j(b(e._options).slice(1,-1))]+'"'+(e._parent?' rt-p="'+e._parent._id+'"':"")+">"+i+"</"+e.tagName+">")})},renderInner:function(t){if(this._childRenderings)throw new TypeError("Cannot run the rendering when it is in process");if(this.receiveData!=i){var n=this;try{this.receiveData.length?n.receiveData(function(i){null!=i&&(n.dataReceivingError=i,n._logError(i)),e(n,t)}):this.receiveData().then(function(){e(n,t)},function(i){n.dataReceivingError=i,n._logError(i),e(n,t)})}catch(r){this.dataReceivingError=r,this._logError(r),e(this,t)}}else e(this,t)},receiveData:i,_collectElements:function(){var t=this.blockName,e=l.call(D,t)?D[t]:D[t]=RegExp("(?:^|\\s)"+_(t)+"_([^_\\s]+)(?:\\s|$)"),n=this.elements;this.block.find("."+this._id+"--").each(function(){var t=this.className.match(e)[1];(n[t]||(n[t]=h())).push(this)})},_initClient:i,_bindEvents:i,regChild:function(t){if(t._parent){if(t._parent!=this)throw new TypeError("View is already registered as a child of other view");return this}t._parent=this;var e=this.children,n=t.name;return e.push(t),n&&(l.call(e,n)?e[n]:e[n]=[]).push(t),this},unregChild:function(t){if(t._parent!==this)return this;t._parent=null;var e=this.children,n=t.name;if(e.splice(e.indexOf(t),1),n){var i=e[n];i.splice(i.indexOf(t),1),i.length||delete e[n]}return this},regElement:function(t,e){if(l.call(e,I)&&e[I]){if(!l.call(e,S)||!e[S])throw new TypeError("Element can't be registered because it is used as a block of view");if(e[I]!=this||e[S]!=t)throw new TypeError("Element is already registered as an element of other view");return this}return e[I]=this,e[S]=t,(l.call(this.elements,t)?this.elements[t]:this.elements[t]=h()).push(e),this},unregElement:function(e){if(!l.call(e,S))return this;var n=e[S];if(!n||e[I]!=this)return this;e[I]=null,e[S]=t;var i=this.elements[n];return i.splice(i.indexOf(e),1),i.length||delete this.elements[n],this},$:function(t){var e=arguments.length;if(e>1){var n=1;do{var i=arguments[n],r=typeof i;if("string"==r||i instanceof HTMLElement){if("string"==r){var a=document.createElement("div");a.innerHTML=i,i=1==a.childNodes.length&&1==a.firstChild.nodeType?a.firstChild:a}i.className=(this.blockName+"_"+t+" "+i.className).trim()}else{var s=document.createElement(i.tagName||"div"),l=[this.blockName+"_"+t];i.mods&&E(l,i.mods),s.className=l.join(" "),i.attrs&&d(s,i.attrs),i.html&&(s.innerHTML=i.html),i=s}this.regElement(t,i)}while(++n<e)}return this.elements[t]},$rm:function(){for(var t=arguments.length;t;){var e=arguments[--t];if("string"==typeof e){if(!l.call(this.elements,e))continue;e=this.elements[e]}if(e instanceof h){var n=this;e.each(function(){p(n,this)})}else p(this,e)}return this},broadcast:function(t,e){var n,i;P.test(t)?(n=RegExp.$1,i=RegExp.$2):(n=t,i="*"),t="*"==n?this.children:this.children[n],"*"==i?t=t.slice(0):(i=w(i),t=t.filter(function(t){return t instanceof i}));var r=o.call(arguments,2);return t.map(function(t){return t[e].apply(t,r)})},_listen:function(t,e,n,i,r){var a,s;if(t instanceof A)if(P.test(e)){if(a=RegExp.$1,s=RegExp.$2,"*"!=s){s=w(s);var l=n,o=function(t){return t.target instanceof s?l.call(this,t):void 0};o[f]=l,n=o}}else{a=e;var c=this,l=n,o=function(t){return t.target==c?l.call(this,t):void 0};o[f]=l,n=o}else a=e;A.$super._listen.call(this,t,a,n,i,(s?"*"===s?"":v(s):"0")+m(r))},_stopListening:function(t,e,n,i,r){var a,s;t instanceof A&&P.test(e)?(a=RegExp.$1,s=RegExp.$2,"*"!=s&&(s=w(s))):a=e,A.$super._stopListening.call(this,t,a,n,i,(s?"*"===s?"":v(s):"0")+m(r))},dispose:function(){var t=this.block[0];t.parentNode&&t.parentNode.removeChild(t);for(var e=this.children,n=e.length;n;)e[--n].dispose();if(this._parent){var i=this._parent.children;i.splice(i.indexOf(this),1),this.name&&(i=i[this.name],i.splice(i.indexOf(this),1))}t[I]=null,A.$super.dispose.call(this)}});a.BaseView=A}(),function(){var t=a.dump.serialize,e=a.dump.deserialize,n=a.ActiveProperty,i=a.Cleanable,r=i.extend("Rift.ViewState",{fields:null,constructor:function(t){i.call(this),this.fields=Object.keys(t);for(var e in t)this[e]="function"==typeof t[e]?t[e]:new n(t[e])},serializeData:function(){for(var e=this.fields,n={},i=e.length;i;){var r=this[e[--i]]("dataCell",0);if(!r.computable){var a=r.value;(r.initialValue!==a||a===Object(a))&&(n[e[i]]=t({v:a}))}}return n},updateFromSerializedData:function(t){var n={};for(var i in t)n[i]=e(t[i]).v;return this.update(n),this},update:function(t){for(var e=this.fields,n=e.length;n;){var i=e[--n];this[i](l.call(t,i)?t[i]:this[i]("dataCell",0).initialValue)}return this}});a.ViewState=r}(),function(){function e(t){if(""!=t){if("NaN"==t)return 0/0;var e=Number(t);if(e==e)return e}return t}function n(t){t=t.split("/");for(var e=t.length;e;)t[--e]=encodeURIComponent(decodeURIComponent(t[e]));return t.join("/")}function i(t){return"/"!=t[0]&&(t="/"+t),"/"!=t[t.length-1]&&(t+="/"),t}function r(t,e){this._onViewStateChange=this._onViewStateChange.bind(this),this.app=t,this.routes=[],e&&this.addRoutes(e)}var s=a.regex.escape,o=a.process.nextTick,c=/^(?:\w+:)?\/\//,h=/[\/\\]+/g,f=/\{([^}]+)\}/g,d=/\((?:\?(\S+)\s+)?([^)]+)\)/g;Object.assign(r.prototype,{app:null,viewBlock:null,routes:null,currentRoute:null,currentPath:t,started:!1,_isViewStateChangeHandlingRequired:!1,_isHistoryPositionFrozen:!1,addRoutes:function(t){return t.forEach(function(t){"string"==typeof t&&(t={path:t}),this.addRoute(t.path,t.callback)},this),this},addRoute:function(t,e){t=t.split(d);for(var i=[],r=[],a=[],l=[],o=0,c=t.length;c>o;)if(o%3){i.push("(");var u=[];t[o]&&(u.push(t[o]),r.push({type:1,id:t[o]}));for(var h=t[o+1].split(f),p=0,v=h.length;v>p;p++)if(p%2){var g=h[p];u.push(g),i.push("([^\\/]+)"),r.push({type:2,id:g}),l.push({requiredFields:u,field:g})}else if(h[p]){var _=n(h[p]);i.push(s(_).split("\\*").join(".*?")),l.push({requiredFields:u,pathPart:_.split("*").join("")})}i.push(")?"),o+=2}else{if(t[o])for(var h=t[o].split(f),p=0,v=h.length;v>p;p++)if(p%2){var g=h[p];i.push("([^\\/]+)"),r.push({type:0,id:g}),a.push(g),l.push({requiredFields:[g],field:g})}else if(h[p]){var _=n(h[p]);i.push(s(_).split("\\*").join(".*?")),l.push({requiredFields:[],pathPart:_.split("*").join("")})}o++}return this.routes.push({rePath:RegExp("^\\/?"+i.join("")+"\\/?$"),fields:r,requiredFields:a,pathMap:l,callback:e}),this},reset:function(){this.app.viewState.update({});var e=this._tryViewState();if(e){var n=e.path;if(n===this.currentPath){if(u){var i=history.state||{};i["_rt-state"]||(i["_rt-state"]={routeIndex:this.routes.indexOf(this.currentRoute),path:n}),i["_rt-state"].viewStateData={},history.replaceState(i,null,n)}}else{var r=e.route;if(this.currentRoute=r,this.currentPath=n,u){var i=history.state||{};i["_rt-state"]={routeIndex:this.routes.indexOf(this.currentRoute),path:n,viewStateData:{}},history.replaceState(i,null,n)}r.callback&&(this._isHistoryPositionFrozen=!0,r.callback.call(this.app,n),this._isHistoryPositionFrozen=!1)}}else if(this.currentRoute=null,this.currentPath=t,u){var i=history.state||{};delete i["_rt-state"],history.replaceState(i,null,"/")}return this},start:function(){return this.started?this:(this.started=!0,u&&(this.viewBlock=this.app.view.block[0]),this.viewState=this.app.viewState,this._bindEvents(),this)},_bindEvents:function(){u&&(window.addEventListener("popstate",this._onWindowPopState.bind(this),!1),this.viewBlock.addEventListener("click",this._onViewBlockClick.bind(this),!1));for(var t=this.app.viewState,e=this._onViewStateFieldChange,n=t.fields,i=n.length;i;)t[n[--i]]("subscribe",e,this)},_onWindowPopState:function(){var e=history.state&&history.state["_rt-state"];if(!e)return this.currentRoute=null,this.currentPath=t,void this.app.viewState.update({});var n=this.routes[e.routeIndex];this.currentRoute=n,this.currentPath=e.path,this.app.viewState.updateFromSerializedData(e.viewStateData),n.callback&&(this._isHistoryPositionFrozen=!0,n.callback.call(this.app,e.path),this._isHistoryPositionFrozen=!1)},_onViewBlockClick:function(t){for(var e=this.viewBlock,n=t.target;"A"!=n.tagName;){if(n==e)return;n=n.parentNode}var i=n.getAttribute("href");!c.test(i)&&this.route(i)&&t.preventDefault()},_onViewStateFieldChange:function(){this._isViewStateChangeHandlingRequired||(this._isViewStateChangeHandlingRequired=!0,o(this._onViewStateChange))},_onViewStateChange:function(){if(this._isViewStateChangeHandlingRequired){this._isViewStateChangeHandlingRequired=!1;var t=this._tryViewState(this.currentRoute);if(t){var e=t.path;if(e===this.currentPath){if(u){var n=history.state||{};n["_rt-state"]||(n["_rt-state"]={routeIndex:this.routes.indexOf(this.currentRoute),path:e}),n["_rt-state"].viewStateData=this.app.viewState.serializeData(),history.replaceState(n,null,e)}}else{var i=t.route;this.currentRoute=i,this.currentPath=e,u&&history.pushState({"_rt-state":{routeIndex:this.routes.indexOf(i),path:e,viewStateData:this.app.viewState.serializeData()}},null,e),i.callback&&(this._isHistoryPositionFrozen=!0,i.callback.call(this.app,e),this._isHistoryPositionFrozen=!1)}}}},route:function(t){if(t=n(t.replace(h,"/")),"/"!=t[0]){var e=location.pathname;t=e+("/"==e[e.length-1]?"":"/")+t}if("/"!=t[t.length-1]&&(t+="/"),t===this.currentPath)return!0;var i=this._tryPath(t);if(!i)return!1;var r=i.route;return this.currentRoute=r,this.currentPath=t,this.app.viewState.update(i.state),u&&history[this._isHistoryPositionFrozen?"replaceState":"pushState"]({"_rt-state":{routeIndex:this.routes.indexOf(r),path:t,viewStateData:this.app.viewState.serializeData()}},null,t),r.callback&&(this._isHistoryPositionFrozen=!0,r.callback.call(this.app,t),this._isHistoryPositionFrozen=!1),!0},_tryPath:function(n){for(var i=this.routes,r=0,a=i.length;a>r;r++){var s=i[r],l=n.match(s.rePath);if(l)return{route:s,state:s.fields.reduce(function(n,i,r){return n[i.id]=1==i.type?l[r+1]!==t:e(decodeURIComponent(l[r+1])),n},{})}}return null},_tryViewState:function(t){for(var e=this.app.viewState,n=this.routes,i=null,r=0,a=n.length;a>r;r++){for(var s=n[r],l=s.requiredFields,o=l.length;o--;){var c=e[l[o]]();if(null==c||c===!1||""===c)break}if(-1==o){if(l.length){i=s;break}i&&s!==t||(i=s)}}return i&&{route:i,path:this._buildPath(i)}},_buildPath:function(t){for(var e=this.app.viewState,n=t.pathMap,r=[],a=0,s=n.length;s>a;a++){for(var o=n[a],c=o.requiredFields,u=c.length;u--;){var h=e[c[u]]();if(null==h||h===!1||""===h)break}-1==u&&r.push(l.call(o,"pathPart")?o.pathPart:e[o.field]())}return i(r.join(""))}}),a.Router=r}(),function(){function e(e,n){for(var i=Object.assign({},e),r=n.length;r;)for(var a=n[--r].fields,s=a.length;s;){var o=a[--s].id;l.call(i,o)||(i[o]=t)}return i}function n(){}var i=(a.process.nextTick,a.dump.deserialize),r=a.ViewState,s=a.Router;n.extend=a.Class.extend,Object.assign(n.prototype,{model:null,view:null,viewState:null,router:null,_init:function(t,n,a,l,o,c){this.model="function"==typeof t?new t:i(t);var u=this.router=new s(this,o);this.viewState=new r(e(l,u.routes)),c&&"/"!=c?u.route(c):u.reset(),this.view=new n({app:this,block:a}),u.start()}}),a.BaseApp=n}()}();