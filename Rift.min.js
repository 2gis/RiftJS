!function(t){"use strict";function e(t){console.error(t===Object(t)&&t.stack||t)}var i,n=Object.prototype.hasOwnProperty,r=Object.prototype.toString,s=Array.prototype.slice,a=Array.prototype.reduce,o=Function("return this;")();i="object"==typeof exports?exports:o.Rift=o.rt={},i.global=o;var l=function(t,e){return function(i){function n(t,e){function i(t){return a(i,r,e,this,t,c.call(arguments,1),arguments.length)}e||(e={});var r=t;return i.constructor=n,i}function r(t){return-1!=t.toString().indexOf("[native code]")}function s(t,e){function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t}var a,o=Object.prototype.hasOwnProperty,l=Object.prototype.toString,h=Array.prototype.push,c=Array.prototype.slice,u=Array.prototype.splice,f=Function("return this;")();"object"==typeof t?"object"==typeof e?e.exports=n:t.cellx=n:f.cellx=n;var d="__cellx_uid__",p="__cellx_inner__",v="__cellx_cells__";f.Symbol&&"symbol"==typeof Symbol.iterator&&(d=Symbol(d),p=Symbol(p),v=Symbol(v)),n.KEY_UID=d,n.KEY_INNER=p,n.KEY_CELLS=v;var _,g=0;_=f.console?console.error?function(t){console.error(t===Object(t)&&t.stack||t)}:function(t){console.log("!!! "+(t===Object(t)&&t.stack||t))}:function(){},n.logError=_;var m=Object.create||function(t){function e(){}return e.prototype=t,new e},y=Object.assign||function(t,e){for(var i in e)o.call(e,i)&&(t[i]=e[i]);return t},b=Object.is||function(t,e){return t===e||t!=t&&e!=e},w=Array.isArray||function(t){return"[object Array]"==l.call(t)};!function(){var t,e=Object.create;t=e&&r(e)?function(){return e(null)}:function(){var e=document.createElement("iframe"),i=document.body||document.documentElement;e.style.display="none",i.appendChild(e),e.src="javascript:";var n=e.contentWindow.Object.prototype;return i.removeChild(e),e=null,delete n.constructor,delete n.isPrototypeOf,delete n.hasOwnProperty,delete n.propertyIsEnumerable,delete n.valueOf,delete n.toString,delete n.toLocaleString,t=function(){},t.prototype=n,new t},n.Dictionary=t}(),function(){var t=f.Map;if(!t){var e=n.Dictionary,s={value:i};t=function(t){if(this._entries=new e,this._objectStamps={},this._first=null,this._last=null,this.size=0,t)for(var i=0,n=t.length;n>i;i++)this.set(t[i][0],t[i][1])},y(t.prototype,{has:function(t){return!!this._entries[this._getValueStamp(t)]},get:function(t){return(this._entries[this._getValueStamp(t)]||s).value},set:function(t,e){var i=this._entries,n=this._getValueStamp(t);if(i[n])i[n].value=e;else{var r=i[n]={key:t,keyStamp:n,value:e,prev:this._last,next:null};this.size++?this._last.next=r:this._first=r,this._last=r}return this},"delete":function(t){var e=this._getValueStamp(t),i=this._entries[e];if(!i)return!1;if(--this.size){var n=i.prev,r=i.next;n?n.next=r:this._first=r,r?r.prev=n:this._last=n}else this._first=null,this._last=null;return delete this._entries[e],delete this._objectStamps[e],!0},clear:function(){var t=this._entries;for(var e in t)delete t[e];this._objectStamps={},this._first=null,this._last=null,this.size=0},_getValueStamp:function(t){switch(typeof t){case"undefined":return"undefined";case"object":if(null===t)return"null";break;case"boolean":return"?"+t;case"number":return"+"+t;case"string":return","+t}return this._getObjectStamp(t)},_getObjectStamp:function(){function t(t){var e,i=this._objectStamps;for(e in i)if(i[e]==t)return e;return e=String(++g),i[e]=t,e}return Object.defineProperty&&r(Object.defineProperty)&&Object.isExtensible&&r(Object.isExtensible)?function(e){if(!o.call(e,d)){if(!Object.isExtensible(e))return t.call(this,e);Object.defineProperty(e,d,{value:String(++g)})}return e[d]}:t}(),forEach:function(t,e){null==e&&(e=f);for(var i=this._first;i;){t.call(e,i.value,i.key,this);do i=i.next;while(i&&!this._entries[i.keyStamp])}},toString:function(){return"[object Map]"}});for(var a=[["keys",function(t){return t.key}],["values",function(t){return t.value}],["entries",function(t){return[t.key,t.value]}]],l=0,h=a.length;h>l;l++)t.prototype[a[l][0]]=function(t){return function(){var e,n=this._entries,r=!1,s=this;return{next:function(){if(!r){if(e){do e=e.next;while(e&&!n[e.keyStamp])}else e=s._first;if(e)return{value:t(e),done:!1};r=!0}return{value:i,done:!0}}}}}(a[l][1])}n.Map=t}(),function(){var t;if(f.process&&"[object process]"==process.toString()&&process.nextTick)t=process.nextTick;else if(f.setImmediate)t=function(t){setImmediate(t)};else if(f.Promise&&r(Promise)){var e=Promise.resolve();t=function(t){e.then(function(){t()})}}else if(f.postMessage&&!f.ActiveXObject){var i;f.addEventListener("message",function(){if(i){var t=i;i=null;for(var e=0,r=t.length;r>e;e++)try{t[e]()}catch(s){n.logError(s)}}},!1),t=function(t){i?i.push(t):(i=[t],f.postMessage("__tic__","*"))}}else t=function(t){setTimeout(t,1)};n.nextTick=t}(),function(){function t(){this.parent=null,this._events=new e}var e=n.Dictionary;y(t.prototype,{on:function(t,e,i){if("object"==typeof t){i=e;var n=t;for(t in n)this._on(t,n[t],i)}else this._on(t,e,i);return this},off:function(t,i,n){if(t)if("object"==typeof t){n=i;var r=t;for(t in r)this._off(t,r[t],n)}else this._off(t,i,n);else this._events&&(this._events=new e);return this},_on:function(t,i,n){var r=(this._events||(this._events=new e))[t];r||(r=this._events[t]=[]),r.push({listener:i,context:n||this})},_off:function(t,e,i){var n=this._events&&this._events[t];if(n){i||(i=this);for(var r=n.length;r;)if(n[--r].context==i){var s=n[r].listener;if(s==e||s.hasOwnProperty(p)&&s[p]==e){n.splice(r,1);break}}n.length||delete this._events[t]}},once:function(t,e,i){function n(){return this._off(t,n,i),e.apply(this,arguments)}return n[p]=e,this._on(t,n,i),this},emit:function(t){return"string"==typeof t?t={target:this,type:t}:t.target===i&&(t.target=this),this._handleEvent(t),t},_handleEvent:function(t){var e=this._events&&this._events[t.type];if(e){e=e.slice();for(var i=0,n=e.length;n>i;i++)try{e[i].listener.call(e[i].context,t)===!1&&(t.isPropagationStopped=!0)}catch(r){this._logError(r)}}this.parent&&t.bubbles!==!1&&!t.isPropagationStopped&&this.parent._handleEvent(t)},_logError:function(t){n.logError(t)}}),n.EventEmitter=t}();var C;!function(){var t=n.EventEmitter;C={_onItemChange:function(t){this._handleEvent(t)},_registerValue:function(e){var i=this._valueCounts,n=i.get(e);n?i.set(e,n+1):(i.set(e,1),this.adoptsItemChanges&&e instanceof t&&e.on("change",this._onItemChange,this))},_unregisterValue:function(e){var i=this._valueCounts,n=i.get(e);n>1?i.set(e,n-1):(i["delete"](e),this.adoptsItemChanges&&e instanceof t&&e.off("change",this._onItemChange,this))},dispose:function(){if(this.adoptsItemChanges){var e=this._onItemChange;this._valueCounts.forEach(function(i){i instanceof t&&i.off("change",e,this)},this)}}}}(),function(){function t(e,i){if(this._entries=new r,this._valueCounts=new r,this.size=0,this.adoptsItemChanges=!i||i.adoptsItemChanges!==!1,e){var n=this._entries;if(e instanceof t)e._entries.forEach(function(t,e){n.set(e,t),this._registerValue(t)},this);else if(w(e))for(var s=0,a=e.length;a>s;s++){var o=e[s];n.set(o[0],o[1]),this._registerValue(o[1])}else for(var l in e)n.set(l,e[l]),this._registerValue(e[l]);this.size=n.size}}function e(e,i){return new t(e,"boolean"==typeof i?{adoptsItemChanges:i}:i)}var r=n.Map;s(t,n.EventEmitter),y(t.prototype,C),y(t.prototype,{has:function(t){return this._entries.has(t)},contains:function(t){return this._valueCounts.has(t)},get:function(t){return this._entries.get(t)},set:function(t,e){var i,n=this._entries,r=n.has(t);if(r){if(i=n.get(t),b(i,e))return this;this._unregisterValue(i)}return n.set(t,e),this._registerValue(e),r||this.size++,this.emit({type:"change",subtype:r?"update":"add",key:t,oldValue:i,value:e}),this},"delete":function(t){var e=this._entries;if(!e.has(t))return!1;var n=e.get(t);return e["delete"](t),this._unregisterValue(n),this.size--,this.emit({type:"change",subtype:"delete",key:t,oldValue:n,value:i}),!0},clear:function(){return this.size?(this._entries.clear(),this._valueCounts.clear(),this.size=0,this.emit({type:"change",subtype:"clear"}),this):this},forEach:function(t,e){null==e&&(e=f),this._entries.forEach(function(i,n){t.call(e,i,n,this)},this)},keys:function(){return this._entries.keys()},values:function(){return this._entries.values()},entries:function(){return this._entries.entries()},clone:function(){return new this.constructor(this,{adoptsItemChanges:this.adoptsItemChanges})}}),n.ActiveMap=t,n.map=e}(),function(){function t(t,e){return e>t?-1:t>e?1:0}function e(t,e){var i=t._items;if(t.sorted)for(var n=t.comparator,r=0,s=e.length;s>r;r++){for(var a=e[r],o=0,l=i.length;o!=l;){var c=o+l>>1;n(a,i[c])<0?l=c:o=c+1}i.splice(o,0,a),t._registerValue(a)}else{h.apply(i,e);for(var u=e.length;u;)t._registerValue(e[--u])}t.length=i.length}function r(i,n){n||(n={}),this._items=[],this._valueCounts=new o,this.length=0,this.adoptsItemChanges=n.adoptsItemChanges!==!1,this.comparator=null,this.sorted=!1,(n.sorted||n.comparator&&n.sorted!==!1)&&(this.comparator=n.comparator||t,this.sorted=!0),i&&e(this,i instanceof r?i._items:i)}function a(t,e){return new r(t,"boolean"==typeof e?{adoptsItemChanges:e}:e)}var o=n.Map,l=Array.prototype;s(r,n.EventEmitter),y(r.prototype,C),y(r.prototype,{_validateIndex:function(t,e){if(t===i)return t;if(0>t){if(t+=this.length,0>t)throw new RangeError("Index out of range")}else if(t>=this.length+(e?1:0))throw new RangeError("Index out of range");return t},contains:function(t){return this._valueCounts.has(t)},indexOf:function(t,e){return this._items.indexOf(t,this._validateIndex(e))},lastIndexOf:function(t,e){return this._items.lastIndexOf(t,this._validateIndex(e))},get:function(t){return this._items[this._validateIndex(t)]},getRange:function(t,e){t=this._validateIndex(t||0,!0);var n=this._items;if(e===i)return n.slice(t);if(t+e>n.length)throw new RangeError('"index" and "count" do not denote a valid range');return n.slice(t,t+e)},set:function(t,e){if(this.sorted)throw new TypeError("Can't set to sorted list");t=this._validateIndex(t);var i=this._items;return b(i[t],e)?this:(this._unregisterValue(i[t]),i[t]=e,this._registerValue(e),this.emit("change"),this)},setRange:function(t,e){if(this.sorted)throw new TypeError("Can't set to sorted list");t=this._validateIndex(t);var i=e.length;if(!i)return this;if(t+i>this.length)throw new RangeError('"index" and length of "items" do not denote a valid range');for(var n=this._items,r=!1,s=t+i;s>t;){var a=e[--s];b(n[s],a)||(this._unregisterValue(n[s]),n[s]=a,this._registerValue(a),r=!0)}return r&&this.emit("change"),this},add:function(t){return this.addRange([t]),this},addRange:function(t){return t.length?(e(this,t),this.emit("change"),this):this},insert:function(t,e){return this.insertRange(t,[e]),this},insertRange:function(t,e){if(this.sorted)throw new TypeError("Can't insert to sorted list");t=this._validateIndex(t,!0);var i=e.length;if(!i)return this;u.apply(this._items,[].concat(t,0,e));for(var n=i;n;)this._registerValue(e[--n]);return this.length+=i,this.emit("change"),this},remove:function(t,e){var i=this._items.indexOf(t,this._validateIndex(e));return-1==i?this:(this._items.splice(i,1),this._unregisterValue(t),this.length--,this.emit("change"),this)},removeAll:function(t,e){for(var i=this._items,n=this._validateIndex(e),r=!1;-1!=(n=i.indexOf(t,n));)i.splice(n,1),this._unregisterValue(t),r=!0;return r&&(this.length=i.length,this.emit("change")),this},removeAt:function(t){return this._unregisterValue(this._items.splice(this._validateIndex(t),1)[0]),this.length--,this.emit("change"),this},removeRange:function(t,e){t=this._validateIndex(t||0,!0);var n=this._items;if(e===i)e=n.length-t;else if(t+e>n.length)throw new RangeError('"index" and "count" do not denote a valid range');if(!e)return this;for(var r=t+e;r>t;)this._unregisterValue(n[--r]);return n.splice(t,e),this.length-=e,this.emit("change"),this},clear:function(){return this.length&&(this._items.length=0,this._valueCounts.clear(),this.length=0,this.emit("change")),this},join:function(t){return this._items.join(t)},forEach:null,map:null,filter:null,every:null,some:null,reduce:null,reduceRight:null,clone:function(){return new this.constructor(this,{adoptsItemChanges:this.adoptsItemChanges,comparator:this.comparator,sorted:this.sorted})},toArray:function(){return this._items.slice()},toString:function(){return this._items.join()}});for(var c=["forEach","map","filter","every","some","reduce","reduceRight"],f=c.length;f;)!function(t){r.prototype[t]=function(){return l[t].apply(this._items,arguments)}}(c[--f]);n.ActiveList=r,n.list=a}(),function(){function t(){if(!(c>u)){l=!0;do{var t=h[c];if(t){var e=t.shift();if(c){var i=c;e._recalc(),h[i].length||(h[i]=null,c&&c++)}else{var n=e._changeEvent;e._fixedValue=e._value,e._changeEvent=null,e._changed=!0,e._events.change&&e._handleEvent(n);for(var r=e._slaves,s=r.length;s;){var a=r[--s];a._fixed&&((h[1]||(h[1]=[])).push(a),u||(u=1),a._fixed=!1)}h[0].length||c++}}else c++}while(u>=c);u=-1,d++,l=!1}}function e(t,e){a.call(this),e||(e={}),this.owner=e.owner||null,this.computed="function"==typeof t&&(e.computed!==i?e.computed:t.constructor==Function),this._value=i,this._fixedValue=i,this.initialValue=i,this._formula=null,this._read=e.read||null,this._write=e.write||null,this._validate=e.validate||null,this._masters=null,this._slaves=[],this._level=0,this._active=!this.computed,this._changeEvent=null,this._isChangeCancellable=!0,this._lastErrorEvent=null,this._fixed=!0,this._version=0,this._changed=!1,this._circularityCounter=0,this.computed?this._formula=t:(this._validate&&this._validate.call(this.owner||this,t),this._value=this._fixedValue=this.initialValue=t,t instanceof a&&t.on("change",this._onValueChange,this)),e.onchange&&this.on("change",e.onchange),e.onerror&&this.on("error",e.onerror)}var r=n.nextTick,a=n.EventEmitter,o={original:null},l=!1,h=[[]],c=0,u=-1,f=null,d=1;s(e,a),y(e.prototype,{changed:function(){return l||t(),this._changed},on:function(e,i,n){return l||t(),!this.computed||this._events.change||this._slaves.length||this._activate(),a.prototype.on.call(this,e,i,n),this},off:function(e,i,n){return l||t(),a.prototype.off.call(this,e,i,n),!this.computed||this._events.change||this._slaves.length||this._deactivate(),this},_on:function(t,e,i){a.prototype._on.call(this,t,e,i||this.owner)},_off:function(t,e,i){a.prototype._off.call(this,t,e,i||this.owner)},subscribe:function(t){function e(e){return t.call(this,e.error||null,e)}return e[p]=t,this.on("change",e).on("error",e),this},unsubscribe:function(t){return this.off("change",t).off("error",t),this},_registerSlave:function(t){!this.computed||this._events.change||this._slaves.length||this._activate(),this._slaves.push(t)},_unregisterSlave:function(t){this._slaves.splice(this._slaves.indexOf(t),1),!this.computed||this._events.change||this._slaves.length||this._deactivate()},_activate:function(){if(this._version!=d){this._masters=null,this._level=0;var t=this._tryFormula();t===o?this._handleError(o.original):b(this._value,t)||(this._value=t,this._changed=!0),this._version=d}for(var e=this._masters||[],i=e.length;i;)e[--i]._registerSlave(this);this._active=!0},_deactivate:function(){for(var t=this._masters||[],e=t.length;e;)t[--e]._unregisterSlave(this);this._active=!1},_onValueChange:function(e){this._changeEvent?(e.prev=this._changeEvent,this._changeEvent=e,this._value===this._fixedValue&&(this._isChangeCancellable=!1)):(h[0].push(this),c=0,-1==u&&(u=0),e.prev=null,this._changeEvent=e,this._isChangeCancellable=!1,l||r(t))},read:function(e){if(!e&&f&&(f._masters?-1==f._masters.indexOf(this)&&(f._masters.push(this),f._level<=this._level&&(f._level=this._level+1)):(f._masters=[this],f._level=this._level+1)),l||t(),this.computed&&!this._active&&this._version!=d){this._masters=null,this._level=0;var i=this._tryFormula();if(i===o)this._handleError(o.original);else{var n=this._value;b(n,i)||(this._value=i,this._changed=!0)}this._version=d}return this._read?this._read.call(this.owner||this,this._value):this._value},write:function(e){if(this.computed&&!this._write)throw new TypeError("Cannot write to read-only cell");var i=this._value;return b(i,e)?!1:(this._validate&&this._validate.call(this.owner||this,e),this.computed?this._write.call(this.owner||this,e):(this._value=e,i instanceof a&&i.off("change",this._onValueChange,this),e instanceof a&&e.on("change",this._onValueChange,this),this._changeEvent?b(e,this._fixedValue)&&this._isChangeCancellable?(1==h[0].length?(h[0].pop(),u||(u=-1)):h[0].splice(h[0].indexOf(this),1),this._changeEvent=null):this._changeEvent={target:this,type:"change",oldValue:i,value:e,prev:this._changeEvent}:(h[0].push(this),c=0,-1==u&&(u=0),this._changeEvent={target:this,type:"change",oldValue:i,value:e,prev:null},this._isChangeCancellable=!0,l||r(t))),!0)},_recalc:function(){if(this._version==d+1){if(10==++this._circularityCounter)return this._fixed=!0,this._version=d+1,void this._handleError(new RangeError("Circular dependency detected"))}else this._circularityCounter=1;var t=this._masters;this._masters=null;var e=this._level;this._level=0;for(var i=this._tryFormula(),n=this._masters||[],r=!1,s=t.length;s;){var l=t[--s];-1==n.indexOf(l)&&(l._unregisterSlave(this),r=!0)}if(r||t.length<n.length){for(var c=n.length;c;){var f=n[--c];-1==t.indexOf(f)&&f._registerSlave(this)}var p=this._level;if(p>e)return(h[p]||(h[p]=[])).push(this),void(p>u&&(u=p))}if(this._fixed=!0,this._version=d+1,i===o)this._handleError(o.original);else{var v=this._value;if(!b(v,i)||i instanceof a){this._value=i,this._changed=!0,this._events.change&&this.emit({type:"change",oldValue:v,value:i,prev:null});for(var _=this._slaves,g=_.length;g;){var m=_[--g];if(m._fixed){var y=m._level;(h[y]||(h[y]=[])).push(m),y>u&&(u=y),m._fixed=!1}}}}},_tryFormula:function(){var t=f;f=this;try{var e=this._formula.call(this.owner||this);return this._validate&&this._validate.call(this.owner||this,e),e}catch(i){return o.original=i,o}finally{f=t}},_handleError:function(t){this._logError(t),this._handleErrorEvent({type:"error",error:t})},_handleErrorEvent:function(t){if(this._lastErrorEvent!==t){this._lastErrorEvent=t,this._handleEvent(t);for(var e=this._slaves,i=e.length;i&&!t.isPropagationStopped;)e[--i]._handleErrorEvent(t)}},dispose:function(){return l||t(),this._dispose(),this},_dispose:function(){if(this.off(),this._active)for(var t=this._slaves,e=t.length;e;)t[--e]._dispose()}}),n.Cell=e}(),function(){var t=n.Map,e=n.Cell,i=e.prototype;a=function(r,s,a,h,c,u,d){h&&h!=f||(h=r),o.call(h,v)||Object.defineProperty(h,v,{value:new t});var p=h[v].get(r);if(!p){if(null!=s&&"object"==typeof s)if("function"==typeof s.clone)s=s.clone();else if(w(s))s=s.slice();else if(s.constructor===Object)s=y({},s);else switch(l.call(s)){case"[object Date]":s=new Date(s);break;case"[object RegExp]":s=new RegExp(s)}a=m(a),a.owner=h,p=new e(s,a),h[v].set(r,p)}switch(d){case 0:return p.read();case 1:return p.write(c);default:return"bind"===c?(r=r.bind(h),r.constructor=n,r):"unwrap"===c?p:i[c].apply(p,u)}}}()}(),t.cellx}({});i.nextTick=l.nextTick,i.EventEmitter=l.EventEmitter,i.ActiveMap=l.ActiveMap,i.map=l.map,i.ActiveList=l.ActiveList,i.list=l.list,i.cellx=l,i.cell=l,i.Cell=l.Cell;var h="__rt_uid__",c="__rt_dataCells__",u="__rt_view__",f="__rt_viewElementName__";o.Symbol&&"symbol"==typeof Symbol.iterator&&(h=Symbol(h),c=Symbol(c),u=Symbol(u),f=Symbol(f)),i.KEY_UID=h,i.KEY_DATA_CELLS=c,i.KEY_VIEW=u,i.KEY_VIEW_ELEMENT_NAME=f;var d=i.isServer="undefined"==typeof window&&"undefined"==typeof navigator,p=i.isClient=!d,v=i.$=p?o.jQuery||o.Zepto||o.ender||o.$:t;i.logError=e,function(){function t(t){return 2176782335==e&&(e=0),(t||"")+(++e).toString(36)}var e=0;i.uid={next:t}}(),function(){function t(t,e){for(var i=Object.getOwnPropertyNames(e),n=i.length;n;)Object.defineProperty(t,i[--n],Object.getOwnPropertyDescriptor(e,i[n]));return t}var e,r=i.uid.next;e="symbol"==typeof h?function(t,e){return t[h]||(t[h]=r(e))}:function(t,e){return n.call(t,h)||Object.defineProperty(t,h,{value:r(e)}),t[h]};var s=Object.assign||function(t,e){for(var i=Object.keys(e),n=i.length;n;)t[i[--n]]=e[i[n]];return t};i.object={getUID:e,assign:s,mixin:t}}(),function(){function t(t){return t.replace(e,"\\$1")}var e=/([?+|$(){}[^.\-\]\/\\*])/g;i.regex={escape:t}}(),function(){function e(t){if(!(t in l))throw new TypeError('Class "'+t+'" is not defined');return l[t]}function r(t,e){if(t in l)throw new TypeError('Class "'+t+'" is already registered');return Object.defineProperty(e,"$className",{value:t}),l[t]=e,e}function s(e,i){"object"==typeof e&&(i=e,e=t);var l,h=this==a?Object:this;n.call(i,"constructor")?(l=i.constructor,delete i.constructor):l=h==Object?function(){}:function(){return h.apply(this,arguments)};var c=Object.create(h.prototype);return l.prototype=c,Object.defineProperty(c,"constructor",{configurable:!0,writable:!0,value:l}),Object.keys(h).forEach(function(t){Object.defineProperty(l,t,Object.getOwnPropertyDescriptor(h,t))}),n.call(i,"static")&&(o(l,i["static"]),delete i["static"]),l.extend||(l.extend=s),o(c,i),e&&r(e,l),l}var a,o=i.object.mixin,l=i.classes=Object.create(null);i.getClass=e,i.registerClass=r,i.EventEmitter.extend=s,a={classes:l,get:e,register:r,extend:s},i.Class=a}(),function(){function e(i,n){var s=a(i);if(n.hasOwnProperty(s))return s;var l,h=n[s]={};if(Array.isArray(i))h.t=0;else{if("[object Date]"==r.call(i))return h.t=1,h.s=i.toString(),s;if(i.constructor.hasOwnProperty("$className")&&(h.c=i.constructor.$className,i.collectDumpObject)){l={};var c={};i.collectDumpObject(l,c),Object.keys(c).length&&(h.o=c)}}l||(l=o({},i));var u=!0;for(var f in l){u=!1;var d=l[f];l[f]=d===Object(d)?e(d,n):d===t?{}:{v:d}}return u||(h.d=l),s}function n(t){var i={};return JSON.stringify({d:i,r:e(t,i)})}function s(e){"string"==typeof e&&(e=JSON.parse(e));var i,n,r=e.d;for(i in r)if(n=r[i],n.hasOwnProperty("t"))n.instance=n.t?new Date(n.s):[];else if(n.hasOwnProperty("c")){var s=l[n.c];n.instance=n.hasOwnProperty("o")?new s(t,n.o):new s}else n.instance={};for(i in r)if(n=r[i],n.hasOwnProperty("d")){var a=n.d;for(var h in a){var c=a[h];a[h]="object"==typeof c?c.hasOwnProperty("v")?c.v:t:r[c].instance}n.hasOwnProperty("c")&&n.instance.expandFromDumpObject?n.instance.expandFromDumpObject(a):o(n.instance,a)}return r[e.r].instance}var a=i.object.getUID,o=i.object.assign,l=i.classes,h=i.ActiveMap,c=i.ActiveList;h.prototype.collectDumpObject=function(t,e){var i=t.entries=[];this._entries.forEach(function(t,e){i.push([e,t])}),this.adoptsItemChanges&&(e.adoptsItemChanges=!0)},h.prototype.expandFromDumpObject=function(t){t.entries.forEach(function(t){this.set(t[0],t[1])},this)},c.prototype.collectDumpObject=function(t,e){t.items=this.toArray(),this.adoptsItemChanges&&(e.adoptsItemChanges=!0),this.sorted&&(e.sorted=!0)},c.prototype.expandFromDumpObject=function(t){this.addRange(t.items)},i.registerClass("ActiveMap",h),i.registerClass("ActiveList",c),i.dump={serialize:n,deserialize:s}}(),function(){function t(t){return Object.keys(t).forEach(function(e){var i=Object.getOwnPropertyDescriptor(t,e),n=i.value;"function"==typeof n&&n.constructor==l&&(t[e]=n.bind(t),t[e].constructor=l)}),t}i.bindCells=t}(),function(){var t=i.uid.next,e=i.EventEmitter,n=e.extend({_disposables:null,disposed:!1,constructor:function(){e.call(this),this._disposables=Object.create(null)},listenTo:function(e,i,n,r){function s(){for(var t=o.length;t;)o[--t].stop();delete d._disposables[f]}var a,o;if(Array.isArray(e)||"function"==typeof v&&e instanceof v){o=[];for(var l=e.length;l;)o.push(this.listenTo(e[--l],i,n,r))}else if("object"==typeof i){r=n,a=i,o=[];for(i in a)o.push(this.listenTo(e,i,a[i],r))}else if(Array.isArray(n)){a=n,o=[];for(var h=0,c=a.length;c>h;h++)o.push(this.listenTo(e,i,a[h],r))}else{if("object"!=typeof n)return this._listenTo(e,i,n,r);a=n,o=[];for(var u in a)o.push(this.listenTo(e[u]("unwrap",0),i,a[u],r))}var f=t(),d=this,p=this._disposables[f]={stop:s,dispose:s};return p},_listenTo:function(i,n,r,s){function a(){o in l._disposables&&(i instanceof e?i.off(n,r,s):i.removeEventListener(n,r,!1),delete l._disposables[o])}s||(s=this);var o=t(),l=this;if(i instanceof e)i.on(n,r,s);else{if("function"!=typeof i.addEventListener)throw new TypeError("Unable to add a listener");i!=s&&(r=r.bind(s)),i.addEventListener(n,r,!1)}var h=this._disposables[o]={stop:a,dispose:a};return h},registerCallback:function(e){function i(){return r in s._disposables?(delete s._disposables[r],e.apply(s,arguments)):void 0}function n(){delete s._disposables[r]}var r=t(),s=this;return i.cancel=n,i.dispose=n,this._disposables[r]=i,i},setTimeout:function(e,i){function n(){r in s._disposables&&(n(a),delete s._disposables[r])}var r=t(),s=this,a=setTimeout(function(){delete s._disposables[r],e.call(s)},i),o=this._disposables[r]={clear:n,dispose:n};return o},dispose:function(){if(!this.disposed){var t=this._disposables;for(var e in t)t[e].dispose();this.disposed=!0}}});i.Disposable=n}(),function(){var t=i.bindCells,e=i.Disposable,n=e.extend({constructor:function(i){e.call(this),this._initAssets&&(this._initAssets(i||{}),t(this))},collectDumpObject:function(t){for(var e=Object.keys(this),i=0,n=e.length;n>i;i++){var r=Object.getOwnPropertyDescriptor(this,e[i]).value;if("function"==typeof r&&r.constructor==l){var s=r("unwrap",0);if(!s.computed){var a=s.read();(a===Object(a)?s.changed():s.initialValue!==a)&&(t[e[i]]=a)}}}},expandFromDumpObject:function(t){for(var e in t)this[e](t[e])}});i.BaseModel=n}(),function(){function t(t,e,i){if(!t.hasOwnProperty(c)||!t[c]){var n=!i||i.applyValues!==!1,r=t.getAttribute("rt-bind"),o=t[c]=[];l.lastIndex=0;for(var h;h=l.exec(r);)!function(i,r,l){var h=new s(Function("var _ = this; return "+l+";").bind(e),{onchange:function(){a[i](t,this.read(),r)}});o.push(h),n&&a[i](t,h.read(),r)}(h[1],h[2],h[3]);t.removeAttribute("rt-bind"),t.setAttribute("rt-binding",r)}}function e(t){if(t.hasOwnProperty(c)){var e=t[c];if(e){for(var i=e.length;i;)e[--i].dispose();t[c]=null,t.setAttribute("rt-bind",t.getAttribute("rt-binding")),t.removeAttribute("rt-binding")}}}function n(e,i,n){n||(n={});var r=n.applyValues;n.bindRootElement!==!1&&e.hasAttribute("rt-bind")&&t(e,i,{applyValues:r});for(var s=e.querySelectorAll("[rt-bind]"),a=s.length;a;)t(s[--a],i,{applyValues:r});return e}function r(t,i){i&&i.bindRootElement===!1||!t.hasAttribute("rt-binding")||e(t);for(var n=t.querySelectorAll("[rt-binding]"),r=n.length;r;)e(n[--r]);return t}var s=i.Cell,a={prop:function(t,e,i){t[i]!==e&&(t[i]=e)},attr:function(t,e,i){null!=e&&e!==!1?(e=e===!0?i:e.toString(),t.getAttribute(i)!==e&&t.setAttribute(i,e)):t.hasAttribute(i)&&t.removeAttribute(i)},value:function(t,e){e=String(e),t.value!=e&&(t.value=e)},checked:function(t,e){e=!!e,t.checked!=e&&(t.checked=e)},disabled:function(t,e){t.disabled!=!!e&&(t.disabled=!!e)},"class":function(t,e,i){v(t).toggleClass(i,!!e)},mod:function(t,e,i){var n={};n[i]=!!e,v(t).mods(n)},show:function(t,e){e=e?"":"none",t.style.display!=e&&(t.style.display=e)},html:function(t,e){t.innerHTML=e},text:function(t,e,i){e=String(e);var n;switch(i){case"first":if(n=t.firstChild,!n||3!=n.nodeType)return void t.insertBefore(document.createTextNode(e),n);break;case"last":if(n=t.lastChild,!n||3!=n.nodeType)return void t.appendChild(document.createTextNode(e));break;case"prev":if(n=t.previousSibling,!n||3!=n.nodeType)return void t.parentNode.insertBefore(document.createTextNode(e),t);break;case"next":if(n=t.nextSibling,!n||3!=n.nodeType)return void t.parentNode.insertBefore(document.createTextNode(e),n);break;default:if(1!=t.childNodes.length||3!=t.firstChild.nodeType){for(;t.lastChild;)t.removeChild(t.lastChild);return void t.appendChild(document.createTextNode(e))}n=t.firstChild}n.nodeValue!=e&&(n.nodeValue=e)}},o=Object.keys(a).join("|"),l=RegExp("\\s*("+o+")(?:\\(([^)]*)\\))?:\\s*(\\S[\\s\\S]*?)(?=\\s*(?:,\\s*(?:"+o+")(?:\\([^)]*\\))?:\\s*\\S|$))","g");i.domBinding={directiveHandlers:a,bind:n,unbind:r}}(),function(){function e(){}function r(t){if(!(t in j))throw new TypeError('ViewClass "'+t+'" is not defined');return j[t]}function o(t,e){if(t in j)throw new TypeError('ViewClass "'+t+'" is already registered');return Object.defineProperty(e,"$viewClassName",{value:t}),j[t]=e,e}function l(t){return t.replace(/[^$0-9a-zA-Z]([$0-9a-zA-Z])/g,function(t,e){return e.toUpperCase()})}function h(t,e){for(var i in e){var n=e[i];null!=n&&n!==!1&&t.push("_"+i+(n===!0?"":"_"+n))}return t}function c(t,e){for(var i in e)t.setAttribute(i,e[i])}function p(t,e,i){for(var n=t.children,r=!1,s=n.length;s;){var a=n[--s];a.blockName==e?(a.$(i),r=!0):p(a,e,i)&&(r=!0)}return r}function _(e,i){if(i.hasOwnProperty(f)&&i[f]&&i[u]==e){i.parentNode&&i.parentNode.removeChild(i),O(i);var n=e.elements[i[f]];n.splice(n.indexOf(i),1),i[u]=null,i[f]=t}}function g(t){if(t._afterDataReceiving!=e)try{t._afterDataReceiving()}catch(i){t._logError(i)}}function m(t,i){if(t._receiveData==e)i.call(t);else{if(t._beforeDataReceiving!=e)try{t._beforeDataReceiving()}catch(n){t._logError(n)}try{t._receiveData.length?t._receiveData(function(e){t.disposed||(null!=e&&(t.dataReceivingError=e,t._logError(e)),g(t),i.call(t))}):t._receiveData()["catch"](function(e){t.disposed||(t.dataReceivingError=e,t._logError(e))}).then(function(){t.disposed||(g(t),i.call(t))})}catch(n){t.dataReceivingError=n,t._logError(n),g(t),i.call(t)}}}function y(t,e){var i=a.call(e.querySelectorAll("[rt-id]"),function(t,e){return t[e.getAttribute("rt-id")]=e,t},{});!function n(t){for(var e=t.children,r=e.length;r;){var s=e[--r],a=i[s._id];a[u]=s,s.block=v(a),n(s)}t.isDOMReady=!0,t.emit({type:"domready",bubbles:!1})}(t)}var b=i.object.assign,w=i.Class.extend,C=i.bindCells,E=i.Disposable,x=i.domBinding.bind,O=i.domBinding.unbind,S=b(Object.create(null),{area:1,base:1,basefont:1,br:1,col:1,command:1,embed:1,frame:1,hr:1,img:1,input:1,isindex:1,keygen:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,circle:1,ellipse:1,line:1,path:1,polygone:1,polyline:1,rect:1,stop:1,use:1}),j=i.viewClasses=Object.create(null);i.getViewClass=r,i.registerViewClass=o;var k=E.extend({"static":{extend:function(e,i){return o(e,w.call(this,t,i))}},tagName:"div",blockName:t,mods:null,attrs:null,_idCounter:0,_id:t,name:t,owner:null,app:null,model:null,_parent:null,get parent(){return this._parent},set parent(t){t?t.registerChild(this):this._parent&&this._parent.unregisterChild(this)},children:null,block:null,elements:null,isDOMReady:!1,_receiveData:e,_beforeDataReceiving:e,_afterDataReceiving:e,dataReceivingError:null,_currentlyRendering:!1,_childRenderings:null,_beforeRendering:e,template:function(){return""},isClientInited:!1,_initClient:e,constructor:function(t){if(E.call(this),t||(t={}),this._initAssets&&(this._initAssets(t),C(this)),t.tagName&&(this.tagName=t.tagName),t.blockName)this.blockName=t.blockName;else if(!this.blockName){for(var e=Object.getPrototypeOf(this);Object.getPrototypeOf(e).constructor!=k;)e=Object.getPrototypeOf(e);e.blockName=l(e.constructor.$viewClassName)}this.mods=Object.create(this.mods),t.mods&&b(this.mods,t.mods),this.attrs=Object.create(this.attrs),t.attrs&&b(this.attrs,t.attrs),t.name&&(this.name=t.name),t.owner&&(this.owner=t.owner),t.parent&&(this.parent=t.parent);var i=this._parent;this._id=this._nextID();var n;t.app?n=this.app=t.app:i&&i.app&&(n=this.app=i.app),t.model?this.model=t.model:i&&i.model?this.model=i.model:n&&(this.model=n.model),this.children=[];var r=d?null:t.block;if(null!==r){if(r){if(r instanceof v&&(r=r[0]),r.hasOwnProperty(u)&&r[u])throw new TypeError("Element is already used as "+(r.hasOwnProperty(f)&&r[f]?"an element":"a block")+" of view")}else r=document.createElement(this.tagName);r[u]=this,this.block=v(r)}this.elements={},r&&(r.hasAttribute("rt-id")?this.render(function(){y(this,r)}):(c(r,this.attrs),r.className=(h([this.blockName],this.mods).join(" ")+" "+r.className).trim(),this._currentlyRendering=!0,m(this,function(){this._renderInner(function(t){this._currentlyRendering=!1,r.innerHTML=t,y(this,r)})})))},_nextID:function(){return this._parent?this._parent._nextID():String(++this._idCounter)},render:function(t){if(this._currentlyRendering)throw new TypeError("Can't run rendering when it is in process");

if(this._beforeRendering!=e)try{this._beforeRendering()}catch(i){this._logError(i)}this._currentlyRendering=!0,m(this,function(){this.tagName in S?(this._currentlyRendering=!1,t.call(this,this._renderOpenTag())):this._renderInner(function(e){this._currentlyRendering=!1,t.call(this,this._renderOpenTag()+e+"</"+this.tagName+">")})})},_renderOpenTag:function(){var t=this.attrs,e=['class="'+(h([this.blockName],this.mods).join(" ")+" "+(t["class"]||"")).trim()+'"'];for(var i in t)"class"!=i&&e.push(i+'="'+t[i]+'"');return"<"+this.tagName+" "+e.join(" ")+' rt-id="'+this._id+'">'},_renderInner:function(t){var e,i=this._childRenderings={count:0,readyCount:0,childTraces:[],results:[],onallready:null};try{e=this.template.call(this.owner||this)}catch(n){return this._childRenderings=null,this._logError(n),void t.call(this,"")}var r=this;i.onallready=function(){r._childRenderings=null;for(var n=i.childTraces,s=i.results,a=n.length;a;)e=e.replace(n[--a],function(){return s[a]});t.call(r,e)},i.count==i.readyCount&&i.onallready()},initClient:function(t){function i(){if(!this.isClientInited){this.isClientInited=!0;for(var i=this.children.slice(),n=0,r=i.length;r>n;n++)i[n].initClient();try{this._initClient!=e&&this._initClient(),x(this.block[0],this.owner||this)}catch(s){this._logError(s)}}t&&t.call(this)}return this.isDOMReady?i.call(this):this.once("domready",i),this},registerChild:function(t){if(t._parent){if(t._parent==this)return this;throw new TypeError("View is already used as a child of view")}t._parent=this;var e=this.children,i=t.name;return e.push(t),i&&(n.call(e,i)?e[i]:e[i]=[]).push(t),this},unregisterChild:function(t){if(t._parent!==this)return this;t._parent=null;var e=this.children,i=t.name;if(e.splice(e.indexOf(t),1),i){var n=e[i];n.splice(n.indexOf(t),1)}return this},broadcast:function(t,e){var i,n;/^(.+?):(.+)$/.test(t)?(i=RegExp.$1,n=RegExp.$2):(i=t,n="*"),i=r(i);var a=[];!function l(t){for(var e=0,r=t.length;r>e;e++){var s=t[e];!("*"===i||s instanceof i)||"*"!=n&&s.name!==n||a.push(s),l(s.children)}}(this.children);var o=s.call(arguments,2);return a.map(function(t){return t.disposed||"function"!=typeof t[e]?void 0:t[e].apply(t,o)})},$:function(t){var e;if(n.call(this.elements,t))e=this.elements[t];else{e=this.block.find("."+this.blockName+"_"+t),p(this,this.blockName,t)&&(e=e.filter(function(){return!this.hasOwnProperty(u)||!this[u]}));var i=this;e.each(function(){this[u]=i,this[f]=t}),this.elements[t]=e}var r=arguments.length;if(r>1){var s=1;do{var a=arguments[s],o="string"==typeof a;if(o||a instanceof HTMLElement){if(o){var l=document.createElement("div");l.innerHTML=a,a=1==l.childNodes.length&&1==l.firstChild.nodeType?l.firstChild:l}else if(a.hasOwnProperty(u)&&a[u]){if(!a.hasOwnProperty(f)||!a[f])throw new TypeError("Element is already used as a block of view");if(a[u]!=this||a[f]!=t)throw new TypeError("Element is already used as an element of view");continue}a.className=(this.blockName+"_"+t+" "+a.className).trim()}else{var d=a;a=document.createElement(d.tagName||"div"),d.attrs&&c(a,d.attrs);var v=[this.blockName+"_"+t];d.mods&&h(v,d.mods),a.className=(v.join(" ")+" "+a.className).trim(),d.html&&(a.innerHTML=d.html)}a[u]=this,a[f]=t,e.push(a),x(a,this.owner||this)}while(++s<r)}return e},$rm:function(){for(var t=arguments.length;t;){var e=arguments[--t];if("string"==typeof e){if(!n.call(this.elements,e))continue;e=this.elements[e]}if(e instanceof v){var i=this;e.each(function(){_(i,this)})}else _(this,e)}return this},_listenTo:function(t,e,i,n){var s;if(t instanceof k){var a;if(/^(.+?):(.+)$/.test(e)){var o=RegExp.$1;s=RegExp.$2,"*"!=o&&(o=r(o),a=i,i=function(t){return t.target instanceof o?a.call(this,t):void 0})}else{s=e,a=i;var l=this;i=function(t){return t.target==l?a.call(this,t):void 0}}}else s=e;return E.prototype._listenTo.call(this,t,s,i,n)},dispose:function(){var t=this.block&&this.block[0];t&&(t.parentNode&&t.parentNode.removeChild(t),O(t));for(var e=this.children,i=e.length;i;)e[--i].dispose();this.parent=null,t&&(t[u]=null),E.prototype.dispose.call(this)}});i.BaseView=k}(),function(){function t(t,e){"string"==typeof t&&(t=o(t)),e?(e.parent=this,e.block=null):e={parent:this,block:null};var i=this._childRenderings,n=i.count++,s=i.childTraces[n]="{{"+r()+"}}";return new t(e).render(function(t){i.results[n]=t,i.count==++i.readyCount&&i.onallready&&i.onallready()}),s}function e(t,e,i){if(t)if(t instanceof s?t=t.toObject():t instanceof a&&(t=t.toArray()),Array.isArray(t))for(var r=0,o=t.length;o>r;r++)r in t&&e.call(i,t[r],r);else for(var l in t)n.call(t,l)&&e.call(i,t[l],l)}var r=i.uid.next,s=i.ActiveMap,a=i.ActiveList,o=i.getViewClass;i.template={defaults:{include:t,helpers:{},each:e}}}(),function(){var t=i.template.defaults.include,e=i.getViewClass,n=i.BaseView;n.extend("ViewList",{tagName:"ul",model:null,itemViewClass:null,getItemParams:null,constructor:function(t){n.call(this,t),this.itemViewClass=e(t.itemViewClass),t.getItemParams&&(this.getItemParams=t.getItemParams)},template:function(){var e=this.model();if(!e)return"";var i=this.itemViewClass,n=this.getItemParams;return e.map(function(r,s){var a=n?n(r,s,e):{};return a.name="item",a.model=r,a.$index=s,'<li class="ViewList_item">'+t.call(this,i,a)+"</li>"},this).join("")},_initClient:function(){this.listenTo(this,"change",{model:this._onModelChange})},_onModelChange:function(){var t=this.model()||[],e=this.itemViewClass,i=this.getItemParams,n=this.children.item||(this.children.item=[]),r=this.block[0],s=n.map(function(t){return t.model}),a=Array.isArray(t)?t.slice():t.toArray();a.forEach(function(a,o){if(a!==s[o]){var l=s.indexOf(a,o+1);if(-1==l){var h=i?i(a,o,t):{};h.name="item",h.model=a,h.parent=this,h.$index=o,new e(h);var c=n.pop(),u=document.createElement("li");u.className="ViewList_item",u.appendChild(c.block[0]),o<n.length?r.insertBefore(u,n[o].block[0].parentNode):r.appendChild(u),n.splice(o,0,c),s.splice(o,0,c.model),c.initClient()}else r.insertBefore(n[l].block[0].parentNode,n[o].block[0].parentNode),n.splice(o,0,n.splice(l,1)[0]),s.splice(o,0,s.splice(l,1)[0])}},this),n.slice(a.length).forEach(function(t){var e=t.block[0].parentNode;e.parentNode.removeChild(e),t.dispose()})}})}(),function(){var e=i.template.defaults.include,n=i.getViewClass,r=i.BaseView;r.extend("ViewSwitch",{_states:null,_stateSource:null,initialState:t,_currentState:t,constructor:function(e){r.call(this,e),this._states=e.states,e.stateSource&&(this._stateSource=e.stateSource);var i;e.initialState&&(i=this.initialState=e.initialState);var n=i||(this._stateSource?this._stateSource():t);n&&this._states[n]||!this._states["default"]||(n="default"),n&&this._states[n]&&(this._currentState=n)},get currentState(){return this._currentState},set currentState(e){if(e&&this._states[e]||!this._states["default"]||(e="default"),this._currentState!==e)if(this._currentState&&this.children[0].dispose(),e&&this._states[e]){var i=this._states[e],r=Object.create(i.viewParams||null);r.parent=this;var s=new(n(i.viewClass))(r);s.block.appendTo(this.block),s.initClient(),this._currentState=e}else this._currentState=t},template:function(){var t=this._currentState;if(t&&this._states[t]){var i=this._states[t];return e.call(this,i.viewClass,i.viewParams||null)}return""},_initClient:function(){this._stateSource&&this.listenTo(this,"change",{_stateSource:this._onStateSourceChange})},_onStateSourceChange:function(){this.currentState=this._stateSource()}})}(),function(){var t=i.dump.serialize,e=i.dump.deserialize,r=i.Disposable,s=r.extend("Rift.ViewState",{propertyList:null,constructor:function(t){r.call(this),this.propertyList=Object.keys(t),this.propertyList.forEach(function(e){this[e]=("function"==typeof t[e]?t[e]:l(t[e])).bind(this),this[e].constructor=l},this)},serializeData:function(){for(var e=this.propertyList,i={},n=e.length;n;){var r=this[e[--n]]("unwrap",0);if(!r.computable){var s=r.read();(s===Object(s)?r.changed():r.initialValue!==s)&&(i[e[n]]=s)}}return t(i)},updateFromSerializedData:function(t){return this.update(e(t)),this},update:function(t){for(var e,i=this.propertyList,r=i.length;r;){e=i[--r];var s=this[e]("unwrap",0);s.computable||s.write(s.initialValue)}for(var a=i.length;a;)e=i[--a],n.call(t,e)&&this[e](t[e]);return this}});i.ViewState=s}(),function(){function e(t){if(""!=t){if("NaN"==t)return 0/0;var e=Number(t);if(e==e)return e}return t}function n(t){t=t.split("/");for(var e=t.length;e;)t[--e]=encodeURIComponent(decodeURIComponent(t[e]));return t.join("/")}function r(t){return"/"!=t[0]&&(t="/"+t),"/"!=t[t.length-1]&&(t+="/"),t}function s(e,i){for(var n=i.pathMap,s=[],a=0,o=n.length;o>a;a++){for(var l=n[a],h=l.requiredProperties,c=h.length;c--;){var u=e[h[c]]();if(null==u||u===!1||""===u)break}-1==c&&s.push(l.pathPart!==t?l.pathPart:e[l.property]())}return r(s.join(""))}function a(t,i){for(var n=t.routes,r=0,s=n.length;s>r;r++){var a=n[r],o=i.match(a.rePath);if(o)return{route:a,state:a.properties.reduce(function(t,i,n){return t[i.name]=1==i.type?!!o[n+1]:o[n+1]&&e(decodeURIComponent(o[n+1])),t},{})}}return null}function o(t,e){for(var i=t.app.viewState,n=t.routes,r=null,a=0,o=n.length;o>a;a++){for(var l=n[a],h=l.requiredProperties,c=h.length;c--;){var u=i[h[c]]();if(null==u||u===!1||""===u)break}if(-1==c)if(r)if(r.requiredProperties.length){if(h.length&&l===e){r=l;break}}else if(h.length){if(r=l,l===e)break}else l===e&&(r=l);else r=l}return r&&{route:r,path:s(i,r)}}function h(t,e,i,n,r){if(t.currentRoute=e,t.currentRouteName(e.name),t.currentPath=i,p){t._isViewStateChangeHandlingRequired=!1;var s;r?(s={},s[g]={routeIndex:t.routes.indexOf(e),path:i,viewStateData:n},history[1==r?"replaceState":"pushState"](s,null,i)):(s=history.state||{},s[g]={routeIndex:t.routes.indexOf(e),path:i,viewStateData:n},history.replaceState(s,null,i))}e.callback&&e.callback.call(t.app,i)}function c(t,e){var i=o(t,e);if(i){var n=i.path;if(n!==t.currentPath)return h(t,i.route,n,t.app.viewState.serializeData(),2),!0}return!1}var u=i.nextTick,f=i.regex.escape,v=i.dump.serialize,_=i.Disposable,g=i.KEY_ROUTING_STATE="__rt_routingState__",m=_.extend({app:null,viewBlock:null,routes:null,routeDict:null,started:!1,currentRoute:null,currentRouteName:l(""),currentPath:t,_isViewStateChangeHandlingRequired:!1,constructor:function(t,e){_.call(this),this.app=t,this.routes=[],this.routeDict=Object.create(null),this.currentRouteName=this.currentRouteName.bind(this),this.currentRouteName.constructor=l,e&&this.addRoutes(e)},addRoutes:function(t){return t.forEach(function(t){"string"==typeof t&&(t={path:t}),this.addRoute(t.path,t.name,t.callback)},this),this},addRoute:function(e,i,r){if(this.started)throw new TypeError("Can't add route to started router");e=e.split(/\((?:\?([^\s)]+)\s+)?([^)]+)\)/g);for(var s,a,o,l=/\{([^}]+)\}/g,h=[],c=[],u=[],d=[],p=0,v=e.length;v>p;)if(p%3){h.push("(");var _=[];e[p]&&(_.push(e[p]),c.push({type:1,name:e[p]})),s=e[p+1].split(l);for(var g=0,m=s.length;m>g;g++)g%2?(o=s[g],_.push(o),h.push("([^\\/]+)"),c.push({type:2,name:o}),d.push({requiredProperties:_,pathPart:t,property:o})):s[g]&&(a=n(s[g]),h.push(f(a).split("\\*").join(".*?")),d.push({requiredProperties:_,pathPart:a.split("*").join(""),property:t}));h.push(")?"),p+=2}else{if(e[p]){s=e[p].split(l);for(var y=0,b=s.length;b>y;y++)y%2?(o=s[y],h.push("([^\\/]+)"),c.push({type:0,name:o}),u.push(o),d.push({requiredProperties:[o],pathPart:t,property:o})):s[y]&&(a=n(s[y]),h.push(f(a).split("\\*").join(".*?")),d.push({requiredProperties:[],pathPart:a.split("*").join(""),property:t}))}p++}var w={name:i,rePath:RegExp("^\\/?"+h.join("")+"\\/?$"),properties:c,requiredProperties:u,pathMap:d,callback:r};if(this.routes.push(w),i){if(i in this.routeDict)throw new TypeError('Route "'+i+'" is already exist');this.routeDict[i]=w}return this},start:function(){if(this.started)return this;if(this.started=!0,p&&(this.viewBlock=this.app.view.block[0]),this._bindEvents(),d){var t=o(this,"/"==this.currentPath?null:this.currentRoute);t&&h(this,t.route,t.path,this.app.viewState.serializeData())}return this},_bindEvents:function(){if(p){this.listenTo(window,"popstate",this._onWindowPopState),this.listenTo(this.viewBlock,"click",this._onViewBlockClick);for(var t=this.app.viewState,e=this._onViewStatePropertyChange,i=t.propertyList,n=i.length;n;)this.listenTo(t[i[--n]]("unwrap",0),"change",e)}},_onWindowPopState:function(){var e=history.state&&history.state[g];if(e){var i=this.routes[e.routeIndex],n=e.path;this.currentRoute=i,this.currentRouteName(i.name),this.currentPath=n,this.app.viewState.updateFromSerializedData(e.viewStateData),i.callback&&i.callback.call(this.app,n)}else{this.app.viewState.update({});var r=o(this);r?h(this,r.route,r.path,v({}),0):(this.currentRoute=null,this.currentRouteName(""),this.currentPath=t)}},_onViewBlockClick:function(t){for(var e=this.viewBlock,i=t.target;"A"!=i.tagName;){if(i==e)return;if(i=i.parentNode,!i)return}var n=i.getAttribute("href");-1==n.indexOf("#")&&!/^(?:\w+:)?\/\//.test(n)&&this.route(n)&&t.preventDefault()},_onViewStatePropertyChange:function(){this._isViewStateChangeHandlingRequired||(this._isViewStateChangeHandlingRequired=!0,u(this.registerCallback(this._onViewStateChange)))},_onViewStateChange:function(){if(this._isViewStateChangeHandlingRequired){this._isViewStateChangeHandlingRequired=!1;var t=history.state||{};t[g]||(t[g]={routeIndex:this.routes.indexOf(this.currentRoute),path:this.currentPath}),t[g].viewStateData=this.app.viewState.serializeData(),history.replaceState(t,null,this.currentPath)}},route:function(t,e){if(t=n(t.replace(/[\/\\]+/g,"/")),"/"!=t[0]){var i=location.pathname;t=i+("/"==i[i.length-1]?"":"/")+t}if("/"!=t[t.length-1]&&(t+="/"),t===this.currentPath)return!0;var r=a(this,t);return r?(this.app.viewState.update(r.state),h(this,r.route,t,this.app.viewState.serializeData(),e!==!1?2:1),!0):!1},update:function(t){return c(this,t?this.routeDict[t]:this.currentRoute)}});i.Router=m}(),function(){function e(e,i){for(var s=r({},e),a=i.length;a;)for(var o=i[--a].properties,l=o.length;l;){var h=o[--l].name;n.call(s,h)||(s[h]=t)}return s}var r=i.object.assign,s=i.dump.deserialize,a=i.ViewState,o=i.Router,l=i.Class.extend({model:null,view:null,viewState:null,router:null,_init:function(t){this.model=d?new t.modelClass:s(t.modelDataDump);var i=this.router=new o(this,t.routes),n=this.viewState=new a(e(t.viewStateFields,i.routes));i.route(t.path,!1);var r;if(p){var l=s(t.viewStateDataDump);for(var h in l)n[h](l[h]);r=new t.viewClass({app:this,block:t.viewBlock})}else r=new t.viewClass({app:this,block:null});this.view=r,i.start(),p&&r.initClient()},dispose:function(){this.router.dispose(),this.view.dispose(),this.viewState.dispose(),this.model.dispose()}});i.BaseApp=l}()}();